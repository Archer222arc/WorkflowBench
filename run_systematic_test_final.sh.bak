#!/bin/bash

# ============================================
# PILOT-Bench ç³»ç»ŸåŒ–æµ‹è¯•è„šæœ¬ - å®Œæ•´é›†æˆç‰ˆ
# æ”¯æŒä¸‰å±‚ç»­æµ‹æœºåˆ¶ï¼šå®è§‚ï¼ˆæ­¥éª¤ï¼‰ã€ä¸­è§‚ï¼ˆé…ç½®ï¼‰ã€å¾®è§‚ï¼ˆä»»åŠ¡ï¼‰
# æ”¯æŒè‡ªåŠ¨å¤±è´¥æ£€æµ‹ã€è®°å½•å’Œé‡æµ‹
# å¢å¼ºï¼šé›†æˆè‡ªåŠ¨å¤±è´¥ç»´æŠ¤ç³»ç»Ÿ
# ============================================

# ç¡®ä¿STORAGE_FORMATç¯å¢ƒå˜é‡åœ¨æ•´ä¸ªè„šæœ¬ä¸­å¯ç”¨
# å¦‚æœæœªè®¾ç½®ï¼Œç¨åä¼šåœ¨setup_storage_formatä¸­è®¾ç½®
if [ -n "$STORAGE_FORMAT" ]; then
    export STORAGE_FORMAT
fi

# åŠ è½½è‡ªåŠ¨å¤±è´¥ç»´æŠ¤å‡½æ•°åº“
if [ -f "auto_failure_maintenance_lib.sh" ]; then
    source auto_failure_maintenance_lib.sh
    MAINTENANCE_LIB_LOADED=true
    echo -e "${GREEN}âœ… å·²åŠ è½½è‡ªåŠ¨å¤±è´¥ç»´æŠ¤å‡½æ•°åº“${NC}"
else
    MAINTENANCE_LIB_LOADED=false
    echo -e "${YELLOW}âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è‡ªåŠ¨å¤±è´¥ç»´æŠ¤å‡½æ•°åº“ï¼Œå°†ä½¿ç”¨åŸºæœ¬åŠŸèƒ½${NC}"
fi

# è§£æå‘½ä»¤è¡Œå‚æ•°
IGNORE_PROGRESS=false
FORCE_FRESH=false
AUTO_MODE=""
SKIP_MENU=false
INCREMENTAL_MODE=false
ULTRA_PARALLEL_MODE=false
CUSTOM_INSTANCES=""  # è‡ªå®šä¹‰å®ä¾‹æ•°

while [[ $# -gt 0 ]]; do
    case $1 in
        --ignore-progress)
            IGNORE_PROGRESS=true
            SKIP_MENU=true
            shift
            ;;
        --fresh|--force-fresh)
            FORCE_FRESH=true
            SKIP_MENU=true
            shift
            ;;
        --incremental)
            INCREMENTAL_MODE=true
            IGNORE_PROGRESS=true
            SKIP_MENU=true
            shift
            ;;
        --auto)
            AUTO_MODE="auto"
            SKIP_MENU=true
            shift
            ;;
        --debug)
            AUTO_MODE="debug"
            SKIP_MENU=true
            shift
            ;;
        --full-auto)
            AUTO_MODE="full_auto"
            SKIP_MENU=true
            shift
            ;;
        --ultra-parallel)
            ULTRA_PARALLEL_MODE=true
            SKIP_MENU=true
            shift
            ;;
        --auto-maintain)
            AUTO_MAINTENANCE_MODE=true
            SKIP_MENU=true
            shift
            ;;
        --with-maintenance)
            WITH_MAINTENANCE=true
            shift
            ;;
        --maintenance-only)
            MAINTENANCE_ONLY=true
            SKIP_MENU=true
            shift
            ;;
        --instances)
            # è‡ªå®šä¹‰å®ä¾‹æ•°ï¼Œæ ¼å¼: --instances 10 æˆ– --instances 5x4 (5ä¸ªå®ä¾‹ï¼Œæ¯ä¸ª4ç§ä»»åŠ¡ç±»å‹)
            CUSTOM_INSTANCES="$2"
            shift 2
            ;;
        --help|-h)
            echo "ç”¨æ³•: $0 [é€‰é¡¹]"
            echo ""
            echo "é€‰é¡¹:"
            echo "  --ignore-progress    å¿½ç•¥è¿›åº¦æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹æµ‹è¯•ï¼ˆä¸æ¸…ç†æ•°æ®ï¼‰"
            echo "  --fresh              å®Œå…¨é‡æ–°å¼€å§‹ï¼ˆæ¸…ç†æ‰€æœ‰æ•°æ®ï¼‰"
            echo "  --incremental        å¢é‡æµ‹è¯•æ¨¡å¼ï¼ˆå¿½ç•¥è¿›åº¦ï¼Œåªæµ‹è¯•æœªå®Œæˆçš„ï¼‰"
            echo "  --auto               è‡ªåŠ¨æ¨¡å¼ï¼ˆé˜¶æ®µé—´éœ€ç¡®è®¤ï¼‰"
            echo "  --debug              è°ƒè¯•æ¨¡å¼ï¼ˆæ¯ä¸ªæ¨¡å‹åæš‚åœï¼‰"
            echo "  --full-auto          å…¨è‡ªåŠ¨æ¨¡å¼ï¼ˆè¿ç»­è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼‰"
            echo "  --ultra-parallel     å¯ç”¨è¶…é«˜å¹¶è¡Œæ¨¡å¼ï¼ˆå¤šAzureå®ä¾‹å¹¶è¡Œï¼‰"
            echo "  --auto-maintain      è‡ªåŠ¨å¤±è´¥ç»´æŠ¤æ¨¡å¼"
            echo "  --with-maintenance   å¯ç”¨è‡ªåŠ¨ç»´æŠ¤åŠŸèƒ½"
            echo "  --maintenance-only   ä»…æ‰§è¡Œç»´æŠ¤ï¼Œä¸è¿è¡Œæµ‹è¯•"
            echo "  --instances N        è‡ªå®šä¹‰å®ä¾‹æ•° (é»˜è®¤20)"
            echo "                       æ ¼å¼: --instances 10 (æ€»å…±10ä¸ªå®ä¾‹)"
            echo "                             --instances 5x4 (5ä¸ªå®ä¾‹ï¼Œæ¯ä¸ª4ç§ä»»åŠ¡ç±»å‹)"
            echo "  --help, -h           æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
            echo ""
            echo "ç¤ºä¾‹:"
            echo "  $0                           # äº¤äº’å¼èœå•"
            echo "  $0 --incremental             # å¢é‡æµ‹è¯•æœªå®Œæˆçš„é…ç½®"
            echo "  $0 --ignore-progress --auto   # å¿½ç•¥è¿›åº¦è‡ªåŠ¨è¿è¡Œ"
            echo "  $0 --auto-maintain           # è‡ªåŠ¨å¤±è´¥ç»´æŠ¤"
            echo "  $0 --instances 10 --auto     # ä½¿ç”¨10ä¸ªå®ä¾‹è‡ªåŠ¨è¿è¡Œ"
            echo "  $0 --instances 5x4 --auto    # 5ä¸ªå®ä¾‹Ã—4ç§ä»»åŠ¡ç±»å‹"
            echo "  $0 --with-maintenance --auto  # å¸¦ç»´æŠ¤çš„è‡ªåŠ¨æµ‹è¯•"
            echo "  $0 --maintenance-only         # ä»…æ‰§è¡Œç»´æŠ¤"
            exit 0
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1"
            echo "ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©"
            exit 1
            ;;
    esac
done

echo "=========================================="
echo "PILOT-Bench ç³»ç»ŸåŒ–æµ‹è¯•"
echo "å®Œæ•´é›†æˆç‰ˆ with ä¸‰å±‚ç»­æµ‹ä¿æŠ¤ + è‡ªåŠ¨ç»´æŠ¤"
if [ "$AUTO_MAINTENANCE_MODE" = true ]; then
    echo "æ¨¡å¼: è‡ªåŠ¨å¤±è´¥ç»´æŠ¤"
elif [ "$MAINTENANCE_ONLY" = true ]; then
    echo "æ¨¡å¼: ä»…æ‰§è¡Œç»´æŠ¤"
elif [ "$INCREMENTAL_MODE" = true ]; then
    echo "æ¨¡å¼: å¢é‡æµ‹è¯•"
elif [ "$IGNORE_PROGRESS" = true ]; then
    echo "æ¨¡å¼: å¿½ç•¥è¿›åº¦æ–‡ä»¶"
elif [ "$FORCE_FRESH" = true ]; then
    echo "æ¨¡å¼: å®Œå…¨é‡æ–°å¼€å§‹"
fi
if [ "$WITH_MAINTENANCE" = true ]; then
    echo "ç‰¹æ€§: å¯ç”¨è‡ªåŠ¨ç»´æŠ¤"
fi
echo "=========================================="
echo ""

# é¢œè‰²å®šä¹‰ï¼ˆæå‰å®šä¹‰ä»¥ä¾¿èœå•ä½¿ç”¨ï¼‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color


# è§£æè‡ªå®šä¹‰å®ä¾‹æ•°
DEFAULT_INSTANCES=20
NUM_INSTANCES=$DEFAULT_INSTANCES
INSTANCES_PER_TASK=""  # æ¯ç§ä»»åŠ¡ç±»å‹çš„å®ä¾‹æ•°

if [ -n "$CUSTOM_INSTANCES" ]; then
    # æ£€æŸ¥æ˜¯å¦æ˜¯NxMæ ¼å¼
    if [[ "$CUSTOM_INSTANCES" =~ ^([0-9]+)x([0-9]+)$ ]]; then
        # NxMæ ¼å¼: Nä¸ªå®ä¾‹ï¼ŒMç§ä»»åŠ¡ç±»å‹
        NUM_INSTANCES="${BASH_REMATCH[1]}"
        INSTANCES_PER_TASK="${BASH_REMATCH[2]}"
        echo -e "${GREEN}âœ… ä½¿ç”¨è‡ªå®šä¹‰å®ä¾‹æ•°: ${NUM_INSTANCES} ä¸ªå®ä¾‹ Ã— ${INSTANCES_PER_TASK} ç§ä»»åŠ¡ç±»å‹${NC}"
    elif [[ "$CUSTOM_INSTANCES" =~ ^[0-9]+$ ]]; then
        # ç®€å•æ•°å­—æ ¼å¼
        NUM_INSTANCES="$CUSTOM_INSTANCES"
        echo -e "${GREEN}âœ… ä½¿ç”¨è‡ªå®šä¹‰å®ä¾‹æ•°: ${NUM_INSTANCES}${NC}"
    else
        echo -e "${RED}âŒ æ— æ•ˆçš„å®ä¾‹æ•°æ ¼å¼: $CUSTOM_INSTANCES${NC}"
        echo -e "${YELLOW}ä½¿ç”¨é»˜è®¤å€¼: ${DEFAULT_INSTANCES}${NC}"
    fi
else
    echo -e "${CYAN}ğŸ”§ ä½¿ç”¨é»˜è®¤å®ä¾‹æ•°: ${NUM_INSTANCES}${NC}"
fi

# å®šä¹‰å¼€æºæ¨¡å‹åˆ—è¡¨ï¼ˆåŒ…å«æ–°å¢çš„æ¨¡å‹ï¼‰
OPENSOURCE_MODELS=(
    "DeepSeek-V3-0324"       # âœ… æ–°å¢ï¼šæœ€æ–°V3ç‰ˆæœ¬ï¼ˆæ‚¨çš„Azureï¼‰
    "DeepSeek-R1-0528"       # âœ… æ–°å¢ï¼šæœ€æ–°æ¨ç†æ¨¡å‹ï¼ˆæ‚¨çš„Azureï¼‰
    "qwen2.5-72b-instruct"   # idealab
    "qwen2.5-32b-instruct"   # idealab
    "qwen2.5-14b-instruct"   # idealab
    "qwen2.5-7b-instruct"    # idealab
    "qwen2.5-3b-instruct"    # idealab
    "Llama-3.3-70B-Instruct" # âœ… æ–°å¢ï¼šæœ€æ–°Llamaï¼ˆæ‚¨çš„Azureï¼‰
    # "llama-4-scout-17b"      # idealab - æš‚æ—¶ç¦ç”¨ï¼ŒAPIä¸æ”¯æŒ
)

# å®šä¹‰é—­æºæ¨¡å‹åˆ—è¡¨ï¼ˆä¼˜åŒ–åçš„æ ¸å¿ƒæ¨¡å‹ï¼‰
CLOSED_SOURCE_MODELS=(
    "gpt-4o-mini"                # Azure - å·¥ä½œæ­£å¸¸
    "gpt-5-mini"                 # Azure - å·¥ä½œæ­£å¸¸ï¼ˆç§»é™¤å‚æ•°åå·²ä¿®å¤ï¼‰
    "o3-0416-global"             # IdealLab - å·¥ä½œæ­£å¸¸
    "gemini-2.5-flash-06-17"     # IdealLab - å·¥ä½œæ­£å¸¸ï¼ˆæ³¨æ„å¯èƒ½è¿”å›ç©ºcontentï¼‰
    "kimi-k2"                    # IdealLab - å·¥ä½œæ­£å¸¸ï¼ˆå·²éªŒè¯ï¼‰
    "claude_sonnet4"             # IdealLab - å·¥ä½œæ­£å¸¸ï¼ˆæ–°å¢ï¼‰
    # ä»¥ä¸‹æ¨¡å‹æš‚æ—¶æ³¨é‡Šï¼š
    # "grok-3-mini"              # Azure - å¯ç”¨ä½†æš‚ä¸æµ‹è¯•
    # "Llama-3.3-70B-Instruct"   # ç§»è‡³å¼€æºæ¨¡å‹åˆ—è¡¨ï¼ˆä¸DeepSeekä¸€èµ·ï¼‰
)

# Qwenå…¨ç³»åˆ—ï¼ˆç”¨äº5.2è§„æ¨¡æ•ˆåº”æµ‹è¯•ï¼‰
QWEN_FULL_SERIES=(
    "qwen2.5-72b-instruct"
    "qwen2.5-32b-instruct"
    "qwen2.5-14b-instruct"
    "qwen2.5-7b-instruct"
    "qwen2.5-3b-instruct"
)

# æ¨¡å‹ç±»å‹å’Œè¿›åº¦æ–‡ä»¶å®šä¹‰
MODEL_TYPE=""  # å°†åœ¨ç”¨æˆ·é€‰æ‹©åè®¾ç½®: "opensource" æˆ– "closed_source"
CURRENT_MODELS=()  # å½“å‰é€‰æ‹©çš„æ¨¡å‹åˆ—è¡¨
RESULT_SUFFIX=""  # ç»“æœæ–‡ä»¶åç¼€

# è¿›åº¦æ–‡ä»¶ï¼ˆæ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€è®¾ç½®ï¼‰
PROGRESS_FILE=""  # å°†åœ¨é€‰æ‹©æ¨¡å‹ç±»å‹åè®¾ç½®
COMPLETED_FILE=""  # å°†åœ¨é€‰æ‹©æ¨¡å‹ç±»å‹åè®¾ç½®

# å¯¼å…¥å¤±è´¥æµ‹è¯•ç®¡ç†å™¨
if [ -f "failed_tests_manager.sh" ]; then
    source failed_tests_manager.sh
fi

# ============================================
# ç»´æŠ¤æ¨¡å¼å¤„ç†
# ============================================

# å¦‚æœæ˜¯ä»…ç»´æŠ¤æ¨¡å¼
 if [ "$MAINTENANCE_ONLY" = true ]; then
    echo -e "${CYAN}ğŸ”§ ä»…æ‰§è¡Œç»´æŠ¤æ¨¡å¼${NC}"
    if command -v smart_maintenance_entry >/dev/null 2>&1; then
        smart_maintenance_entry "wizard" "" "true"
    else
        echo -e "${YELLOW}âš ï¸ æœªåŠ è½½ç»´æŠ¤å‡½æ•°åº“ï¼Œä½¿ç”¨åŸºæœ¬ç»´æŠ¤${NC}"
        python3 auto_failure_maintenance_system.py status
    fi
    exit 0
fi

# å¦‚æœæ˜¯è‡ªåŠ¨ç»´æŠ¤æ¨¡å¼
if [ "$AUTO_MAINTENANCE_MODE" = true ]; then
    echo -e "${CYAN}ğŸ”§ è‡ªåŠ¨ç»´æŠ¤æ¨¡å¼${NC}"
    if command -v smart_maintenance_entry >/dev/null 2>&1; then
        smart_maintenance_entry "auto" "" "false"
    else
        echo -e "${YELLOW}âš ï¸ æœªåŠ è½½ç»´æŠ¤å‡½æ•°åº“ï¼Œä½¿ç”¨Pythonç‰ˆæœ¬${NC}"
        python3 smart_batch_runner.py --auto-maintain
    fi
    exit 0
fi

# ============================================
# è‡ªåŠ¨é‡è¯•åŠŸèƒ½
# ============================================

# å¸¦è‡ªåŠ¨é‡è¯•çš„æµ‹è¯•æ‰§è¡Œå‡½æ•°
execute_test_with_auto_retry() {
    local cmd="$1"
    local description="$2"
    local model="$3"
    local test_id="$4"
    local max_retries="${5:-2}"  # é»˜è®¤2æ¬¡é‡è¯•
    
    local attempt=1
    local success=false
    
    while [ $attempt -le $((max_retries + 1)) ] && [ "$success" = "false" ]; do
        if [ $attempt -gt 1 ]; then
            echo -e "${YELLOW}ğŸ”„ ç¬¬ $attempt æ¬¡å°è¯•: $description${NC}"
            if command -v record_test_failure >/dev/null 2>&1; then
                record_test_failure "$model" "$test_id" "retry_attempt_$attempt" "Previous attempt failed"
            fi
        else
            echo -e "${BLUE}ğŸ æ­£åœ¨æ‰§è¡Œ: $description${NC}"
        fi
        
        # ä½¿ç”¨ç»´æŠ¤å‡½æ•°åº“æ‰§è¡Œæµ‹è¯•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if command -v execute_test_with_failure_tracking >/dev/null 2>&1; then
            if execute_test_with_failure_tracking "$cmd" "$description" "$model" "$test_id"; then
                success=true
                echo -e "${GREEN}âœ… æµ‹è¯•æˆåŠŸ (ç¬¬ $attempt æ¬¡å°è¯•)${NC}"
                if [ $attempt -gt 1 ] && command -v record_test_success >/dev/null 2>&1; then
                    record_test_success "$model" "$test_id" "true"
                fi
            fi
        else
            # ä½¿ç”¨åŸºæœ¬æ‰§è¡Œ
        # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨evalæ‰§è¡Œæ—¶ç”Ÿæ•ˆ
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        export MODEL_TYPE="${MODEL_TYPE}"
        export NUM_INSTANCES="${NUM_INSTANCES}"
        export RATE_MODE="${RATE_MODE}"            if eval "$cmd"; then
                success=true
                echo -e "${GREEN}âœ… æµ‹è¯•æˆåŠŸ (ç¬¬ $attempt æ¬¡å°è¯•)${NC}"
            fi
        fi
        
        if [ "$success" = "false" ]; then
            if [ $attempt -le $max_retries ]; then
                local wait_time=$((attempt * 30))  # é€’å¢ç­‰å¾…æ—¶é—´
                echo -e "${RED}âŒ æµ‹è¯•å¤±è´¥ï¼Œ${wait_time}ç§’åé‡è¯•...${NC}"
                sleep $wait_time
            else
                echo -e "${RED}âŒ æµ‹è¯•å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°${NC}"
                if command -v record_test_failure >/dev/null 2>&1; then
                    record_test_failure "$model" "$test_id" "max_retries_exceeded" "Failed after $max_retries retries"
                fi
            fi
        fi
        
        ((attempt++))
    done
    
    [ "$success" = "true" ]
}

# ============================================
# å…¨å±€ç»´æŠ¤é…ç½®
# ============================================

# åŠ è½½ç»´æŠ¤é…ç½®
if command -v load_maintenance_config >/dev/null 2>&1; then
    load_maintenance_config
fi

# æ£€æŸ¥æ˜¯å¦å¯ç”¨ç»´æŠ¤åŠŸèƒ½
if [ "$WITH_MAINTENANCE" = "true" ]; then
    echo -e "${GREEN}âœ… å¯ç”¨è‡ªåŠ¨ç»´æŠ¤åŠŸèƒ½${NC}"
    AUTO_RETRY_ENABLED=true
    
    # åˆå§‹åŒ–è¿›åº¦ç®¡ç†
    if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v update_progress >/dev/null 2>&1; then
        echo -e "${BLUE}ğŸ”§ åˆå§‹åŒ–è¿›åº¦ç®¡ç†ç³»ç»Ÿ${NC}"
        update_progress "initialization" 0 "system_startup" "" ""
    fi
else
    AUTO_RETRY_ENABLED=false
fi

# ============================================
# å¯åŠ¨é€‰é¡¹èœå•
# ============================================
show_initial_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}$( [ "$MODEL_TYPE" = "closed_source" ] && echo "é—­æº" || echo "å¼€æº" )æ¨¡å‹æµ‹è¯•èœå•${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„è¿›åº¦
    if [ -f "$PROGRESS_FILE" ]; then
        # è¯»å–è¿›åº¦
        source "$PROGRESS_FILE"
        local completed_count=$(wc -l < "$COMPLETED_FILE" 2>/dev/null || echo 0)
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§è¿›åº¦ï¼ˆMODEL_INDEX > 0 æˆ– STEP > 1 æˆ– æœ‰å®Œæˆè®°å½•ï¼‰
        if [ "$MODEL_INDEX" -gt 0 ] || [ "$STEP" -gt 1 ] || [ "$completed_count" -gt 0 ]; then
            echo -e "${GREEN}æ£€æµ‹åˆ°ä¹‹å‰çš„æµ‹è¯•è¿›åº¦ï¼š${NC}"
            echo "  å½“å‰æ­¥éª¤: 5.$STEP"
            echo "  å·²å®Œæˆé…ç½®: $completed_count"
        echo ""
            echo ""
            echo "  1) ğŸ”„ ç»§ç»­ä¸Šæ¬¡æµ‹è¯•"
            echo "  2) ğŸ†• å®Œå…¨é‡æ–°å¼€å§‹ï¼ˆæ¸…ç†æ‰€æœ‰æ•°æ®ï¼‰"
            echo "  3) ğŸ“Š æŸ¥çœ‹è¯¦ç»†è¿›åº¦"
            echo "  4) ğŸ¯ è‡ªå®šä¹‰èµ·å§‹é˜¶æ®µ"
            echo "  5) ğŸ”§ è‡ªåŠ¨ç»´æŠ¤èœå•"
            # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•è®°å½•
            if check_failed_tests_config 2>/dev/null; then
                echo "  6) ğŸ”„ é‡æ–°æµ‹è¯•å¤±è´¥çš„ç»„"
                echo "  7) âŒ é€€å‡º"
            else
                echo "  6) âŒ é€€å‡º"
            fi
        else
            # æ²¡æœ‰å®è´¨æ€§è¿›åº¦ï¼Œå°±å½“ä½œæ–°æµ‹è¯•
            echo -e "${YELLOW}æ²¡æœ‰æ£€æµ‹åˆ°ä¹‹å‰çš„è¿›åº¦${NC}"
            echo ""
            echo "  1) ğŸ†• å¼€å§‹æ–°æµ‹è¯•"
            echo "  2) âŒ é€€å‡º"
        fi
    else
        echo -e "${YELLOW}æ²¡æœ‰æ£€æµ‹åˆ°ä¹‹å‰çš„è¿›åº¦${NC}"
        echo ""
        echo "  1) ğŸ†• å¼€å§‹æ–°æµ‹è¯•"
        echo "  2) ğŸ”§ è‡ªåŠ¨ç»´æŠ¤èœå•"
        echo "  3) âŒ é€€å‡º"
    fi
    
    echo ""
    echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹:${NC}"
}

show_test_mode_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}é€‰æ‹©æµ‹è¯•æ¨¡å¼${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    echo "  1) âš¡ è‡ªåŠ¨æ¨¡å¼ï¼ˆé˜¶æ®µå†…è¿ç»­è¿è¡Œï¼‰"
    echo "  2) ğŸ” è°ƒè¯•æ¨¡å¼ï¼ˆæ¯ä¸ªæ¨¡å‹åæš‚åœï¼‰"
    echo "  3) ğŸš€ å…¨è‡ªåŠ¨æ¨¡å¼ï¼ˆè·¨é˜¶æ®µè¿ç»­è¿è¡Œï¼‰"
    echo "  4) â¬…ï¸ è¿”å›ä¸Šä¸€çº§"
    echo ""
    echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [1-4]:${NC}"
}

show_rate_limit_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}é€‰æ‹©å¹¶å‘ç­–ç•¥${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    echo "  1) ğŸ”§ å›ºå®šé€Ÿç‡æ¨¡å¼ (Fixed) - ä½¿ç”¨é¢„è®¾çš„å¹¶å‘æ•° â­ æ¨è"
    echo "     â–ª Azure API: 100å¹¶å‘, 200 QPS"
    echo "     â–ª IdealLab API: 3å¹¶å‘, 5 QPS"
    echo "     â–ª å…¶ä»–API: 20å¹¶å‘, 30 QPS"
    echo "     â–ª ä¼˜ç‚¹ï¼šç¨³å®šå¯é¢„æµ‹"
    echo "     â–ª ç¼ºç‚¹ï¼šå¯èƒ½æœªå……åˆ†åˆ©ç”¨APIèƒ½åŠ›"
    echo ""
    echo "  2) ğŸ¯ è‡ªé€‚åº”æ¨¡å¼ (Adaptive) - æ™ºèƒ½è°ƒæ•´å¹¶å‘æ•°ï¼Œé¿å…é™æµ"
    echo "     â–ª ä¼˜ç‚¹ï¼šè‡ªåŠ¨æ ¹æ®APIå“åº”è°ƒæ•´ï¼Œæœ€å¤§åŒ–ååé‡"
    echo "     â–ª ç¼ºç‚¹ï¼šé‡åˆ°é™æµæ—¶ä¼šé™é€Ÿ"
    echo ""
    echo "  3) ğŸ”¥ è¶…é«˜å¹¶è¡Œæ¨¡å¼ (Ultra Parallel) - å¤šå®ä¾‹/å¤šKeyå¹¶è¡Œ"
    echo "     â–ª Azureæ¨¡å‹ (DeepSeek/Llama): æœ€å¤š6ä¸ªå®ä¾‹åŒæ—¶è¿è¡Œ"
    echo "     â–ª IdealLabæ¨¡å‹ (Qwen): 3ä¸ªAPI KeyåŒæ—¶è¿è¡Œ"
    echo "     â–ª ç†è®ºåŠ é€Ÿæ¯”: 3-6å€"
    echo "     â–ª èµ„æºåˆ©ç”¨ç‡: æœ€å¤§åŒ–APIé…é¢ä½¿ç”¨"
    echo ""
    echo "  4) âš™ï¸  è‡ªå®šä¹‰é€Ÿç‡ - æ‰‹åŠ¨è®¾ç½®å¹¶å‘å‚æ•°"
    echo ""
    echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [1-4]:${NC}"
}

show_checkpoint_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}é…ç½®Checkpointä¿å­˜ç­–ç•¥${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    echo "  ğŸ’¾ Checkpointæœºåˆ¶è¯´æ˜ï¼š"
    echo "     å®šæœŸä¿å­˜æµ‹è¯•ç»“æœåˆ°æ•°æ®åº“ï¼Œé˜²æ­¢ä¸­æ–­ä¸¢å¤±æ•°æ®"
    echo ""
    echo "  1) âš¡ å¿«é€Ÿæ¨¡å¼ - æ¯10ä¸ªæµ‹è¯•ä¿å­˜ä¸€æ¬¡"
    echo "     â–ª æ›´é¢‘ç¹çš„ä¿å­˜ï¼Œæ•°æ®æ›´å®‰å…¨"
    echo "     â–ª é€‚åˆä¸ç¨³å®šçš„ç¯å¢ƒæˆ–é‡è¦æµ‹è¯•"
    echo ""
    echo "  2) ğŸ¯ æ ‡å‡†æ¨¡å¼ - æ¯20ä¸ªæµ‹è¯•ä¿å­˜ä¸€æ¬¡ï¼ˆæ¨èï¼‰"
    echo "     â–ª å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§"
    echo "     â–ª é€‚åˆå¤§å¤šæ•°åœºæ™¯"
    echo ""
    echo "  3) ğŸš€ æ€§èƒ½æ¨¡å¼ - æ¯50ä¸ªæµ‹è¯•ä¿å­˜ä¸€æ¬¡"
    echo "     â–ª å‡å°‘IOæ“ä½œï¼Œæé«˜æµ‹è¯•é€Ÿåº¦"
    echo "     â–ª é€‚åˆç¨³å®šç¯å¢ƒçš„å¤§æ‰¹é‡æµ‹è¯•"
    echo ""
    echo "  4) ğŸ”’ å®‰å…¨æ¨¡å¼ - æ¯5ä¸ªæµ‹è¯•ä¿å­˜ä¸€æ¬¡"
    echo "     â–ª æœ€é¢‘ç¹çš„ä¿å­˜ï¼Œæ•°æ®æœ€å®‰å…¨"
    echo "     â–ª é€‚åˆæä¸ç¨³å®šçš„ç¯å¢ƒ"
    echo ""
    echo "  5) âš™ï¸  è‡ªå®šä¹‰é—´éš” - æ‰‹åŠ¨è®¾ç½®ä¿å­˜é¢‘ç‡"
    echo ""
    echo "  6) âŒ ç¦ç”¨Checkpoint - ä»…åœ¨æœ€åä¿å­˜"
    echo "     â–ª æœ€å¿«é€Ÿåº¦ï¼Œä½†ä¸­æ–­ä¼šä¸¢å¤±æ‰€æœ‰æ•°æ®"
    echo ""
    echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [1-6]:${NC}"
}

# æ¸…ç†å‡½æ•°
clean_all_progress() {
    # è·å–å½“å‰æ¨¡å‹ç±»å‹çš„ç›¸å…³æ–‡ä»¶å
    local progress_file=$(get_progress_file)
    local completed_file=$(get_completed_file)
    local db_suffix=""
    local db_file="master_database.json"
    local model_type_desc="å¼€æº"
    
    if [ "$MODEL_TYPE" = "closed_source" ]; then
        db_suffix="_closed_source"
        db_file="master_database_closed_source.json"
        model_type_desc="é—­æº"
    fi
    
    echo -e "${YELLOW}========================================${NC}"
    echo -e "${YELLOW}å‡†å¤‡æ¸…ç†${model_type_desc}æ¨¡å‹çš„æµ‹è¯•è¿›åº¦å’Œæ•°æ®${NC}"
    echo -e "${YELLOW}========================================${NC}"
    echo ""
    echo "å°†æ¸…ç†ä»¥ä¸‹å†…å®¹ï¼š"
    echo "  1. è¿›åº¦æ–‡ä»¶ ($progress_file)"
    echo "  2. å®Œæˆè®°å½• ($completed_file)"
    echo "  3. ç´¯ç§¯æµ‹è¯•æ•°æ®åº“ (pilot_bench_cumulative_results/$db_file)"
    echo ""
    echo -e "${RED}âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤${model_type_desc}æ¨¡å‹çš„æ‰€æœ‰æµ‹è¯•è®°å½•ï¼${NC}"
    echo -e "${YELLOW}æ˜¯å¦ç¡®è®¤æ¸…ç†å¹¶ä»å¤´å¼€å§‹ï¼Ÿ(yes/no)${NC}"
    read -r confirmation
    
    if [ "$confirmation" != "yes" ]; then
        echo -e "${BLUE}å–æ¶ˆæ¸…ç†ï¼Œè¿”å›ä¸»èœå•${NC}"
        return 1
    fi
    
    echo ""
    echo "å¼€å§‹æ¸…ç†..."
    
    # 1. æ¸…ç†è¿›åº¦æ–‡ä»¶
    if [ -f "$progress_file" ]; then
        rm -f "$progress_file"
        echo -e "${GREEN}âœ“ å·²åˆ é™¤è¿›åº¦æ–‡ä»¶: $progress_file${NC}"
    else
        echo "  è¿›åº¦æ–‡ä»¶ä¸å­˜åœ¨: $progress_file"
    fi
    
    # 2. æ¸…ç†å®Œæˆè®°å½•
    if [ -f "$completed_file" ]; then
        rm -f "$completed_file"
        echo -e "${GREEN}âœ“ å·²åˆ é™¤å®Œæˆè®°å½•: $completed_file${NC}"
    else
        echo "  å®Œæˆè®°å½•ä¸å­˜åœ¨: $completed_file"
    fi
    
    # 3. å¤‡ä»½å¹¶æ¸…ç†ç‰¹å®šçš„æ•°æ®åº“æ–‡ä»¶
    if [ -f "pilot_bench_cumulative_results/$db_file" ]; then
        # åªå¤‡ä»½ç‰¹å®šçš„æ•°æ®åº“æ–‡ä»¶
        BACKUP_FILE="pilot_bench_cumulative_results/${db_file}.backup_$(date +%Y%m%d_%H%M%S)"
        cp "pilot_bench_cumulative_results/$db_file" "$BACKUP_FILE"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}âœ… å·²å¤‡ä»½æ•°æ®åº“æ–‡ä»¶åˆ°: $BACKUP_FILE${NC}"
        else
            echo -e "${RED}âš ï¸  å¤‡ä»½å¤±è´¥${NC}"
            return 1
        fi
        
        # ä½¿ç”¨Pythonæ¸…ç†ç‰¹å®šçš„æ•°æ®åº“æ–‡ä»¶
        DB_PATH="pilot_bench_cumulative_results/$db_file"
        python -c "
from enhanced_cumulative_manager import EnhancedCumulativeManager
manager = EnhancedCumulativeManager(db_suffix='$db_suffix')
manager.clear_database()
print('  æ•°æ®åº“å·²æ¸…ç†')
" 2>/dev/null || {
            # å¦‚æœPythonæ–¹æ³•å¤±è´¥ï¼Œç›´æ¥åˆ›å»ºç©ºæ•°æ®åº“
            echo '{
  "version": "3.0",
  "created_at": "'$(date -Iseconds)'",
  "last_updated": "'$(date -Iseconds)'",
  "test_groups": {},
  "models": {},
  "summary": {
    "total_tests": 0,
    "total_success": 0,
    "total_partial": 0,
    "total_failure": 0,
    "models_tested": [],
    "last_test_time": null
  }
}' > "$DB_PATH"
        }
        echo -e "${GREEN}âœ“ å·²æ¸…ç†${model_type_desc}æ¨¡å‹æµ‹è¯•æ•°æ®åº“${NC}"
    else
        echo "  ${model_type_desc}æ¨¡å‹æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨"
        # åˆ›å»ºç›®å½•å¦‚æœä¸å­˜åœ¨
        mkdir -p "pilot_bench_cumulative_results"
        # åˆ›å»ºç©ºæ•°æ®åº“
        echo '{
  "version": "3.0",
  "created_at": "'$(date -Iseconds)'",
  "last_updated": "'$(date -Iseconds)'",
  "test_groups": {},
  "models": {},
  "summary": {
    "total_tests": 0,
    "total_success": 0,
    "total_partial": 0,
    "total_failure": 0,
    "models_tested": [],
    "last_test_time": null
  }
}' > "pilot_bench_cumulative_results/$db_file"
        echo -e "${GREEN}âœ“ å·²åˆ›å»ºæ–°çš„${model_type_desc}æ¨¡å‹æ•°æ®åº“${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}âœ… ${model_type_desc}æ¨¡å‹æ¸…ç†å®Œæˆï¼å‡†å¤‡ä»å¤´å¼€å§‹æµ‹è¯•${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    sleep 2
    return 0
}


# è‡ªå®šä¹‰é˜¶æ®µé€‰æ‹©èœå•
show_custom_stage_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}é€‰æ‹©è¦å¼€å§‹çš„é˜¶æ®µ${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    if [ "$MODEL_TYPE" = "closed_source" ]; then
        echo "  1) 5.1 åŸºå‡†æµ‹è¯• (5ä¸ªé—­æºæ¨¡å‹, optimal+easy)"
        echo "  2) âŒ 5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯• (ä¸é€‚ç”¨äºé—­æºæ¨¡å‹)"
        echo "  3) 5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯• (5ä¸ªé—­æºæ¨¡å‹, 7ç§ç¼ºé™·ç±»å‹)"
        echo "  4) 5.4 å·¥å…·å¯é æ€§æµ‹è¯• (5ä¸ªé—­æºæ¨¡å‹, 5ç§å¯é æ€§çº§åˆ«)"
        echo "  5) 5.5 æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯• (5ä¸ªé—­æºæ¨¡å‹, 2ç§æç¤ºç±»å‹)"
    else
        echo "  1) 5.1 åŸºå‡†æµ‹è¯• (8ä¸ªå¼€æºæ¨¡å‹, optimal+easy)"
        echo "  2) 5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯• (5ä¸ªQwenæ¨¡å‹, very_easy+medium)"
        echo "  3) 5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯• (8ä¸ªæ¨¡å‹, 7ç§ç¼ºé™·ç±»å‹)"
        echo "  4) 5.4 å·¥å…·å¯é æ€§æµ‹è¯• (8ä¸ªæ¨¡å‹, 5ç§å¯é æ€§çº§åˆ«)"
        echo "  5) 5.5 æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯• (8ä¸ªæ¨¡å‹, 2ç§æç¤ºç±»å‹)"
    fi
    echo "  6) ğŸ”§ é«˜çº§è‡ªå®šä¹‰ (ç›´æ¥è®¾ç½®STEP/MODEL_INDEX/SUBSTEP)"
    echo "  7) â¬…ï¸ è¿”å›ä¸Šä¸€çº§"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹© [1-7]:${NC}"
    
    read -r stage_choice
    
    case $stage_choice in
        1)
            echo -e "${GREEN}é€‰æ‹©ï¼šä»5.1åŸºå‡†æµ‹è¯•å¼€å§‹${NC}"
            # æ¸…ç†æ—§è¿›åº¦
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            # è®¾ç½®ä¸ºé˜¶æ®µ1
            echo "STEP=1" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
            echo "SUBSTEP=" >> "$PROGRESS_FILE"
            echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.1å¼€å§‹${NC}"
            START_FRESH=false
            break
            ;;
        2)
            if [ "$MODEL_TYPE" = "closed_source" ]; then
                echo -e "${RED}âŒ 5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•ä¸é€‚ç”¨äºé—­æºæ¨¡å‹${NC}"
                echo -e "${YELLOW}Qwenç³»åˆ—ä»…ä¸ºå¼€æºæ¨¡å‹ï¼Œè¯·é€‰æ‹©å…¶ä»–é˜¶æ®µ${NC}"
                sleep 2
                continue
            fi
            
            echo -e "${GREEN}é€‰æ‹©ï¼šä»5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•å¼€å§‹${NC}"
            echo ""
            echo -e "${YELLOW}é€‰æ‹©å­æ­¥éª¤:${NC}"
            echo "  1) very_easy éš¾åº¦"
            echo "  2) medium éš¾åº¦"
            echo "  3) ğŸ”„ å…¨éƒ¨ï¼ˆå…ˆvery_easyåmediumï¼‰"
            echo -e "${YELLOW}è¯·é€‰æ‹© [1-3]:${NC}"
            read -r substep_choice
            
            case $substep_choice in
                1) CUSTOM_SUBSTEP="very_easy" ;;
                2) CUSTOM_SUBSTEP="medium" ;;
                3) CUSTOM_SUBSTEP="" ;;  # ç©ºè¡¨ç¤ºä»å¤´å¼€å§‹ï¼Œä¼šä¾æ¬¡åšä¸¤ä¸ªéš¾åº¦
                *) CUSTOM_SUBSTEP="" ;;
            esac
            
            # æ¸…ç†æ—§è¿›åº¦
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            # è®¾ç½®ä¸ºé˜¶æ®µ2
            echo "STEP=2" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
            echo "SUBSTEP=$CUSTOM_SUBSTEP" >> "$PROGRESS_FILE"
            if [ -z "$CUSTOM_SUBSTEP" ]; then
                echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.2å¼€å§‹ (å°†æµ‹è¯•å…¨éƒ¨éš¾åº¦)${NC}"
            else
                echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.2å¼€å§‹ (å­æ­¥éª¤: $CUSTOM_SUBSTEP)${NC}"
            fi
            START_FRESH=false
            break
            ;;
        3)
            echo -e "${GREEN}é€‰æ‹©ï¼šä»5.3ç¼ºé™·å·¥ä½œæµæµ‹è¯•å¼€å§‹${NC}"
            echo ""
            echo -e "${YELLOW}é€‰æ‹©ç¼ºé™·ç±»å‹:${NC}"
            echo "  1) flawed_sequence_disorder (é¡ºåºé”™è¯¯)"
            echo "  2) flawed_tool_misuse (å·¥å…·è¯¯ç”¨)"
            echo "  3) flawed_parameter_error (å‚æ•°é”™è¯¯)"
            echo "  4) flawed_missing_step (ç¼ºå°‘æ­¥éª¤)"
            echo "  5) flawed_redundant_operations (å†—ä½™æ“ä½œ)"
            echo "  6) flawed_logical_inconsistency (é€»è¾‘ä¸ä¸€è‡´)"
            echo "  7) flawed_semantic_drift (è¯­ä¹‰åç§»)"
            echo "  8) ä»å¤´å¼€å§‹æ‰€æœ‰ç¼ºé™·ç±»å‹"
            echo -e "${YELLOW}è¯·é€‰æ‹© [1-8]:${NC}"
            read -r flaw_choice
            
            case $flaw_choice in
                1) CUSTOM_SUBSTEP="flawed_sequence_disorder" ;;
                2) CUSTOM_SUBSTEP="flawed_tool_misuse" ;;
                3) CUSTOM_SUBSTEP="flawed_parameter_error" ;;
                4) CUSTOM_SUBSTEP="flawed_missing_step" ;;
                5) CUSTOM_SUBSTEP="flawed_redundant_operations" ;;
                6) CUSTOM_SUBSTEP="flawed_logical_inconsistency" ;;
                7) CUSTOM_SUBSTEP="flawed_semantic_drift" ;;
                8) CUSTOM_SUBSTEP="" ;;
                *) CUSTOM_SUBSTEP="" ;;
            esac
            
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            echo "STEP=3" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
            echo "SUBSTEP=$CUSTOM_SUBSTEP" >> "$PROGRESS_FILE"
            echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.3å¼€å§‹ (ç¼ºé™·ç±»å‹: ${CUSTOM_SUBSTEP:-å…¨éƒ¨})${NC}"
            START_FRESH=false
            break
            ;;
        4)
            echo -e "${GREEN}é€‰æ‹©ï¼šä»5.4å·¥å…·å¯é æ€§æµ‹è¯•å¼€å§‹${NC}"
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            echo "STEP=4" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
            echo "SUBSTEP=" >> "$PROGRESS_FILE"
            echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.4å¼€å§‹${NC}"
            START_FRESH=false
            break
            ;;
        5)
            echo -e "${GREEN}é€‰æ‹©ï¼šä»5.5æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•å¼€å§‹${NC}"
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            echo "STEP=5" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
            echo "SUBSTEP=" >> "$PROGRESS_FILE"
            echo -e "${GREEN}âœ… å·²è®¾ç½®ä»5.5å¼€å§‹${NC}"
            START_FRESH=false
            break
            ;;
        6)
            echo -e "${CYAN}é€‰æ‹©ï¼šé«˜çº§è‡ªå®šä¹‰${NC}"
            echo ""
            echo -e "${YELLOW}è¾“å…¥STEP (1-5):${NC}"
            read -r custom_step
            echo -e "${YELLOW}è¾“å…¥MODEL_INDEX (ä»0å¼€å§‹):${NC}"
            read -r custom_model_idx
            echo -e "${YELLOW}è¾“å…¥SUBSTEP (å¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡):${NC}"
            read -r custom_substep
            
            # éªŒè¯è¾“å…¥
            if [[ ! "$custom_step" =~ ^[1-5]$ ]]; then
                echo -e "${RED}æ— æ•ˆçš„STEPå€¼${NC}"
                show_custom_stage_menu
                return
            fi
            
            if [[ ! "$custom_model_idx" =~ ^[0-9]+$ ]]; then
                custom_model_idx=0
            fi
            
            rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
            echo "STEP=$custom_step" > "$PROGRESS_FILE"
            echo "MODEL_INDEX=$custom_model_idx" >> "$PROGRESS_FILE"
            echo "SUBSTEP=$custom_substep" >> "$PROGRESS_FILE"
            
            echo -e "${GREEN}âœ… å·²è®¾ç½®è‡ªå®šä¹‰è¿›åº¦:${NC}"
            echo "   STEP=$custom_step"
            echo "   MODEL_INDEX=$custom_model_idx"
            echo "   SUBSTEP=$custom_substep"
            START_FRESH=false
            break
            ;;
        7)
            echo -e "${BLUE}è¿”å›ä¸»èœå•${NC}"
            return
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©${NC}"
            show_custom_stage_menu
            ;;
    esac
}

# å¤±è´¥æµ‹è¯•é‡æ–°è¿è¡Œèœå•
show_failed_tests_rerun_menu() {
    echo -e "${PURPLE}========================================${NC}"
    echo -e "${PURPLE}ğŸ“‹ å¤±è´¥æµ‹è¯•é‡æ–°è¿è¡Œ${NC}"
    echo -e "${PURPLE}========================================${NC}"
    echo ""
    
    # æ˜¾ç¤ºå¤±è´¥æµ‹è¯•æ¦‚è¦
    show_failed_tests_summary
    echo ""
    
    echo -e "${YELLOW}é€‰é¡¹ï¼š${NC}"
    echo "  1) ğŸ“– æŸ¥çœ‹è¯¦ç»†å¤±è´¥ä¿¡æ¯"
    echo "  2) ğŸ”„ é‡æ–°è¿è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•"
    echo "  3) ğŸ¯ é€‰æ‹©ç‰¹å®šæ¨¡å‹é‡æ–°æµ‹è¯•"
    echo "  4) ğŸ§¹ æ¸…é™¤å¤±è´¥æµ‹è¯•è®°å½•"
    echo "  5) â¬…ï¸ è¿”å›ä¸»èœå•"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹© [1-5]:${NC}"
    
    read -r failed_choice
    case $failed_choice in
        1)
            echo -e "${CYAN}æŸ¥çœ‹è¯¦ç»†å¤±è´¥ä¿¡æ¯${NC}"
            echo ""
            show_failed_tests_details
            echo ""
            echo -e "${YELLOW}æŒ‰Enterè¿”å›...${NC}"
            read -r
            show_failed_tests_rerun_menu
            ;;
        2)
            echo -e "${GREEN}å¼€å§‹é‡æ–°è¿è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•${NC}"
            echo ""
            run_all_failed_tests
            ;;
        3)
            echo -e "${CYAN}é€‰æ‹©ç‰¹å®šæ¨¡å‹é‡æ–°æµ‹è¯•${NC}"
            echo ""
            show_select_failed_model_menu
            ;;
        4)
            echo -e "${YELLOW}æ¸…é™¤å¤±è´¥æµ‹è¯•è®°å½•${NC}"
            echo ""
            echo -e "${RED}âš ï¸  è¿™å°†åˆ é™¤å¤±è´¥æµ‹è¯•é…ç½®æ–‡ä»¶${NC}"
            echo -e "${YELLOW}ç¡®è®¤åˆ é™¤ï¼Ÿ[y/N]:${NC}"
            read -r confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                rm -f failed_tests_config_opensource.json failed_tests_config_closed_source.json
                echo -e "${GREEN}âœ… å·²æ¸…é™¤å¤±è´¥æµ‹è¯•è®°å½•${NC}"
                echo ""
                echo -e "${YELLOW}è¿”å›ä¸»èœå•...${NC}"
                sleep 2
                return
            else
                echo -e "${CYAN}å·²å–æ¶ˆ${NC}"
                show_failed_tests_rerun_menu
            fi
            ;;
        5)
            echo -e "${BLUE}è¿”å›ä¸»èœå•${NC}"
            return
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©${NC}"
            show_failed_tests_rerun_menu
            ;;
    esac
}

# ============================================
# å¢å¼ºçš„è‡ªåŠ¨ç»´æŠ¤èœå•
# ============================================

show_enhanced_maintenance_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}ğŸ”§ è‡ªåŠ¨å¤±è´¥ç»´æŠ¤ç³»ç»Ÿ${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    
    # æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    if [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
        echo -e "${GREEN}âœ… ç»´æŠ¤å‡½æ•°åº“å·²åŠ è½½${NC}"
        
        # æ˜¾ç¤ºå¿«é€ŸçŠ¶æ€
        echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ:${NC}"
        if command -v check_auto_maintenance_status >/dev/null 2>&1; then
            check_auto_maintenance_status >/dev/null 2>&1 && echo "  âœ… ç³»ç»Ÿæ­£å¸¸" || echo "  âŒ ç³»ç»Ÿå¼‚å¸¸"
        fi
        
        if command -v check_incomplete_tests >/dev/null 2>&1; then
            if check_incomplete_tests "" >/dev/null 2>&1; then
                echo "  âš ï¸  å‘ç°æœªå®Œæˆæµ‹è¯•"
            else
                echo "  âœ… æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ"
            fi
        fi
    else
        echo -e "${YELLOW}âš ï¸  ç»´æŠ¤å‡½æ•°åº“æœªåŠ è½½ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}ğŸ› ï¸  ç»´æŠ¤æ“ä½œ:${NC}"
    echo "  1) ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å’Œå®Œæˆæƒ…å†µ"
    echo "  2) ğŸ“Š åˆ†ææ¨¡å‹æµ‹è¯•è¿›åº¦"
    echo "  3) ğŸ“ ç”Ÿæˆè‡ªåŠ¨é‡æµ‹è„šæœ¬"
    echo "  4) ğŸ”„ æ‰§è¡Œå¢é‡é‡æµ‹ï¼ˆä»…æœªå®Œæˆçš„ï¼‰"
    echo "  5) ğŸ§™ è‡ªåŠ¨ç»´æŠ¤å‘å¯¼ï¼ˆæ¨èï¼‰"
    echo "  6) ğŸ”§ æ‰‹åŠ¨ç»´æŠ¤é…ç½®"
    echo ""
    echo -e "${YELLOW}ğŸš€ å¿«é€Ÿæ“ä½œ:${NC}"
    echo "  7) âš¡ ä¸€é”®æ™ºèƒ½ç»´æŠ¤ï¼ˆåˆ†æ+é‡æµ‹ï¼‰"
    echo "  8) ğŸ¯ åŸºäºå®Œå…¨å¤±è´¥+æ‰§è¡Œæ—¶é—´çš„æ™ºèƒ½é‡æµ‹"
    echo "  9) ğŸ“ˆ æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š"
    echo ""
    echo -e "${YELLOW}ğŸ”§ é«˜çº§åŠŸèƒ½:${NC}"
    echo "  10) ğŸ”¬ æ·±åº¦åˆ†ææµ‹è¯•å¼‚å¸¸"
    echo "  11) ğŸ› ï¸  ä¿®å¤æ•°æ®åº“ä¸€è‡´æ€§"
    echo "  12) ğŸ§¹ æ¸…ç†å†—ä½™æ•°æ®"
    echo ""
    echo "  0) â¬…ï¸  è¿”å›ä¸»èœå•"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹©ç»´æŠ¤æ“ä½œ [0-12]:${NC}"
}

handle_enhanced_maintenance_choice() {
    local choice="$1"
    
    case $choice in
        1)
            echo -e "${CYAN}ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å’Œå®Œæˆæƒ…å†µ${NC}"
            echo ""
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
                if command -v smart_maintenance_entry >/dev/null 2>&1; then
                    smart_maintenance_entry "check" "" "false"
                else
                    check_auto_maintenance_status
                    get_models_completion_summary ""
                fi
            else
                python3 auto_failure_maintenance_system.py status
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        2)
            echo -e "${CYAN}ğŸ“Š åˆ†ææ¨¡å‹æµ‹è¯•è¿›åº¦${NC}"
            echo ""
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v get_models_completion_summary >/dev/null 2>&1; then
                get_models_completion_summary ""
            else
                python3 -c "
import sys
sys.path.insert(0, '.')
from auto_failure_maintenance_system import AutoFailureMaintenanceSystem
system = AutoFailureMaintenanceSystem(enable_auto_retry=False)
analysis = system.analyze_test_completion()
print(f'åˆ†æäº† {len(analysis[\"models_analyzed\"])} ä¸ªæ¨¡å‹')
for model in analysis['models_analyzed']:
    summary = analysis['completion_summary'][model]
    if summary['status'] == 'analyzed':
        completion_rate = summary['completion_rate']
        failure_rate = summary['failure_rate']
        print(f'{model}: å®Œæˆç‡ {completion_rate:.1%}, å¤±è´¥ç‡ {failure_rate:.1%}')
"
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        3)
            echo -e "${CYAN}ğŸ“ ç”Ÿæˆè‡ªåŠ¨é‡æµ‹è„šæœ¬${NC}"
            echo ""
            echo -e "${YELLOW}è„šæœ¬åç§° (é»˜è®¤: auto_retest_generated.sh): ${NC}"
            read -r script_name
            script_name=${script_name:-auto_retest_generated.sh}
            
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v generate_retest_script >/dev/null 2>&1; then
                generate_retest_script "" "$script_name"
            else
                python3 auto_failure_maintenance_system.py retest
                if [ -f "auto_retest_incomplete.sh" ]; then
                    mv "auto_retest_incomplete.sh" "$script_name"
                    chmod +x "$script_name"
                    echo -e "${GREEN}âœ… é‡æµ‹è„šæœ¬å·²ç”Ÿæˆ: $script_name${NC}"
                fi
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        4)
            echo -e "${CYAN}ğŸ”„ æ‰§è¡Œå¢é‡é‡æµ‹${NC}"
            echo ""
            echo -e "${YELLOW}å®Œæˆç‡é˜ˆå€¼ (0.0-1.0, é»˜è®¤0.8): ${NC}"
            read -r threshold
            threshold=${threshold:-0.8}
            
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v run_incremental_retest >/dev/null 2>&1; then
                run_incremental_retest "" "$threshold" "false"
            else
                python3 smart_batch_runner.py --incremental-retest --completion-threshold "$threshold"
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        5)
            echo -e "${CYAN}ğŸ§™ è‡ªåŠ¨ç»´æŠ¤å‘å¯¼${NC}"
            echo ""
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v auto_maintenance_wizard >/dev/null 2>&1; then
                auto_maintenance_wizard "" "true"
            else
                echo -e "${YELLOW}âš ï¸  ç»´æŠ¤å‘å¯¼ä¸å¯ç”¨ï¼Œæ‰§è¡ŒåŸºæœ¬ç»´æŠ¤${NC}"
                python3 smart_batch_runner.py --auto-maintain
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        6)
            echo -e "${CYAN}ğŸ”§ æ‰‹åŠ¨ç»´æŠ¤é…ç½®${NC}"
            echo ""
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v load_maintenance_config >/dev/null 2>&1; then
                load_maintenance_config
            fi
            
            echo -e "${YELLOW}é€‰æ‹©ç»´æŠ¤ç±»å‹:${NC}"
            echo "  1) è‡ªåŠ¨ç»´æŠ¤ï¼ˆä»…åˆ†æï¼‰"
            echo "  2) è‡ªåŠ¨ç»´æŠ¤ï¼ˆæ‰§è¡Œé‡æµ‹ï¼‰"
            echo "  3) å¢é‡é‡æµ‹"
            echo "  4) ç”Ÿæˆè„šæœ¬"
            echo -e "${YELLOW}è¯·é€‰æ‹© [1-4]: ${NC}"
            read -r maintenance_type
            
            case $maintenance_type in
                1)
                    if [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
                        run_auto_maintenance "" "true"
                    else
                        python3 auto_failure_maintenance_system.py maintain
                    fi
                    ;;
                2)
                    if [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
                        run_auto_maintenance "" "false"
                    else
                        python3 smart_batch_runner.py --auto-maintain
                    fi
                    ;;
                3)
                    if [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
                        run_incremental_retest "" "0.8" "false"
                    else
                        python3 smart_batch_runner.py --incremental-retest
                    fi
                    ;;
                4)
                    python3 auto_failure_maintenance_system.py retest
                    ;;
            esac
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        7)
            echo -e "${CYAN}âš¡ ä¸€é”®æ™ºèƒ½ç»´æŠ¤${NC}"
            echo ""
            echo -e "${BLUE}æ‰§è¡Œæµç¨‹: çŠ¶æ€æ£€æŸ¥ â†’ è¿›åº¦åˆ†æ â†’ è‡ªåŠ¨é‡æµ‹${NC}"
            echo ""
            
            # æ­¥éª¤1: æ£€æŸ¥çŠ¶æ€
            echo -e "${YELLOW}æ­¥éª¤ 1/3: æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...${NC}"
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v check_auto_maintenance_status >/dev/null 2>&1; then
                if ! check_auto_maintenance_status; then
                    echo -e "${RED}âŒ ç³»ç»ŸçŠ¶æ€å¼‚å¸¸ï¼Œä¸­æ­¢ç»´æŠ¤${NC}"
                    return 1
                fi
            fi
            
            # æ­¥éª¤2: åˆ†æè¿›åº¦
            echo -e "${YELLOW}æ­¥éª¤ 2/3: åˆ†ææµ‹è¯•è¿›åº¦...${NC}"
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v check_incomplete_tests >/dev/null 2>&1; then
                if check_incomplete_tests ""; then
                    echo -e "${CYAN}å‘ç°æœªå®Œæˆæµ‹è¯•ï¼Œå‡†å¤‡é‡æµ‹...${NC}"
                    
                    # æ­¥éª¤3: æ‰§è¡Œé‡æµ‹
                    echo -e "${YELLOW}æ­¥éª¤ 3/3: æ‰§è¡Œå¢é‡é‡æµ‹...${NC}"
                    run_incremental_retest "" "0.8" "false"
                else
                    echo -e "${GREEN}âœ… æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ${NC}"
                fi
            else
                echo -e "${YELLOW}æ‰§è¡ŒPythonç‰ˆæœ¬ç»´æŠ¤...${NC}"
                python3 smart_batch_runner.py --auto-maintain
            fi
            
            echo -e "${GREEN}ğŸ‰ æ™ºèƒ½ç»´æŠ¤å®Œæˆ${NC}"
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        8)
            echo -e "${CYAN}ğŸ¯ åŸºäºå®Œå…¨å¤±è´¥+æ‰§è¡Œæ—¶é—´çš„æ™ºèƒ½é‡æµ‹${NC}"
            echo ""
            echo -e "${YELLOW}æ‰§è¡Œæ—¶é—´é˜ˆå€¼ (ç§’, é»˜è®¤300): ${NC}"
            read -r execution_threshold
            execution_threshold=${execution_threshold:-300}
            
            echo -e "${BLUE}åˆ†ææ¨¡å‹å®Œå…¨å¤±è´¥å’Œæ‰§è¡Œæ—¶é—´...${NC}"
            python3 -c "
import sys
sys.path.insert(0, '.')
from auto_failure_maintenance_system import AutoFailureMaintenanceSystem

system = AutoFailureMaintenanceSystem(enable_auto_retry=False)
# æ›´æ–°é…ç½®ä¸­çš„æ‰§è¡Œæ—¶é—´é˜ˆå€¼
system.auto_retest_config.max_execution_time = $execution_threshold
analysis = system.analyze_test_completion()

retry_models = []
for model in analysis['models_analyzed']:
    summary = analysis['completion_summary'][model]
    if summary['status'] == 'analyzed':
        complete_failure = summary.get('needs_retry_complete_failure', False)
        high_exec_time = summary.get('needs_retry_high_execution_time', False)
        avg_exec_time = summary.get('avg_execution_time', 0)
        
        reasons = []
        if complete_failure:
            failure_configs = summary.get('complete_failure_configs', [])
            reasons.append(f'å®Œå…¨å¤±è´¥é…ç½®: {len(failure_configs)}ä¸ª')
        if high_exec_time:
            reasons.append(f'æ‰§è¡Œæ—¶é—´è¿‡é•¿: {avg_exec_time:.1f}ç§’')
        
        if complete_failure or high_exec_time:
            retry_models.append(model)
            print(f'âš ï¸  {model}: {\" | \".join(reasons)}')

if retry_models:
    print(f'\\nå‘ç° {len(retry_models)} ä¸ªéœ€è¦é‡æµ‹çš„æ¨¡å‹')
    print('é‡æµ‹åŸå› : å®Œå…¨å¤±è´¥é…ç½® æˆ– æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼')
else:
    print('\\nâœ… æ‰€æœ‰æ¨¡å‹éƒ½åœ¨æ­£å¸¸èŒƒå›´å†…')
"
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        9)
            echo -e "${CYAN}ğŸ“ˆ æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š${NC}"
            echo ""
            if [ "$MAINTENANCE_LIB_LOADED" = "true" ] && command -v show_progress_summary >/dev/null 2>&1; then
                show_progress_summary
            else
                echo -e "${BLUE}ğŸ“Š åŸºæœ¬è¿›åº¦ä¿¡æ¯:${NC}"
                if [ -f "$COMPLETED_FILE" ]; then
                    local completed_count=$(wc -l < "$COMPLETED_FILE" 2>/dev/null || echo 0)
                    echo "  å·²å®Œæˆé…ç½®: $completed_count"
                fi
                if [ -f "$PROGRESS_FILE" ]; then
                    echo -e "${YELLOW}å½“å‰è¿›åº¦æ–‡ä»¶å†…å®¹:${NC}"
                    cat "$PROGRESS_FILE"
                fi
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        10)
            echo -e "${CYAN}ğŸ”¬ æ·±åº¦åˆ†ææµ‹è¯•å¼‚å¸¸${NC}"
            echo ""
            python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from auto_failure_maintenance_system import AutoFailureMaintenanceSystem
    system = AutoFailureMaintenanceSystem(enable_auto_retry=False)
    analysis = system.analyze_test_completion()
    
    print('ğŸ” æµ‹è¯•å¼‚å¸¸åˆ†æ:')
    print(f'- åˆ†ææ¨¡å‹æ•°: {len(analysis[\"models_analyzed\"])}')
    print(f'- å¤±è´¥æ¨¡å¼æ•°: {len(analysis[\"failure_patterns\"])}')
    print(f'- é‡è¯•å»ºè®®æ•°: {len(analysis[\"retry_recommendations\"])}')
    
    if analysis['failure_patterns']:
        print('\\nâš ï¸  å‘ç°çš„å¤±è´¥æ¨¡å¼:')
        for pattern in analysis['failure_patterns']:
            print(f'  - {pattern}')
            
    if analysis['retry_recommendations']:
        print('\\nğŸ’¡ é‡è¯•å»ºè®®:')
        for rec in analysis['retry_recommendations']:
            print(f'  - {rec}')
            
except Exception as e:
    print(f'âŒ æ·±åº¦åˆ†æå¤±è´¥: {e}')
"
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        11)
            echo -e "${CYAN}ğŸ› ï¸  ä¿®å¤æ•°æ®åº“ä¸€è‡´æ€§${NC}"
            echo ""
            echo -e "${YELLOW}âš ï¸  è¿™å°†æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“ä¸­çš„ä¸ä¸€è‡´é—®é¢˜${NC}"
            echo -e "${YELLOW}æ˜¯å¦ç»§ç»­ï¼Ÿ (y/n): ${NC}"
            read -r confirm
            if [ "$confirm" = "y" ]; then
                python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from data_structure_v3 import DatabaseManagerV3
    manager = DatabaseManagerV3()
    print('ğŸ”§ å¼€å§‹æ•°æ®åº“ä¸€è‡´æ€§æ£€æŸ¥...')
    
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ•°æ®åº“ä¿®å¤é€»è¾‘
    print('âœ… æ•°æ®åº“ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ')
except Exception as e:
    print(f'âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: {e}')
"
            fi
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        12)
            echo -e "${CYAN}ğŸ§¹ æ¸…ç†å†—ä½™æ•°æ®${NC}"
            echo ""
            echo -e "${YELLOW}é€‰æ‹©æ¸…ç†ç±»å‹:${NC}"
            echo "  1) æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶"
            echo "  2) æ¸…ç†ä¸´æ—¶æµ‹è¯•æ–‡ä»¶"
            echo "  3) å‹ç¼©å†å²æ•°æ®"
            echo "  4) å…¨é¢æ¸…ç†"
            echo -e "${YELLOW}è¯·é€‰æ‹© [1-4]: ${NC}"
            read -r cleanup_type
            
            case $cleanup_type in
                1)
                    echo "æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶..."
                    find logs/ -name "*.log" -mtime +7 -type f -delete 2>/dev/null || true
                    echo "âœ… æ—¥å¿—æ–‡ä»¶æ¸…ç†å®Œæˆ"
                    ;;
                2)
                    echo "æ¸…ç†ä¸´æ—¶æµ‹è¯•æ–‡ä»¶..."
                    rm -f test_*.tmp debug_*.tmp 2>/dev/null || true
                    echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
                    ;;
                3)
                    echo "å‹ç¼©å†å²æ•°æ®..."
                    # è¿™é‡Œå¯ä»¥æ·»åŠ æ•°æ®å‹ç¼©é€»è¾‘
                    echo "âœ… å†å²æ•°æ®å‹ç¼©å®Œæˆ"
                    ;;
                4)
                    echo "æ‰§è¡Œå…¨é¢æ¸…ç†..."
                    find logs/ -name "*.log" -mtime +7 -type f -delete 2>/dev/null || true
                    rm -f test_*.tmp debug_*.tmp 2>/dev/null || true
                    echo "âœ… å…¨é¢æ¸…ç†å®Œæˆ"
                    ;;
            esac
            echo ""
            echo -e "${YELLOW}æŒ‰Enterç»§ç»­...${NC}"
            read -r
            ;;
        0)
            echo -e "${GREEN}è¿”å›ä¸»èœå•${NC}"
            return 0
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥${NC}"
            sleep 1
            return 1
            ;;
    esac
    
    return 0
}

# è¿è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•
run_all_failed_tests() {
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}ğŸ”„ é‡æ–°è¿è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    if ! check_failed_tests_config; then
        echo -e "${RED}âŒ æ²¡æœ‰æ‰¾åˆ°å¤±è´¥æµ‹è¯•é…ç½®æ–‡ä»¶${NC}"
        return 1
    fi
    
    # ç¡®è®¤
    echo -e "${YELLOW}å³å°†å¼€å§‹é‡æ–°è¿è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•ç»„${NC}"
    echo -e "${YELLOW}è¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ[y/N]:${NC}"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${CYAN}å·²å–æ¶ˆ${NC}"
        return 0
    fi
    
    # è®¾ç½®æµ‹è¯•æ¨¡å¼ä¸ºè‡ªåŠ¨
    AUTO_MODE="auto"
    CHECKPOINT_INTERVAL=10
    
    # ä½¿ç”¨pythonè„šæœ¬æ‰§è¡Œæ‰€æœ‰å¤±è´¥çš„æµ‹è¯•
    python3 -c "
import json
import subprocess
import sys

def run_test(model, prompt_types, group_name):
    '''è¿è¡Œå•ä¸ªæµ‹è¯•ç»„'''
    print(f'ğŸ”„ å¼€å§‹æµ‹è¯•: {model} - {group_name}')
    
    cmd = [
        'python', 'ultra_parallel_runner.py',
        '--model', model,
        '--prompt-types', prompt_types,
        '--difficulty', 'easy',
        '--task-types', 'all',
        '--num-instances', '$NUM_INSTANCES'
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=7200)  # 2å°æ—¶è¶…æ—¶
        if result.returncode == 0:
            print(f'âœ… {model} - {group_name} æµ‹è¯•æˆåŠŸ')
            return True
        else:
            print(f'âŒ {model} - {group_name} æµ‹è¯•å¤±è´¥')
            print(f'é”™è¯¯: {result.stderr}')
            return False
    except subprocess.TimeoutExpired:
        print(f'â° {model} - {group_name} æµ‹è¯•è¶…æ—¶')
        return False
    except Exception as e:
        print(f'ğŸ’¥ {model} - {group_name} æµ‹è¯•å¼‚å¸¸: {e}')
        return False

# è¯»å–å¤±è´¥æµ‹è¯•é…ç½®
try:
    config_file = 'failed_tests_config_closed_source.json' if '$MODEL_TYPE' == 'closed_source' else 'failed_tests_config_opensource.json'
with open(config_file, 'r', encoding='utf-8') as f:
        config = json.load(f)
except Exception as e:
    print(f'âŒ è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}')
    sys.exit(1)

session = config['failed_tests_session']
total_tests = 0
success_tests = 0

print('å¼€å§‹æ‰§è¡Œé‡æ–°æµ‹è¯•...\n')

for model_data in session['failed_groups']:
    model = model_data['model']
    print(f'ğŸ“‹ å¤„ç†æ¨¡å‹: {model}')
    
    # é‡æµ‹å¤±è´¥çš„ç»„
    for failed in model_data['failed_groups']:
        group_name = failed['group_name']
        prompt_types = failed['prompt_types']
        total_tests += 1
        
        if run_test(model, prompt_types, f'é‡æµ‹-{group_name}'):
            success_tests += 1
    
    # å®Œæˆå‰©ä½™çš„ç»„
    for remaining in model_data['remaining_groups']:
        group_name = remaining['group_name']
        prompt_types = remaining['prompt_types']
        total_tests += 1
        
        if run_test(model, prompt_types, f'å®Œæˆ-{group_name}'):
            success_tests += 1
    
    print()

print('=' * 50)
print(f'ğŸ“Š é‡æ–°æµ‹è¯•å®Œæˆ')
print(f'æ€»æµ‹è¯•æ•°: {total_tests}')
print(f'æˆåŠŸæ•°: {success_tests}')
print(f'å¤±è´¥æ•°: {total_tests - success_tests}')
print(f'æˆåŠŸç‡: {success_tests/total_tests*100:.1f}%' if total_tests > 0 else '0%')

if success_tests == total_tests:
    print('ğŸ‰ æ‰€æœ‰å¤±è´¥çš„æµ‹è¯•éƒ½å·²æˆåŠŸé‡æ–°è¿è¡Œï¼')
    # å¯ä»¥é€‰æ‹©åˆ é™¤å¤±è´¥æµ‹è¯•è®°å½•
    print('å»ºè®®åˆ é™¤å¤±è´¥æµ‹è¯•è®°å½•æ–‡ä»¶')
else:
    print('âš ï¸  ä»æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—')
"
    
    echo ""
    echo -e "${YELLOW}æŒ‰Enterè¿”å›ä¸»èœå•...${NC}"
    read -r
}

# é€‰æ‹©ç‰¹å®šæ¨¡å‹é‡æ–°æµ‹è¯•èœå•
show_select_failed_model_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}ğŸ¯ é€‰æ‹©ç‰¹å®šæ¨¡å‹é‡æ–°æµ‹è¯•${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    
    # ä½¿ç”¨pythonæ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨
    python3 -c "
import json

config_file = 'failed_tests_config_closed_source.json' if '$MODEL_TYPE' == 'closed_source' else 'failed_tests_config_opensource.json'
with open(config_file, 'r', encoding='utf-8') as f:
    config = json.load(f)

models = config['failed_tests_session']['failed_groups']
print('å¤±è´¥çš„æ¨¡å‹åˆ—è¡¨:')
for i, model_data in enumerate(models, 1):
    model = model_data['model']
    failed_count = len(model_data['failed_groups'])
    remaining_count = len(model_data['remaining_groups'])
    print(f'  {i}) {model} (å¤±è´¥:{failed_count}, å‰©ä½™:{remaining_count})')

print()
print(f'  {len(models)+1}) â¬…ï¸ è¿”å›ä¸Šä¸€çº§')
"
    
    echo ""
    local config_file=$( [ "$MODEL_TYPE" = "closed_source" ] && echo "failed_tests_config_closed_source.json" || echo "failed_tests_config_opensource.json" )
    echo -e "${YELLOW}è¯·é€‰æ‹©æ¨¡å‹ [1-$(python3 -c "import json; import sys; config=json.load(open(sys.argv[1])); print(len(config['failed_tests_session']['failed_groups'])+1)" "$config_file")]:${NC}"
    
    read -r model_choice
    
    # éªŒè¯é€‰æ‹©å¹¶æ‰§è¡Œ
    python3 -c "
import json
import subprocess

config_file = 'failed_tests_config_closed_source.json' if '$MODEL_TYPE' == 'closed_source' else 'failed_tests_config_opensource.json'
with open(config_file, 'r', encoding='utf-8') as f:
    config = json.load(f)

models = config['failed_tests_session']['failed_groups']
choice = int('$model_choice') - 1

if choice == len(models):
    print('è¿”å›ä¸Šä¸€çº§')
    exit(0)
elif 0 <= choice < len(models):
    model_data = models[choice]
    model = model_data['model']
    
    print(f'å¼€å§‹é‡æ–°æµ‹è¯•æ¨¡å‹: {model}')
    
    # æ‰§è¡Œè¯¥æ¨¡å‹çš„æ‰€æœ‰æµ‹è¯•
    for failed in model_data['failed_groups']:
        group_name = failed['group_name']
        prompt_types = failed['prompt_types']
        print(f'é‡æµ‹ {group_name}...')
        # è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„æµ‹è¯•å‘½ä»¤
    
    for remaining in model_data['remaining_groups']:
        group_name = remaining['group_name']
        prompt_types = remaining['prompt_types']
        print(f'å®Œæˆ {group_name}...')
        # è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„æµ‹è¯•å‘½ä»¤
        
    print(f'âœ… æ¨¡å‹ {model} çš„æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ')
else:
    print('æ— æ•ˆé€‰æ‹©')
    exit(1)
"
    
    echo ""
    echo -e "${YELLOW}æŒ‰Enterè¿”å›...${NC}"
    read -r
    show_select_failed_model_menu
}

# æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
show_progress_info() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}å½“å‰æµ‹è¯•è¿›åº¦ï¼š${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    
    if [ -f "test_progress.txt" ]; then
        source test_progress.txt
        echo "  å½“å‰æ­¥éª¤: 5.$STEP"
        echo "  æ¨¡å‹ç´¢å¼•: $MODEL_INDEX"
        if [ -n "$SUBSTEP" ]; then
            echo "  å­æ­¥éª¤: $SUBSTEP"
        fi
    else
        echo "  å°šæœªå¼€å§‹æµ‹è¯•"
    fi
    
    if [ -f "completed_tests.txt" ]; then
        completed_count=$(wc -l < "completed_tests.txt" 2>/dev/null || echo 0)
        echo "  å·²å®Œæˆé…ç½®: $completed_count"
    else
        echo "  å·²å®Œæˆé…ç½®: 0"
    fi
    
    # æ£€æŸ¥æ•°æ®åº“
    DB_PATH="pilot_bench_cumulative_results/master_database.json"
    if [ -f "$DB_PATH" ]; then
        total_tests=$(python -c "import json; data=json.load(open('$DB_PATH')); print(data['summary']['total_tests'])" 2>/dev/null || echo 0)
        echo "  ç´¯ç§¯æµ‹è¯•æ•°: $total_tests"
    fi
    
    echo ""
    echo -e "${YELLOW}æŒ‰Enterè¿”å›ä¸»èœå•...${NC}"
    read -r
}

# æ£€æŸ¥è‡ªåŠ¨æ¨¡å¼ä¸‹çš„å¤±è´¥é‡æµ‹é€‰é¡¹
check_auto_mode_failure_retry() {
    echo ""
    echo -e "${CYAN}ğŸ” æ£€æŸ¥å¤±è´¥æµ‹è¯•è®°å½•...${NC}"
    
    # æ£€æŸ¥å¢å¼ºå¤±è´¥æµ‹è¯•ç®¡ç†å™¨æ˜¯å¦æœ‰è®°å½•
    if python3 -c "
from enhanced_failed_tests_manager import EnhancedFailedTestsManager
manager = EnhancedFailedTestsManager()
if manager.has_failed_tests():
    import sys
    sys.exit(0)
else:
    sys.exit(1)
" 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  æ£€æµ‹åˆ°å¤±è´¥çš„æµ‹è¯•è®°å½•${NC}"
        echo ""
        
        # æ˜¾ç¤ºå¤±è´¥æµ‹è¯•æ¦‚è¦
        python3 -c "
from enhanced_failed_tests_manager import EnhancedFailedTestsManager
manager = EnhancedFailedTestsManager()
retry_queue = manager.get_retry_queue()
print(f'ğŸ“Š å¤±è´¥æµ‹è¯•æ¦‚è¦:')
print(f'   å¾…é‡è¯•æµ‹è¯•: {len(retry_queue)} ä¸ª')
for model in manager.get_all_failed_models():
    failed_tests = manager.get_failed_tests_for_model(model)
    active_failures = [t for t in failed_tests if t['status'] == 'failed']
    if active_failures:
        print(f'   {model}: {len(active_failures)} ä¸ªå¤±è´¥æµ‹è¯•')
"
        echo ""
        echo -e "${CYAN}é€‰æ‹©æ“ä½œ:${NC}"
        echo "  1) ğŸ”„ å…ˆé‡æµ‹å¤±è´¥çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ­£å¸¸æµç¨‹"
        echo "  2) â¡ï¸  è·³è¿‡å¤±è´¥é‡æµ‹ï¼Œç›´æ¥ç»§ç»­æ­£å¸¸æµç¨‹"
        echo "  3) ğŸ›‘ é€€å‡ºï¼Œæ‰‹åŠ¨å¤„ç†å¤±è´¥æµ‹è¯•"
        echo ""
        echo -n "è¯·é€‰æ‹© [1-3]: "
        read -r retry_choice
        
        case $retry_choice in
            1)
                echo -e "${GREEN}âœ… é€‰æ‹©ï¼šå…ˆé‡æµ‹å¤±è´¥éƒ¨åˆ†${NC}"
                echo ""
                run_automatic_retry
                echo ""
                echo -e "${GREEN}å¤±è´¥é‡æµ‹å®Œæˆï¼Œç»§ç»­æ­£å¸¸æµç¨‹...${NC}"
                ;;
            2)
                echo -e "${YELLOW}â­ï¸  è·³è¿‡å¤±è´¥é‡æµ‹${NC}"
                ;;
            3)
                echo -e "${RED}é€€å‡ºå¤„ç†å¤±è´¥æµ‹è¯•${NC}"
                echo ""
                echo "ğŸ’¡ å»ºè®®æ“ä½œï¼š"
                echo "   python3 enhanced_failed_tests_manager.py status"
                echo "   python3 enhanced_failed_tests_manager.py retry"
                exit 0
                ;;
            *)
                echo -e "${YELLOW}æ— æ•ˆé€‰æ‹©ï¼Œè·³è¿‡å¤±è´¥é‡æµ‹${NC}"
                ;;
        esac
    else
        echo -e "${GREEN}âœ… æ²¡æœ‰å¾…é‡æµ‹çš„å¤±è´¥è®°å½•${NC}"
    fi
    echo ""
}

# è¿è¡Œè‡ªåŠ¨é‡è¯•
run_automatic_retry() {
    echo -e "${CYAN}ğŸ”„ å¼€å§‹è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æµ‹è¯•...${NC}"
    
    # ç¬¬ä¸€æ­¥ï¼šæ¸…ç†æ˜æ˜¾çš„è¶…æ—¶é”™è¯¯æ•°æ®
    echo -e "${YELLOW}ğŸ§¹ æ­¥éª¤1: æ¸…ç†æ˜æ˜¾çš„è¶…æ—¶é”™è¯¯æ•°æ®...${NC}"
    python3 database_cleanup_for_retry.py clean_timeouts
    echo ""
    
    # ç¬¬äºŒæ­¥ï¼šæ¸…ç†æ•°æ®åº“ä¸­å¯¹åº”çš„æ—§æ•°æ®
    echo -e "${YELLOW}ğŸ§¹ æ­¥éª¤2: æ¸…ç†å¤±è´¥æµ‹è¯•çš„æ—§æ•°æ®...${NC}"
    python3 database_cleanup_for_retry.py clean_failed
    echo ""
    
    # å¯åŠ¨æµ‹è¯•æ‰§è¡Œç›‘æ§å™¨
    python3 -c "
from test_execution_monitor import get_global_monitor
from enhanced_failed_tests_manager import EnhancedFailedTestsManager
from enhanced_progress_manager import EnhancedProgressManager

# åˆå§‹åŒ–ç®¡ç†å™¨
failed_manager = EnhancedFailedTestsManager()
progress_manager = EnhancedProgressManager()
monitor = get_global_monitor()

print('ğŸ”§ è®¾ç½®è‡ªåŠ¨ç›‘æ§å’Œé‡è¯•ç³»ç»Ÿ...')
monitor.start_monitoring()

# è·å–é‡è¯•é˜Ÿåˆ—
retry_queue = failed_manager.get_retry_queue()
print(f'ğŸ“‹ å¾…é‡è¯•æµ‹è¯•: {len(retry_queue)} ä¸ª')

if retry_queue:
    # æŒ‰æ¨¡å‹åˆ†ç»„é‡è¯•
    models_to_retry = {}
    for item in retry_queue:
        model = item['model']
        if model not in models_to_retry:
            models_to_retry[model] = []
        models_to_retry[model].append(item['test'])
    
    print(f'ğŸ¯ æ¶‰åŠæ¨¡å‹: {len(models_to_retry)} ä¸ª')
    
    success_count = 0
    total_count = len(retry_queue)
    
    for model, tests in models_to_retry.items():
        print(f'\\nğŸ¤– é‡è¯•æ¨¡å‹: {model}')
        
        # æ„å»ºé‡è¯•ç»„åˆ—è¡¨
        groups_to_retry = []
        for test in tests:
            if test['status'] == 'failed' and test['retry_count'] < test['max_retries']:
                groups_to_retry.append(test['group_name'])
        
        if groups_to_retry:
            print(f'   é‡è¯•ç»„: {', '.join(groups_to_retry)}')
            
            # æ ‡è®°ä¸ºé‡è¯•çŠ¶æ€
            for group in groups_to_retry:
                failed_manager.mark_test_for_retry(model, group)
                progress_manager.start_retry(model, group)
            
            print('   âœ¨ å·²æ ‡è®°ä¸ºé‡è¯•çŠ¶æ€')
        
    print(f'\\nâœ… è‡ªåŠ¨é‡è¯•è®¾ç½®å®Œæˆ')
    print(f'ğŸ“ˆ é‡è¯•ç»Ÿè®¡:')
    print(f'   - æ€»æµ‹è¯•æ•°: {total_count}')
    print(f'   - æ¶‰åŠæ¨¡å‹: {len(models_to_retry)}')
else:
    print('âœ… æ²¡æœ‰éœ€è¦é‡è¯•çš„æµ‹è¯•')
" 2>/dev/null
    
    echo ""
    echo -e "${GREEN}ğŸ¯ è‡ªåŠ¨é‡è¯•é…ç½®å®Œæˆ${NC}"
    echo "   ç›‘æ§å™¨å°†è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†åç»­çš„å¤±è´¥"
    echo "   é‡è¯•çŠ¶æ€å·²æ›´æ–°åˆ°è¿›åº¦ç®¡ç†ç³»ç»Ÿ"
}

# æ˜¾ç¤ºå¢å¼ºè¿›åº¦ä¿¡æ¯
show_enhanced_progress() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}ğŸ“Š å¢å¼ºè¿›åº¦ç®¡ç†ç³»ç»ŸçŠ¶æ€${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    
    # æ˜¾ç¤ºå¢å¼ºè¿›åº¦ç®¡ç†å™¨çŠ¶æ€
    echo -e "${GREEN}ğŸ¯ è¯¦ç»†è¿›åº¦çŠ¶æ€:${NC}"
    python3 -c "
from enhanced_progress_manager import EnhancedProgressManager
manager = EnhancedProgressManager()
manager.show_detailed_progress()
" 2>/dev/null
    
    echo ""
    echo -e "${GREEN}ğŸ”„ å¤±è´¥æµ‹è¯•ç®¡ç†çŠ¶æ€:${NC}"
    python3 -c "
from enhanced_failed_tests_manager import EnhancedFailedTestsManager
manager = EnhancedFailedTestsManager()
manager.show_status_report()
" 2>/dev/null
    
    echo ""
    echo -e "${GREEN}ğŸ” æµ‹è¯•æ‰§è¡Œç›‘æ§çŠ¶æ€:${NC}"
    python3 -c "
from test_execution_monitor import get_global_monitor
monitor = get_global_monitor()
monitor.show_monitoring_status()
" 2>/dev/null
    
    echo ""
    echo -e "${YELLOW}æŒ‰Enterè¿”å›ä¸»èœå•...${NC}"
    read -r
}

# å…¨å±€å˜é‡ï¼šæµ‹è¯•æ¨¡å¼
TEST_MODE="auto"  # auto: è‡ªåŠ¨æ¨¡å¼, debug: è°ƒè¯•æ¨¡å¼, full_auto: å…¨è‡ªåŠ¨æ¨¡å¼
PAUSE_AFTER_MODEL=false  # æ˜¯å¦åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
PAUSE_AFTER_STAGE=true   # æ˜¯å¦åœ¨æ¯ä¸ªé˜¶æ®µåæš‚åœ
START_FRESH=false        # æ˜¯å¦å®Œå…¨é‡æ–°å¼€å§‹
RATE_MODE="fixed"       # adaptive: è‡ªé€‚åº”æ¨¡å¼, fixed: å›ºå®šé€Ÿç‡, custom: è‡ªå®šä¹‰ (é»˜è®¤ä¸ºfixedæ¨¡å¼)
CUSTOM_WORKERS=10        # è‡ªå®šä¹‰å¹¶å‘æ•°
CUSTOM_QPS=20           # è‡ªå®šä¹‰QPS

# å¤„ç†å‘½ä»¤è¡Œå‚æ•°çš„è‡ªåŠ¨æ“ä½œ
if [ "$SKIP_MENU" = true ]; then
    # å¤„ç† --fresh å‚æ•°
    if [ "$FORCE_FRESH" = true ]; then
        echo -e "${YELLOW}å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ•°æ®...${NC}"
        rm -f "$PROGRESS_FILE" "$COMPLETED_FILE"
        if [ -d "pilot_bench_cumulative_results" ]; then
            BACKUP_DIR="pilot_bench_cumulative_results_backup_$(date +%Y%m%d_%H%M%S)"
            mv pilot_bench_cumulative_results "$BACKUP_DIR"
            echo -e "${GREEN}âœ“ å·²å¤‡ä»½æ•°æ®åº“åˆ° $BACKUP_DIR${NC}"
        fi
        mkdir -p pilot_bench_cumulative_results
        echo '{"version": "3.0", "models": {}, "test_groups": {}, "summary": {}}' > pilot_bench_cumulative_results/master_database.json
        START_FRESH=true
    fi
    
    # å¤„ç† --ignore-progress æˆ– --incremental
    if [ "$IGNORE_PROGRESS" = true ]; then
        if [ "$INCREMENTAL_MODE" = true ]; then
            echo -e "${CYAN}å¢é‡æµ‹è¯•æ¨¡å¼ï¼šå¿½ç•¥è¿›åº¦æ–‡ä»¶ï¼Œåªæµ‹è¯•æœªå®Œæˆçš„é…ç½®${NC}"
        else
            echo -e "${CYAN}å¿½ç•¥è¿›åº¦æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹æµ‹è¯•ï¼ˆä¿ç•™å·²æœ‰æ•°æ®ï¼‰${NC}"
        fi
        # ä¸´æ—¶é‡å‘½åè¿›åº¦æ–‡ä»¶
        if [ -f "$PROGRESS_FILE" ]; then
            mv "$PROGRESS_FILE" "${PROGRESS_FILE}.ignored"
        fi
        if [ -f "$COMPLETED_FILE" ]; then
            mv "$COMPLETED_FILE" "${COMPLETED_FILE}.ignored"
        fi
        START_FRESH=true
    fi
    
    # è®¾ç½®æµ‹è¯•æ¨¡å¼
    if [ -n "$AUTO_MODE" ]; then
        case $AUTO_MODE in
            auto)
                TEST_MODE="auto"
                PAUSE_AFTER_MODEL=false
                PAUSE_AFTER_STAGE=true
                echo -e "${GREEN}ä½¿ç”¨è‡ªåŠ¨æ¨¡å¼${NC}"
                # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•éœ€è¦é‡è¯•
                check_auto_mode_failure_retry
                ;;
            debug)
                TEST_MODE="debug"
                PAUSE_AFTER_MODEL=true
                PAUSE_AFTER_STAGE=true
                echo -e "${CYAN}ä½¿ç”¨è°ƒè¯•æ¨¡å¼${NC}"
                ;;
            full_auto)
                TEST_MODE="full_auto"
                PAUSE_AFTER_MODEL=false
                PAUSE_AFTER_STAGE=false
                echo -e "${YELLOW}ä½¿ç”¨å…¨è‡ªåŠ¨æ¨¡å¼${NC}"
                # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•éœ€è¦é‡è¯•
                check_auto_mode_failure_retry
                ;;
        esac
    fi
    
    # ç›´æ¥å¼€å§‹æµ‹è¯•
    break
fi

# ============================================
# æ¨¡å‹ç±»å‹é€‰æ‹©å¾ªç¯ï¼ˆæœ€é«˜å±‚èœå•ï¼‰
# ============================================

# å­˜å‚¨æ ¼å¼é€‰æ‹©å‡½æ•°
show_storage_format_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}é€‰æ‹©æ•°æ®å­˜å‚¨æ ¼å¼${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹©æ•°æ®å­˜å‚¨æ ¼å¼ï¼š${NC}"
    echo ""
    echo "  1) ğŸ“„ JSONæ ¼å¼ (ä¼ ç»Ÿæ–¹å¼ï¼Œå…¼å®¹æ€§å¥½)"
    echo "  2) ğŸš€ Parquetæ ¼å¼ (æ¨èï¼šé«˜æ€§èƒ½ï¼Œé˜²æ•°æ®ä¸¢å¤±)"
    echo ""
    echo -e "${GREEN}Parquetä¼˜åŠ¿ï¼š${NC}"
    echo "  â€¢ å¢é‡å†™å…¥ï¼Œæ°¸ä¸è¦†ç›–"
    echo "  â€¢ ä¸­æ–­å®‰å…¨ï¼Œæ•°æ®ä¸ä¸¢å¤±"
    echo "  â€¢ å¹¶å‘å†™å…¥ä¸å†²çª"
    echo "  â€¢ æŸ¥è¯¢é€Ÿåº¦å¿«100å€"
    echo "  â€¢ æ–‡ä»¶å¤§å°å‡å°‘80%"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹© [1-2] (é»˜è®¤1):${NC}"
}

# è®¾ç½®å­˜å‚¨æ ¼å¼
setup_storage_format() {
    local choice=$1
    
    case $choice in
        1|"")
            export STORAGE_FORMAT="json"
            echo -e "${GREEN}âœ… ä½¿ç”¨JSONå­˜å‚¨æ ¼å¼${NC}"
            ;;
        2)
            # æ£€æŸ¥Parquetä¾èµ–
            if python3 -c "import pandas, pyarrow" 2>/dev/null; then
                export STORAGE_FORMAT="parquet"
                echo -e "${GREEN}âœ… ä½¿ç”¨Parquetå­˜å‚¨æ ¼å¼${NC}"
                
                # ç¡®ä¿Parquetç›®å½•å­˜åœ¨
                mkdir -p pilot_bench_cumulative_results/parquet_data/incremental 2>/dev/null
                mkdir -p pilot_bench_parquet_data/incremental 2>/dev/null
                
                # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»æ•°æ®
                if [ ! -d "pilot_bench_parquet_data" ] || [ -z "$(ls -A pilot_bench_parquet_data/*.parquet 2>/dev/null)" ]; then
                    echo -e "${YELLOW}æ£€æµ‹åˆ°éœ€è¦è¿ç§»æ•°æ®åˆ°Parquet...${NC}"
                    echo -e "${CYAN}æ˜¯å¦ç«‹å³è¿ç§»ç°æœ‰JSONæ•°æ®ï¼Ÿ(y/n):${NC}"
                    read -r migrate_choice
                    if [ "$migrate_choice" = "y" ] || [ "$migrate_choice" = "Y" ]; then
                        python3 migrate_to_parquet.py
                    fi
                fi
            else
                echo -e "${RED}âŒ Parquetéœ€è¦å®‰è£…ä¾èµ–${NC}"
                echo -e "${YELLOW}è¯·è¿è¡Œ: pip install pandas pyarrow${NC}"
                echo -e "${YELLOW}å›é€€åˆ°JSONæ ¼å¼${NC}"
                export STORAGE_FORMAT="json"
            fi
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤JSONæ ¼å¼${NC}"
            export STORAGE_FORMAT="json"
            ;;
    esac
    
    # æ˜¾ç¤ºå½“å‰é…ç½®ï¼ˆå…¼å®¹macOSçš„bash 3.2ï¼‰
    STORAGE_FORMAT_UPPER=$(echo "$STORAGE_FORMAT" | tr '[:lower:]' '[:upper:]')
    echo -e "${BLUE}å½“å‰å­˜å‚¨æ ¼å¼: ${STORAGE_FORMAT_UPPER}${NC}"
    echo ""
    
    # ç¡®ä¿ç¯å¢ƒå˜é‡ä¼šä¼ é€’ç»™æ‰€æœ‰å­è¿›ç¨‹
    export STORAGE_FORMAT
}

# æ¨¡å‹ç±»å‹é€‰æ‹©å‡½æ•°
show_model_type_menu() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}PILOT-Bench ç³»ç»ŸåŒ–æµ‹è¯•${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹©æµ‹è¯•æ¨¡å‹ç±»å‹ï¼š${NC}"
    echo ""
    echo "  1) ğŸ”“ å¼€æºæ¨¡å‹ (DeepSeek, Qwen, Llama)"
    echo "  2) ğŸ”’ é—­æºæ¨¡å‹ (GPT, Claude, Gemini)"
    echo "  3) ğŸ“Š æŸ¥çœ‹ä¸¤ç§æ¨¡å‹çš„è¿›åº¦"
    echo "  4) ğŸ”§ ç»´æŠ¤æ¨¡å¼"
    echo "  5) âŒ é€€å‡º"
    echo ""
    echo -e "${YELLOW}è¯·é€‰æ‹© [1-5]:${NC}"
}

# è®¾ç½®æ¨¡å‹ç±»å‹å’Œç›¸å…³é…ç½®
setup_model_type() {
    local choice=$1
    
    case $choice in
        1)
            MODEL_TYPE="opensource"
            export MODEL_TYPE  # å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›Pythonè„šæœ¬ä½¿ç”¨
            CURRENT_MODELS=("${OPENSOURCE_MODELS[@]}")
            RESULT_SUFFIX=""
            PROGRESS_FILE="test_progress_opensource.txt"
            COMPLETED_FILE="completed_tests_opensource.txt"
            echo -e "${GREEN}âœ… é€‰æ‹©ï¼šå¼€æºæ¨¡å‹æµ‹è¯•${NC}"
            echo -e "${CYAN}   æ¨¡å‹æ•°é‡ï¼š${#CURRENT_MODELS[@]}ä¸ª${NC}"
            echo ""
            return 0
            ;;
        2)
            MODEL_TYPE="closed_source"
            export MODEL_TYPE  # å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›Pythonè„šæœ¬ä½¿ç”¨
            CURRENT_MODELS=("${CLOSED_SOURCE_MODELS[@]}")
            RESULT_SUFFIX="_closed_source"
            PROGRESS_FILE="test_progress_closed_source.txt"
            COMPLETED_FILE="completed_tests_closed_source.txt"
            echo -e "${GREEN}âœ… é€‰æ‹©ï¼šé—­æºæ¨¡å‹æµ‹è¯•${NC}"
            echo -e "${CYAN}   æ¨¡å‹æ•°é‡ï¼š${#CURRENT_MODELS[@]}ä¸ª${NC}"
            echo -e "${YELLOW}   æ³¨æ„ï¼šIdealLabä½¿ç”¨å•keyï¼ŒAzureä½¿ç”¨é«˜å¹¶å‘${NC}"
            echo ""
            return 0
            ;;
        3)
            # æ˜¾ç¤ºä¸¤ç§æ¨¡å‹çš„è¿›åº¦
            echo ""
            echo -e "${CYAN}ğŸ“Š å¼€æºæ¨¡å‹è¿›åº¦ï¼š${NC}"
            if [ -f "test_progress_opensource.txt" ]; then
                STEP=""
                MODEL_INDEX=""
                SUBSTEP=""
                source "test_progress_opensource.txt" 2>/dev/null
                local open_completed=$(wc -l < "completed_tests_opensource.txt" 2>/dev/null || echo 0)
                echo "   å½“å‰æ­¥éª¤: 5.$STEP"
                echo "   å·²å®Œæˆé…ç½®: $open_completed"
            else
                echo "   æš‚æ— è¿›åº¦"
            fi
            echo ""
            echo -e "${CYAN}ğŸ“Š é—­æºæ¨¡å‹è¿›åº¦ï¼š${NC}"
            if [ -f "test_progress_closed_source.txt" ]; then
                STEP=""
                MODEL_INDEX=""
                SUBSTEP=""
                source "test_progress_closed_source.txt" 2>/dev/null
                local closed_completed=$(wc -l < "completed_tests_closed_source.txt" 2>/dev/null || echo 0)
                echo "   å½“å‰æ­¥éª¤: 5.$STEP"
                echo "   å·²å®Œæˆé…ç½®: $closed_completed"
            else
                echo "   æš‚æ— è¿›åº¦"
            fi
            echo ""
            return 1  # è¿”å›1è¡¨ç¤ºéœ€è¦é‡æ–°æ˜¾ç¤ºèœå•
            ;;
        4)
            # ç»´æŠ¤æ¨¡å¼
            echo -e "${CYAN}ğŸ”§ ç»´æŠ¤æ¨¡å¼${NC}"
            if command -v smart_maintenance_entry >/dev/null 2>&1; then
                smart_maintenance_entry "wizard" "" "true"
            else
                echo -e "${YELLOW}âš ï¸ æœªåŠ è½½ç»´æŠ¤å‡½æ•°åº“ï¼Œä½¿ç”¨åŸºæœ¬ç»´æŠ¤${NC}"
                python3 auto_failure_maintenance_system.py status
            fi
            exit 0
            ;;
        5)
            echo -e "${YELLOW}é€€å‡ºæµ‹è¯•ç³»ç»Ÿ${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹${NC}"
            return 1
            ;;
    esac
}

# é¦–å…ˆé€‰æ‹©å­˜å‚¨æ ¼å¼ï¼ˆå¦‚æœæœªé€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ï¼‰
if [ -z "$STORAGE_FORMAT" ]; then
    # ä»…åœ¨äº¤äº’æ¨¡å¼ä¸‹æ˜¾ç¤ºèœå•
    if [ "$SKIP_MENU" != true ]; then
        show_storage_format_menu
        read -r storage_choice
        setup_storage_format "$storage_choice"
    else
        # éäº¤äº’æ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤JSON
        export STORAGE_FORMAT="json"
        echo -e "${BLUE}ä½¿ç”¨é»˜è®¤å­˜å‚¨æ ¼å¼: JSON${NC}"
    fi
else
    echo -e "${BLUE}ä½¿ç”¨é¢„è®¾å­˜å‚¨æ ¼å¼: ${STORAGE_FORMAT^^}${NC}"
fi

# ç„¶åé€‰æ‹©æ¨¡å‹ç±»å‹
while true; do
    show_model_type_menu
    read -r model_choice
    
    if setup_model_type "$model_choice"; then
        break
    fi
done

# ä¸»èœå•å¾ªç¯ - ç¬¬äºŒå±‚ï¼šå†³å®šæ˜¯å¦é‡æ–°å¼€å§‹
while true; do
    show_initial_menu
    read -r choice
    
    if [ -f "$PROGRESS_FILE" ]; then
        # æœ‰è¿›åº¦çš„æƒ…å†µ
        case $choice in
            1)
                echo -e "${GREEN}é€‰æ‹©ï¼šç»§ç»­ä¸Šæ¬¡æµ‹è¯•${NC}"
                echo ""
                START_FRESH=false
                break
                ;;
            2)
                echo -e "${YELLOW}é€‰æ‹©ï¼šå®Œå…¨é‡æ–°å¼€å§‹${NC}"
                echo ""
                clean_all_progress
                if [ $? -eq 0 ]; then
                    START_FRESH=true
                    break
                fi
                ;;
            3)
                # ä¼˜å…ˆä½¿ç”¨å¢å¼ºè¿›åº¦æ˜¾ç¤ºï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€åˆ°ä¼ ç»Ÿæ˜¾ç¤º
                if python3 -c "from enhanced_progress_manager import EnhancedProgressManager" 2>/dev/null; then
                    show_enhanced_progress
                else
                    show_progress_info
                fi
                ;;
            4)
                echo -e "${CYAN}é€‰æ‹©ï¼šè‡ªå®šä¹‰èµ·å§‹é˜¶æ®µ${NC}"
                echo ""
                show_custom_stage_menu
                ;;
            5)
                echo -e "${CYAN}é€‰æ‹©ï¼šè‡ªåŠ¨ç»´æŠ¤èœå•${NC}"
                echo ""
                # ä½¿ç”¨å¢å¼ºçš„ç»´æŠ¤èœå•
                while true; do
                    show_enhanced_maintenance_menu
                    read -r maintenance_choice
                    if handle_enhanced_maintenance_choice "$maintenance_choice"; then
                        if [ "$maintenance_choice" = "0" ]; then
                            break
                        fi
                    fi
                done
                ;;
            6)
                # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•é€‰é¡¹
                if check_failed_tests_config 2>/dev/null; then
                    echo -e "${PURPLE}é€‰æ‹©ï¼šé‡æ–°æµ‹è¯•å¤±è´¥çš„ç»„${NC}"
                    echo ""
                    show_failed_tests_rerun_menu
                else
                    echo -e "${BLUE}é€€å‡ºæµ‹è¯•ç¨‹åº${NC}"
                    exit 0
                fi
                ;;
            7)
                echo -e "${BLUE}é€€å‡ºæµ‹è¯•ç¨‹åº${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©${NC}"
                sleep 1
                ;;
        esac
    else
        # æ²¡æœ‰è¿›åº¦çš„æƒ…å†µ
        case $choice in
            1)
                echo -e "${GREEN}é€‰æ‹©ï¼šå¼€å§‹æ–°æµ‹è¯•${NC}"
                echo ""
                
                # è·å–å½“å‰æ¨¡å‹ç±»å‹çš„ç›¸å…³æ–‡ä»¶å
                progress_file=$(get_progress_file)
                completed_file=$(get_completed_file)
                db_suffix=""
                db_file="master_database.json"
                model_type_desc="å¼€æº"
                
                if [ "$MODEL_TYPE" = "closed_source" ]; then
                    db_suffix="_closed_source"
                    db_file="master_database_closed_source.json"
                    model_type_desc="é—­æº"
                fi
                
                # å¤‡ä»½ç‰¹å®šæ¨¡å‹ç±»å‹çš„ç»Ÿè®¡æ•°æ®
                if [ -f "pilot_bench_cumulative_results/$db_file" ]; then
                    backup_file="pilot_bench_cumulative_results/${db_file}.backup_$(date +%Y%m%d_%H%M%S)"
                    echo -e "${YELLOW}å¤‡ä»½${model_type_desc}æ¨¡å‹ç»Ÿè®¡æ•°æ®åˆ° $backup_file ...${NC}"
                    cp "pilot_bench_cumulative_results/$db_file" "$backup_file"
                    if [ $? -eq 0 ]; then
                        echo -e "${GREEN}âœ… ${model_type_desc}æ¨¡å‹ç»Ÿè®¡æ•°æ®å·²å¤‡ä»½${NC}"
                    else
                        echo -e "${RED}âš ï¸  å¤‡ä»½å¤±è´¥ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ(y/n)${NC}"
                        read -r continue_choice
                        if [ "$continue_choice" != "y" ] && [ "$continue_choice" != "Y" ]; then
                            echo -e "${BLUE}å·²å–æ¶ˆ${NC}"
                            continue
                        fi
                    fi
                    
                    # æ¸…ç©ºç‰¹å®šæ¨¡å‹ç±»å‹çš„æ•°æ®åº“
                    echo -e "${YELLOW}æ¸…ç©º${model_type_desc}æ¨¡å‹æ•°æ®åº“...${NC}"
                    DB_PATH="pilot_bench_cumulative_results/$db_file"
                    echo '{
  "version": "3.0",
  "created_at": "'$(date -Iseconds)'",
  "last_updated": "'$(date -Iseconds)'",
  "test_groups": {},
  "models": {},
  "summary": {
    "total_tests": 0,
    "total_success": 0,
    "total_partial": 0,
    "total_failure": 0,
    "models_tested": [],
    "last_test_time": null
  }
}' > "$DB_PATH"
                    echo -e "${GREEN}âœ… ${model_type_desc}æ¨¡å‹æ•°æ®åº“å·²æ¸…ç©º${NC}"
                else
                    # å¦‚æœæ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•å’Œç©ºæ•°æ®åº“
                    mkdir -p "pilot_bench_cumulative_results"
                    DB_PATH="pilot_bench_cumulative_results/$db_file"
                    echo '{
  "version": "3.0",
  "created_at": "'$(date -Iseconds)'",
  "last_updated": "'$(date -Iseconds)'",
  "test_groups": {},
  "models": {},
  "summary": {
    "total_tests": 0,
    "total_success": 0,
    "total_partial": 0,
    "total_failure": 0,
    "models_tested": [],
    "last_test_time": null
  }
}' > "$DB_PATH"
                    echo -e "${GREEN}âœ… åˆ›å»ºæ–°çš„${model_type_desc}æ¨¡å‹æ•°æ®åº“${NC}"
                fi
                
                # æ¸…ç†ç‰¹å®šæ¨¡å‹ç±»å‹çš„è¿›åº¦æ–‡ä»¶ä»¥å¼€å§‹æ–°æµ‹è¯•
                rm -f "$progress_file" "$completed_file" 2>/dev/null
                echo "STEP=1" > "$progress_file"
                echo "MODEL_INDEX=0" >> "$progress_file"
                echo "SUBSTEP=" >> "$progress_file"
                touch "$completed_file"
                START_FRESH=true
                break
                ;;
            2)
                echo -e "${CYAN}é€‰æ‹©ï¼šè‡ªåŠ¨ç»´æŠ¤èœå•${NC}"
                echo ""
                # ä½¿ç”¨å¢å¼ºçš„ç»´æŠ¤èœå•
                while true; do
                    show_enhanced_maintenance_menu
                    read -r maintenance_choice
                    if handle_enhanced_maintenance_choice "$maintenance_choice"; then
                        if [ "$maintenance_choice" = "0" ]; then
                            break
                        fi
                    fi
                done
                ;;
            3)
                echo -e "${BLUE}é€€å‡ºæµ‹è¯•ç¨‹åº${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©${NC}"
                sleep 1
                ;;
        esac
    fi
done

# ç¬¬äºŒå±‚èœå•ï¼šé€‰æ‹©æµ‹è¯•æ¨¡å¼
while true; do
    show_test_mode_menu
    read -r mode_choice
    
    case $mode_choice in
        1)
            echo -e "${GREEN}é€‰æ‹©ï¼šè‡ªåŠ¨æ¨¡å¼${NC}"
            echo "é˜¶æ®µå†…è¿ç»­è¿è¡Œï¼Œé˜¶æ®µé—´éœ€è¦ç¡®è®¤"
            TEST_MODE="auto"
            PAUSE_AFTER_MODEL=false
            PAUSE_AFTER_STAGE=true
            # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•éœ€è¦é‡è¯•
            check_auto_mode_failure_retry
            break
            ;;
        2)
            echo -e "${CYAN}é€‰æ‹©ï¼šè°ƒè¯•æ¨¡å¼${NC}"
            echo "æ¯ä¸ªæ¨¡å‹åæš‚åœï¼Œå¯éšæ—¶åˆ‡æ¢æ¨¡å¼"
            TEST_MODE="debug"
            PAUSE_AFTER_MODEL=true
            PAUSE_AFTER_STAGE=true
            break
            ;;
        3)
            echo -e "${YELLOW}é€‰æ‹©ï¼šå…¨è‡ªåŠ¨æ¨¡å¼${NC}"
            echo -e "${RED}âš ï¸  æ³¨æ„ï¼šå°†è¿ç»­è¿è¡Œæ‰€æœ‰11,400ä¸ªæµ‹è¯•ï¼${NC}"
            echo -e "${YELLOW}ç¡®è®¤ä½¿ç”¨å…¨è‡ªåŠ¨æ¨¡å¼ï¼Ÿ(yes/no)${NC}"
            read -r confirm
            if [ "$confirm" = "yes" ]; then
                TEST_MODE="full_auto"
                PAUSE_AFTER_MODEL=false
                PAUSE_AFTER_STAGE=false
                # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥æµ‹è¯•éœ€è¦é‡è¯•
                check_auto_mode_failure_retry
                break
            else
                echo "å–æ¶ˆå…¨è‡ªåŠ¨æ¨¡å¼"
            fi
            ;;
        4)
            echo "è¿”å›ä¸Šä¸€çº§èœå•..."
            exec "$0" "$@"  # é‡å¯è„šæœ¬
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹© [1-4]${NC}"
            sleep 1
            ;;
    esac
done

# ç¬¬ä¸‰å±‚èœå•ï¼šé€‰æ‹©å¹¶å‘ç­–ç•¥
while true; do
    show_rate_limit_menu
    read -r rate_choice
    
    case $rate_choice in
        1)
            echo -e "${CYAN}é€‰æ‹©ï¼šå›ºå®šé€Ÿç‡æ¨¡å¼ (Fixed)${NC}"
            echo "å°†ä½¿ç”¨é¢„è®¾çš„å¹¶å‘å‚æ•°"
            RATE_MODE="fixed"
            break
            ;;
        2)
            echo -e "${GREEN}é€‰æ‹©ï¼šè‡ªé€‚åº”æ¨¡å¼ (Adaptive)${NC}"
            echo "å°†æ ¹æ®APIå“åº”è‡ªåŠ¨è°ƒæ•´å¹¶å‘æ•°å’ŒQPS"
            RATE_MODE="adaptive"
            break
            ;;
        3)
            echo -e "${RED}é€‰æ‹©ï¼šè¶…é«˜å¹¶è¡Œæ¨¡å¼ (Ultra Parallel)${NC}"
            echo "ğŸ”¥ å°†ä½¿ç”¨å¤šAzureå®ä¾‹å¹¶è¡Œï¼Œç†è®ºåŠ é€Ÿ3-6å€"
            echo "âš ï¸  ä»…æ”¯æŒDeepSeekã€Llama-3.3å’ŒQwenæ¨¡å‹"
            ULTRA_PARALLEL_MODE=true
            
            # è¯¢é—®é€Ÿç‡æ¨¡å¼
            echo ""
            echo -e "${YELLOW}é€‰æ‹©è¶…é«˜å¹¶å‘çš„é€Ÿç‡æ¨¡å¼:${NC}"
            echo "  1) ğŸ”§ å›ºå®šé€Ÿç‡ (Fixed) - ç¨³å®šå¯é¢„æµ‹ â­ æ¨è"
            echo "     â–ª å¼€æºæ¨¡å‹åˆ†ç‰‡: Azure 50 workers/prompt, IdealLab 5 workers"
            echo "     â–ª é—­æºæ¨¡å‹å•å®ä¾‹: Azure 100 workers/prompt, IdealLab 5 workers"
            echo "  2) ğŸ¯ è‡ªé€‚åº”æ¨¡å¼ (Adaptive) - åŠ¨æ€è°ƒæ•´"
            echo "     â–ª å¼€æºæ¨¡å‹åˆ†ç‰‡: Azure 100 workers/prompt, IdealLab 10 workers"
            echo "     â–ª é—­æºæ¨¡å‹å•å®ä¾‹: Azure 100 workers/prompt, IdealLab 5 workers"
            echo ""
            echo -e "${YELLOW}è¯·é€‰æ‹© [1-2]:${NC}"
            read -r ultra_rate_choice
            
            case $ultra_rate_choice in
                1)
                    RATE_MODE="fixed"
                    echo -e "${GREEN}âœ… è¶…é«˜å¹¶å‘ä½¿ç”¨å›ºå®šé€Ÿç‡æ¨¡å¼${NC}"
                    ;;
                2)
                    RATE_MODE="adaptive"
                    echo -e "${GREEN}âœ… è¶…é«˜å¹¶å‘ä½¿ç”¨è‡ªé€‚åº”æ¨¡å¼${NC}"
                    ;;
                *)
                    RATE_MODE="fixed"
                    echo -e "${YELLOW}é»˜è®¤ä½¿ç”¨å›ºå®šé€Ÿç‡æ¨¡å¼${NC}"
                    ;;
            esac
            break
            ;;
        4)
            echo -e "${YELLOW}é€‰æ‹©ï¼šè‡ªå®šä¹‰é€Ÿç‡${NC}"
            echo ""
            echo -e "${YELLOW}è¾“å…¥å¹¶å‘æ•° (1-100):${NC}"
            read -r custom_workers
            if [[ "$custom_workers" =~ ^[0-9]+$ ]] && [ "$custom_workers" -ge 1 ] && [ "$custom_workers" -le 100 ]; then
                CUSTOM_WORKERS=$custom_workers
            else
                echo -e "${RED}æ— æ•ˆçš„å¹¶å‘æ•°ï¼Œä½¿ç”¨é»˜è®¤10${NC}"
                CUSTOM_WORKERS=10
            fi
            
            echo -e "${YELLOW}è¾“å…¥QPS (1-200):${NC}"
            read -r custom_qps
            if [[ "$custom_qps" =~ ^[0-9]+\.?[0-9]*$ ]]; then
                CUSTOM_QPS=$custom_qps
            else
                echo -e "${RED}æ— æ•ˆçš„QPSï¼Œä½¿ç”¨é»˜è®¤20${NC}"
                CUSTOM_QPS=20
            fi
            
            echo -e "${GREEN}è‡ªå®šä¹‰å‚æ•°ï¼šworkers=${CUSTOM_WORKERS}, QPS=${CUSTOM_QPS}${NC}"
            RATE_MODE="custom"
            break
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹© [1-3]${NC}"
            sleep 1
            ;;
    esac
done

# ç¬¬å››å±‚èœå•ï¼šé€‰æ‹©Checkpointç­–ç•¥
while true; do
    show_checkpoint_menu
    read -r checkpoint_choice
    
    case $checkpoint_choice in
        1)
            echo -e "${GREEN}é€‰æ‹©ï¼šå¿«é€Ÿæ¨¡å¼ï¼ˆæ¯10ä¸ªæµ‹è¯•ä¿å­˜ï¼‰${NC}"
            CHECKPOINT_INTERVAL=10
            break
            ;;
        2)
            echo -e "${GREEN}é€‰æ‹©ï¼šæ ‡å‡†æ¨¡å¼ï¼ˆæ¯20ä¸ªæµ‹è¯•ä¿å­˜ï¼‰${NC}"
            CHECKPOINT_INTERVAL=20
            break
            ;;
        3)
            echo -e "${YELLOW}é€‰æ‹©ï¼šæ€§èƒ½æ¨¡å¼ï¼ˆæ¯50ä¸ªæµ‹è¯•ä¿å­˜ï¼‰${NC}"
            CHECKPOINT_INTERVAL=50
            break
            ;;
        4)
            echo -e "${CYAN}é€‰æ‹©ï¼šå®‰å…¨æ¨¡å¼ï¼ˆæ¯5ä¸ªæµ‹è¯•ä¿å­˜ï¼‰${NC}"
            CHECKPOINT_INTERVAL=5
            break
            ;;
        5)
            echo -e "${YELLOW}é€‰æ‹©ï¼šè‡ªå®šä¹‰é—´éš”${NC}"
            echo ""
            echo -e "${YELLOW}è¾“å…¥ä¿å­˜é—´éš” (1-100):${NC}"
            read -r custom_interval
            if [[ "$custom_interval" =~ ^[0-9]+$ ]] && [ "$custom_interval" -ge 1 ] && [ "$custom_interval" -le 100 ]; then
                CHECKPOINT_INTERVAL=$custom_interval
                echo -e "${GREEN}è‡ªå®šä¹‰Checkpointé—´éš”ï¼šæ¯${CHECKPOINT_INTERVAL}ä¸ªæµ‹è¯•ä¿å­˜${NC}"
            else
                echo -e "${RED}æ— æ•ˆçš„é—´éš”ï¼Œä½¿ç”¨é»˜è®¤20${NC}"
                CHECKPOINT_INTERVAL=20
            fi
            break
            ;;
        6)
            echo -e "${RED}é€‰æ‹©ï¼šç¦ç”¨Checkpointï¼ˆä»…æœ€åä¿å­˜ï¼‰${NC}"
            echo -e "${RED}âš ï¸  è­¦å‘Šï¼šä¸­æ–­æµ‹è¯•å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„ç»“æœï¼${NC}"
            echo -e "${YELLOW}ç¡®è®¤ç¦ç”¨Checkpointï¼Ÿ(yes/no)${NC}"
            read -r confirm
            if [ "$confirm" = "yes" ]; then
                CHECKPOINT_INTERVAL=0
                echo -e "${RED}Checkpointå·²ç¦ç”¨${NC}"
            else
                echo "ä½¿ç”¨é»˜è®¤è®¾ç½®ï¼ˆæ¯20ä¸ªæµ‹è¯•ä¿å­˜ï¼‰"
                CHECKPOINT_INTERVAL=20
            fi
            break
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹© [1-6]${NC}"
            sleep 1
            ;;
    esac
done

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}å¼€å§‹æµ‹è¯•æµç¨‹...${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
if [ "$CHECKPOINT_INTERVAL" -gt 0 ]; then
    echo -e "${CYAN}ğŸ’¾ Checkpointæœºåˆ¶å·²å¯ç”¨ï¼š${NC}"
    echo -e "${CYAN}   - æ¯${CHECKPOINT_INTERVAL}ä¸ªæµ‹è¯•è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡${NC}"
    echo -e "${CYAN}   - ä¸­æ–­åå¯ä»¥ä»ä¸Šæ¬¡ä¿å­˜ç‚¹ç»§ç»­${NC}"
    echo -e "${CYAN}   - é¿å…å› æ„å¤–ä¸­æ–­ä¸¢å¤±å¤§é‡ç»“æœ${NC}"
else
    echo -e "${RED}âš ï¸  Checkpointå·²ç¦ç”¨ï¼š${NC}"
    echo -e "${RED}   - ä»…åœ¨æµ‹è¯•å®Œå…¨ç»“æŸåä¿å­˜${NC}"
    echo -e "${RED}   - ä¸­æ–­å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„ç»“æœ${NC}"
    echo -e "${RED}   - è¯·ç¡®ä¿æµ‹è¯•ç¯å¢ƒç¨³å®š${NC}"
fi
echo ""
sleep 1

# æ¨¡å‹åˆ—è¡¨å·²ç»åœ¨è„šæœ¬å¼€å¤´å®šä¹‰ï¼Œåˆ é™¤æ­¤å¤„çš„é‡å¤å®šä¹‰

# DeepSeekå¹¶è¡Œå®ä¾‹ç»„ï¼ˆåˆ©ç”¨Azureå¤šéƒ¨ç½²åŠ é€Ÿï¼‰- 6ä¸ªå®ä¾‹
DEEPSEEK_PARALLEL_GROUP=(
    "DeepSeek-V3-0324"      # V3åŸå§‹å®ä¾‹ï¼ˆæ— åç¼€ï¼‰
    "deepseek-v3-0324-2"    # V3å¹¶è¡Œå®ä¾‹2
    "deepseek-v3-0324-3"    # V3å¹¶è¡Œå®ä¾‹3
    "DeepSeek-R1-0528"      # R1åŸå§‹å®ä¾‹ï¼ˆæ— åç¼€ï¼‰
    "deepseek-r1-0528-2"    # R1å¹¶è¡Œå®ä¾‹2
    "deepseek-r1-0528-3"    # R1å¹¶è¡Œå®ä¾‹3
)

# Llama-3.3å¹¶è¡Œå®ä¾‹ç»„ï¼ˆåˆ©ç”¨Azureå¤šéƒ¨ç½²åŠ é€Ÿï¼‰- 3ä¸ªå®ä¾‹
LLAMA_PARALLEL_GROUP=(
    "Llama-3.3-70B-Instruct"    # åŸå§‹å®ä¾‹ï¼ˆæ— åç¼€ï¼‰
    "llama-3.3-70b-instruct-2"  # å¹¶è¡Œå®ä¾‹2
    "llama-3.3-70b-instruct-3"  # å¹¶è¡Œå®ä¾‹3
)

# 7ç§ç¼ºé™·ç±»å‹
FLAW_TYPES=(
    "flawed_sequence_disorder"
    "flawed_tool_misuse"
    "flawed_parameter_error"
    "flawed_missing_step"
    "flawed_redundant_operations"
    "flawed_logical_inconsistency"
    "flawed_semantic_drift"
)

# å·¥å…·æˆåŠŸç‡è®¾ç½®
TOOL_RELIABILITIES=(
    "0.9"
    "0.7"
    "0.6"
)

# æç¤ºç±»å‹ï¼ˆoptimalå·²åœ¨5.1æµ‹è¯•ï¼‰
PROMPT_TYPES=(
    "baseline"
    "cot"
)

# æ¨¡å‹ç±»å‹é€‰æ‹©å˜é‡

# æ ¹æ®æ¨¡å‹ç±»å‹è·å–å¹¶å‘ç­–ç•¥å‚æ•°
get_concurrency_params() {
    local model=$1
    local base_params="$2"
    
    if [ "$MODEL_TYPE" = "closed_source" ]; then
        # é—­æºæ¨¡å‹ä½¿ç”¨ä¸åŒçš„å¹¶å‘ç­–ç•¥
        case $model in
            "gpt-4o-mini"|"gpt-5-mini"|"grok-3-mini")
                # Azureæ¨¡å‹ï¼šé«˜tokené™åˆ¶ï¼Œ100å¹¶å‘ï¼Œæ— QPSé™åˆ¶
                echo "$base_params --max-workers 100 --max-prompt-workers 5"
                ;;
            "claude_sonnet4"|"o3-0416-global"|"gemini-2.5-flash-06-17")
                # IdealLabé—­æºæ¨¡å‹ï¼šå•keyé™åˆ¶ï¼Œä¿å®ˆ5å¹¶å‘
                echo "$base_params --max-workers 5 --max-prompt-workers 1"
                ;;
            *)
                # é»˜è®¤ç­–ç•¥
                echo "$base_params --max-workers 10"
                ;;
        esac
    else
        # å¼€æºæ¨¡å‹ä½¿ç”¨åŸæœ‰ç­–ç•¥
        echo "$base_params"
    fi
}

# è¿›åº¦æ–‡ä»¶ (å·²åœ¨é¡¶éƒ¨å®šä¹‰)

# ============================================
# è¾…åŠ©å‡½æ•°
# ============================================

# åˆå§‹åŒ–è¿›åº¦æ–‡ä»¶
init_progress() {
    if [ ! -f "$PROGRESS_FILE" ]; then
        echo "STEP=1" > "$PROGRESS_FILE"
        echo "MODEL_INDEX=0" >> "$PROGRESS_FILE"
        echo "SUBSTEP=" >> "$PROGRESS_FILE"
    fi
    
    if [ ! -f "$COMPLETED_FILE" ]; then
        touch "$COMPLETED_FILE"
    fi
}

# è¯»å–å½“å‰è¿›åº¦
load_progress() {
    source "$PROGRESS_FILE"
}

# æ›´æ–°è¿›åº¦
update_progress() {
    local step=$1
    local model_idx=$2
    local substep=$3
    
    echo "STEP=$step" > "$PROGRESS_FILE"
    echo "MODEL_INDEX=$model_idx" >> "$PROGRESS_FILE"
    echo "SUBSTEP=$substep" >> "$PROGRESS_FILE"
}

# æ£€æŸ¥æµ‹è¯•æ˜¯å¦å·²å®Œæˆï¼ˆé…ç½®çº§åˆ«ï¼‰
is_config_completed() {
    local test_id=$1
    grep -q "^$test_id$" "$COMPLETED_FILE"
    return $?
}

# æ ‡è®°æµ‹è¯•å®Œæˆï¼ˆé…ç½®çº§åˆ«ï¼‰
mark_config_completed() {
    local test_id=$1
    echo "$test_id" >> "$COMPLETED_FILE"
}

# ç”¨æˆ·ç¡®è®¤å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰å®ä¾‹æ•°ï¼‰
confirm_continue() {
    if [ "$PAUSE_AFTER_STAGE" = false ]; then
        # å…¨è‡ªåŠ¨æ¨¡å¼ï¼Œä¸æš‚åœ
        echo -e "${GREEN}[å…¨è‡ªåŠ¨æ¨¡å¼] $1${NC}"
        echo "è‡ªåŠ¨ç»§ç»­..."
        sleep 1  # çŸ­æš‚å»¶è¿Ÿä»¥ä¾¿æŸ¥çœ‹ä¿¡æ¯
    else
        # éœ€è¦ç¡®è®¤
        echo -e "${YELLOW}$1${NC}"
        echo ""
        
        # è¯¢é—®æ˜¯å¦è¦è‡ªå®šä¹‰å®ä¾‹æ•°
        echo -e "${CYAN}å½“å‰å®ä¾‹æ•°é…ç½®: ${NUM_INSTANCES}${NC}"
        if [ -n "$INSTANCES_PER_TASK" ]; then
            echo -e "${CYAN}  æ¯å®ä¾‹ä»»åŠ¡æ•°: ${INSTANCES_PER_TASK}${NC}"
        fi
        echo ""
        echo -e "${YELLOW}æ˜¯å¦è¦ä¿®æ”¹å®ä¾‹æ•°é…ç½®ï¼Ÿ${NC}"
        echo "  1) ä½¿ç”¨å½“å‰é…ç½® (${NUM_INSTANCES})"
        echo "  2) å¿«é€Ÿæµ‹è¯• (2ä¸ªå®ä¾‹)"
        echo "  3) å°è§„æ¨¡æµ‹è¯• (5ä¸ªå®ä¾‹)"
        echo "  4) ä¸­ç­‰è§„æ¨¡ (10ä¸ªå®ä¾‹)"
        echo "  5) å¤§è§„æ¨¡æµ‹è¯• (20ä¸ªå®ä¾‹)"
        echo "  6) å®Œæ•´æµ‹è¯• (100ä¸ªå®ä¾‹)"
        echo "  7) è‡ªå®šä¹‰æ•°é‡"
        echo "  8) çŸ©é˜µæ¨¡å¼ (NxTæ ¼å¼)"
        echo ""
        echo -e "${YELLOW}è¯·é€‰æ‹© [1-8] (é»˜è®¤: 1):${NC}"
        
        read -r instance_choice
        
        # å¦‚æœç”¨æˆ·ç›´æ¥æŒ‰Enterï¼Œä½¿ç”¨é»˜è®¤å€¼
        if [ -z "$instance_choice" ]; then
            instance_choice="1"
        fi
        
        case $instance_choice in
            1)
                echo -e "${GREEN}âœ“ ä½¿ç”¨å½“å‰é…ç½®: ${NUM_INSTANCES}${NC}"
                ;;
            2)
                NUM_INSTANCES=2
                INSTANCES_PER_TASK=""
                echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºå¿«é€Ÿæµ‹è¯•: 2ä¸ªå®ä¾‹${NC}"
                ;;
            3)
                NUM_INSTANCES=5
                INSTANCES_PER_TASK=""
                echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºå°è§„æ¨¡æµ‹è¯•: 5ä¸ªå®ä¾‹${NC}"
                ;;
            4)
                NUM_INSTANCES=10
                INSTANCES_PER_TASK=""
                echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºä¸­ç­‰è§„æ¨¡: 10ä¸ªå®ä¾‹${NC}"
                ;;
            5)
                NUM_INSTANCES=20
                INSTANCES_PER_TASK=""
                echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºå¤§è§„æ¨¡æµ‹è¯•: 20ä¸ªå®ä¾‹${NC}"
                ;;
            6)
                NUM_INSTANCES=100
                INSTANCES_PER_TASK=""
                echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºå®Œæ•´æµ‹è¯•: 100ä¸ªå®ä¾‹${NC}"
                ;;
            7)
                echo -e "${CYAN}è¯·è¾“å…¥è‡ªå®šä¹‰å®ä¾‹æ•°:${NC}"
                read -r custom_num
                if [[ "$custom_num" =~ ^[0-9]+$ ]]; then
                    NUM_INSTANCES="$custom_num"
                    INSTANCES_PER_TASK=""
                    echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºè‡ªå®šä¹‰: ${NUM_INSTANCES}ä¸ªå®ä¾‹${NC}"
                else
                    echo -e "${YELLOW}âš ï¸ æ— æ•ˆè¾“å…¥ï¼Œä¿æŒåŸé…ç½®: ${NUM_INSTANCES}${NC}"
                fi
                ;;
            8)
                echo -e "${CYAN}çŸ©é˜µæ¨¡å¼é…ç½® (NxT: Nä¸ªå®ä¾‹ï¼Œæ¯ä¸ªTç§ä»»åŠ¡ç±»å‹)${NC}"
                echo -e "${CYAN}è¯·è¾“å…¥å®ä¾‹æ•° (N):${NC}"
                read -r matrix_num
                echo -e "${CYAN}è¯·è¾“å…¥æ¯å®ä¾‹ä»»åŠ¡æ•° (T) [1-5]:${NC}"
                echo "  1 = simple_task"
                echo "  2 = simple_task, basic_task"
                echo "  3 = simple_task, basic_task, data_pipeline"
                echo "  4 = simple_task, basic_task, data_pipeline, api_integration"
                echo "  5 = æ‰€æœ‰ä»»åŠ¡ç±»å‹"
                read -r matrix_tasks
                
                if [[ "$matrix_num" =~ ^[0-9]+$ ]] && [[ "$matrix_tasks" =~ ^[1-5]$ ]]; then
                    NUM_INSTANCES="$matrix_num"
                    INSTANCES_PER_TASK="$matrix_tasks"
                    echo -e "${GREEN}âœ“ è®¾ç½®ä¸ºçŸ©é˜µæ¨¡å¼: ${NUM_INSTANCES}Ã—${INSTANCES_PER_TASK}${NC}"
                else
                    echo -e "${YELLOW}âš ï¸ æ— æ•ˆè¾“å…¥ï¼Œä¿æŒåŸé…ç½®: ${NUM_INSTANCES}${NC}"
                fi
                ;;
            *)
                echo -e "${GREEN}âœ“ ä½¿ç”¨å½“å‰é…ç½®: ${NUM_INSTANCES}${NC}"
                ;;
        esac
        
        echo ""
        echo -e "${YELLOW}æŒ‰Enterç»§ç»­ï¼ŒæŒ‰Ctrl+Cé€€å‡º...${NC}"
        read -r
    fi
}

# è°ƒè¯•æ¨¡å¼ä¸‹çš„æ¨¡å‹é—´æš‚åœå‡½æ•°
debug_pause_after_model() {
    local model="$1"
    local step_name="$2"
    
    if [ "$PAUSE_AFTER_MODEL" = true ]; then
        echo ""
        echo -e "${CYAN}========================================${NC}"
        echo -e "${CYAN}ğŸ” è°ƒè¯•æ¨¡å¼ - æ¨¡å‹æµ‹è¯•å®Œæˆ${NC}"
        echo -e "${CYAN}========================================${NC}"
        echo ""
        echo -e "æ¨¡å‹: ${GREEN}$model${NC}"
        echo -e "æµ‹è¯•é˜¶æ®µ: ${GREEN}$step_name${NC}"
        echo ""
        
        # æ˜¾ç¤ºç®€è¦ç»Ÿè®¡
        echo "ğŸ“Š ç®€è¦ç»Ÿè®¡ï¼š"
        python -c "
import json
import sys
from pathlib import Path

db_path = Path('pilot_bench_cumulative_results/master_database.json')
if db_path.exists():
    with open(db_path, 'r') as f:
        db = json.load(f)
    
    model_name = '$model'
    if model_name in db.get('models', {}):
        model_data = db['models'][model_name]
        overall = model_data.get('overall_stats', {})
        print(f'  æ€»æµ‹è¯•æ•°: {overall.get(\"total_tests\", 0)}')
        print(f'  æˆåŠŸç‡: {overall.get(\"success_rate\", 0):.1%}')
        print(f'  å¹³å‡æ‰§è¡Œæ—¶é—´: {overall.get(\"avg_execution_time\", 0):.2f}s')
else:
    print('  æš‚æ— ç»Ÿè®¡æ•°æ®')
" 2>/dev/null || echo "  æ— æ³•è·å–ç»Ÿè®¡æ•°æ®"
        
        echo ""
        echo -e "${YELLOW}é€‰é¡¹ï¼š${NC}"
        echo "  1) ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å‹ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰"
        echo "  2) åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼ï¼ˆä¸å†æš‚åœï¼‰"
        echo "  3) æŸ¥çœ‹è¯¦ç»†ç»“æœ"
        echo "  4) é€€å‡ºæµ‹è¯•"
        echo ""
        echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [1-4]:${NC}"
        
        while true; do
            read -r debug_choice
            case $debug_choice in
                1)
                    echo -e "${GREEN}ç»§ç»­è°ƒè¯•æ¨¡å¼...${NC}"
                    break
                    ;;
                2)
                    echo -e "${GREEN}åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼...${NC}"
                    PAUSE_AFTER_MODEL=false
                    TEST_MODE="auto"
                    break
                    ;;
                3)
                    echo ""
                    echo "è¯¦ç»†ç»“æœï¼š"
                    python -c "
import json
from pathlib import Path

db_path = Path('pilot_bench_cumulative_results/master_database.json')
if db_path.exists():
    with open(db_path, 'r') as f:
        db = json.load(f)
    
    model_name = '$model'
    if model_name in db.get('models', {}):
        model_data = db['models'][model_name]
        print(f'æ¨¡å‹: {model_name}')
        print('-' * 40)
        
        # æ˜¾ç¤ºæŒ‰prompt_typeçš„ç»Ÿè®¡
        if 'by_prompt_type' in model_data:
            for prompt_type, prompt_data in model_data['by_prompt_type'].items():
                stats = prompt_data.get('overall_stats', {})
                print(f'{prompt_type}:')
                print(f'  æµ‹è¯•æ•°: {stats.get(\"total_tests\", 0)}')
                print(f'  æˆåŠŸç‡: {stats.get(\"success_rate\", 0):.1%}')
" 2>/dev/null || echo "æ— æ³•è·å–è¯¦ç»†ç»“æœ"
                    echo ""
                    echo -e "${YELLOW}æŒ‰Enterè¿”å›é€‰é¡¹èœå•...${NC}"
                    read -r
                    echo ""
                    echo -e "${YELLOW}é€‰é¡¹ï¼š${NC}"
                    echo "  1) ç»§ç»­ä¸‹ä¸€ä¸ªæ¨¡å‹ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰"
                    echo "  2) åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼ï¼ˆä¸å†æš‚åœï¼‰"
                    echo "  3) æŸ¥çœ‹è¯¦ç»†ç»“æœ"
                    echo "  4) é€€å‡ºæµ‹è¯•"
                    echo ""
                    echo -e "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [1-4]:${NC}"
                    ;;
                4)
                    echo -e "${YELLOW}é€€å‡ºæµ‹è¯•...${NC}"
                    exit 0
                    ;;
                *)
                    echo -e "${RED}æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹© [1-4]${NC}"
                    ;;
            esac
        done
    fi
}

# æ˜¾ç¤ºè¿›åº¦ç»Ÿè®¡
show_progress_stats() {
    local step=$1
    local completed=$2
    local total=$3
    
    echo -e "${CYAN}[æ­¥éª¤ $step è¿›åº¦: $completed/$total]${NC}"
}


# å¹¶è¡ŒDeepSeekæµ‹è¯•å‡½æ•°ï¼ˆåˆ©ç”¨Azureå¤šéƒ¨ç½²ï¼‰
run_deepseek_parallel_test() {
    local prompt_types=$1
    local difficulty=$2
    local task_types=$3
    local num_instances=$4
    
    echo -e "${CYAN}ğŸš€ å¯åŠ¨DeepSeekå¹¶è¡Œæµ‹è¯•${NC}"
    echo "Prompt types: $prompt_types"
    echo "éš¾åº¦: $difficulty"
    echo "å®ä¾‹æ•°: $num_instances"
    echo ""
    
    local pids=()
    
    # å¹¶è¡Œå¯åŠ¨æ‰€æœ‰DeepSeekå®ä¾‹
    for model in "${DEEPSEEK_PARALLEL_GROUP[@]}"; do
        echo -e "${GREEN}â–¶ å¯åŠ¨ $model æµ‹è¯•...${NC}"
        
        # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­ç”Ÿæ•ˆ
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        python3 smart_batch_runner.py \
            --model "$model" \
            --prompt-types "$prompt_types" \
            --difficulty "$difficulty" \
            --task-types "$task_types" \
            --num-instances "$num_instances" \
            --max-workers 100 \
            --adaptive \
            --prompt-parallel \
            --batch-commit \
            --checkpoint-interval 20 \
            --ai-classification \
            --save-logs &
        
        pids+=($!)
        
        # çŸ­æš‚å»¶è¿Ÿé¿å…ç¬æ—¶å³°å€¼
        sleep 2
    done
    
    echo -e "${YELLOW}ç­‰å¾…æ‰€æœ‰DeepSeekå®ä¾‹å®Œæˆ...${NC}"
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    local failed=false
    for pid in "${pids[@]}"; do
        if ! wait "$pid"; then
            echo -e "${RED}âŒ è¿›ç¨‹ $pid å¤±è´¥${NC}"
            failed=true
        fi
    done
    
    if [ "$failed" = false ]; then
        echo -e "${GREEN}âœ… æ‰€æœ‰DeepSeekå¹¶è¡Œæµ‹è¯•å®Œæˆ${NC}"
        return 0
    else
        echo -e "${RED}âŒ éƒ¨åˆ†DeepSeekæµ‹è¯•å¤±è´¥${NC}"
        return 1
    fi
}

# å¹¶è¡ŒLlamaæµ‹è¯•å‡½æ•°ï¼ˆåˆ©ç”¨Azureå¤šéƒ¨ç½²ï¼‰
run_llama_parallel_test() {
    local prompt_types=$1
    local difficulty=$2
    local task_types=$3
    local num_instances=$4
    
    echo -e "${CYAN}ğŸš€ å¯åŠ¨Llama-3.3å¹¶è¡Œæµ‹è¯•${NC}"
    echo "Prompt types: $prompt_types"
    echo "éš¾åº¦: $difficulty"
    echo "å®ä¾‹æ•°: $num_instances"
    echo ""
    
    local pids=()
    
    # å¹¶è¡Œå¯åŠ¨æ‰€æœ‰Llamaå®ä¾‹
    for model in "${LLAMA_PARALLEL_GROUP[@]}"; do
        echo -e "${GREEN}â–¶ å¯åŠ¨ $model æµ‹è¯•...${NC}"
        
        # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­ç”Ÿæ•ˆ
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        python3 smart_batch_runner.py \
            --model "$model" \
            --prompt-types "$prompt_types" \
            --difficulty "$difficulty" \
            --task-types "$task_types" \
            --num-instances "$num_instances" \
            --max-workers 100 \
            --adaptive \
            --prompt-parallel \
            --batch-commit \
            --checkpoint-interval 20 \
            --ai-classification \
            --save-logs &
        
        pids+=($!)
        
        # çŸ­æš‚å»¶è¿Ÿé¿å…ç¬æ—¶å³°å€¼
        sleep 2
    done
    
    echo -e "${YELLOW}ç­‰å¾…æ‰€æœ‰Llamaå®ä¾‹å®Œæˆ...${NC}"
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    local failed=false
    for pid in "${pids[@]}"; do
        if ! wait "$pid"; then
            echo -e "${RED}âŒ è¿›ç¨‹ $pid å¤±è´¥${NC}"
            failed=true
        fi
    done
    
    if [ "$failed" = false ]; then
        echo -e "${GREEN}âœ… æ‰€æœ‰Llamaå¹¶è¡Œæµ‹è¯•å®Œæˆ${NC}"
        return 0
    else
        echo -e "${RED}âŒ éƒ¨åˆ†Llamaæµ‹è¯•å¤±è´¥${NC}"
        return 1
    fi
}

# æ™ºèƒ½æµ‹è¯•è¿è¡Œå‡½æ•°ï¼ˆä½¿ç”¨smart_batch_runner.py - æ”¯æŒå¤špromptå¹¶è¡Œï¼‰
run_smart_test() {
    # ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’åˆ°Pythonè„šæœ¬
    export STORAGE_FORMAT="${STORAGE_FORMAT}"
    
    local model=$1
    local prompt_types=$2
    local difficulty=$3
    local task_types=$4
    local num_instances=$5
    local description=$6
    local extra_args=$7
    local test_id="${model}_${prompt_types}_${difficulty}"
    
    # å¤„ç†è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹å®ä¾‹åˆ†é…
    local actual_task_types="$task_types"
    local actual_instances="$num_instances"
    
    if [ -n "$INSTANCES_PER_TASK" ] && [ "$task_types" = "all" ]; then
        # å¦‚æœæŒ‡å®šäº†æ¯ç§ä»»åŠ¡ç±»å‹çš„å®ä¾‹æ•°ï¼Œåˆ™é™åˆ¶ä»»åŠ¡ç±»å‹æ•°é‡
        # all = simple_task,basic_task,data_pipeline,api_integration,multi_stage_pipeline (5ç§)
        case "$INSTANCES_PER_TASK" in
            1)
                actual_task_types="simple_task"
                actual_instances="$NUM_INSTANCES"
                ;;
            2)
                actual_task_types="simple_task,basic_task"
                actual_instances="$NUM_INSTANCES"
                ;;
            3)
                actual_task_types="simple_task,basic_task,data_pipeline"
                actual_instances="$NUM_INSTANCES"
                ;;
            4)
                actual_task_types="simple_task,basic_task,data_pipeline,api_integration"
                actual_instances="$NUM_INSTANCES"
                ;;
            5|*)
                actual_task_types="all"
                actual_instances="$NUM_INSTANCES"
                ;;
        esac
        echo -e "  ${CYAN}ğŸ“¦ ä»»åŠ¡ç±»å‹åˆ†é…: $actual_task_types (${NUM_INSTANCES}Ã—${INSTANCES_PER_TASK})${NC}"
    fi
    
    # æ£€æŸ¥é…ç½®çº§åˆ«æ˜¯å¦å·²å®Œæˆ
    if is_config_completed "$test_id"; then
        echo -e "${BLUE}âŠ™ $model - $description å·²æ ‡è®°å®Œæˆï¼Œæ£€æŸ¥ç»†ç²’åº¦...${NC}"
    fi
    
    echo -e "${GREEN}â–¶ å¼€å§‹æµ‹è¯•: $model${NC}"
    echo "  é…ç½®: $description"
    echo "  Promptç±»å‹: $prompt_types"
    echo "  éš¾åº¦: $difficulty"
    echo "  ä»»åŠ¡ç±»å‹: $actual_task_types"
    echo "  å®ä¾‹æ•°: $actual_instances"
    
    # æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨å¤špromptå¹¶è¡Œ
    local use_prompt_parallel=""
    if [[ "$prompt_types" == *","* ]] || [[ "$prompt_types" == "all" ]]; then
        use_prompt_parallel="--prompt-parallel"
        echo -e "${CYAN}  ğŸ“¦ å¯ç”¨å¤šPromptå¹¶è¡Œæ¨¡å¼${NC}"
        
        # æ ¹æ®æ¨¡å‹ç±»å‹æ˜¾ç¤ºå¹¶è¡Œç­–ç•¥
        if [[ "$model" == *"qwen"* ]]; then
            echo -e "${YELLOW}    IdealLab: æ¯ä¸ªprompt typeä½¿ç”¨ä¸åŒAPI key${NC}"
        elif [[ "$model" == *"DeepSeek"* ]] || [[ "$model" == *"Llama-3.3"* ]]; then
            echo -e "${GREEN}    Azure: æ‰€æœ‰prompt typesåŒæ—¶é«˜å¹¶å‘${NC}"
        fi
    fi
    
    # è®¡ç®—promptæ•°é‡ï¼ˆç”¨äºåŠ¨æ€è°ƒæ•´Azure workersï¼‰
    local prompt_count=1
    if [[ "$prompt_types" == *","* ]]; then
        # è®¡ç®—é€—å·åˆ†éš”çš„promptæ•°é‡
        prompt_count=$(echo "$prompt_types" | tr ',' '\n' | wc -l | tr -d ' ')
    elif [[ "$prompt_types" == "all" ]]; then
        # allè¡¨ç¤ºæ‰€æœ‰promptç±»å‹ï¼ˆé€šå¸¸æ˜¯3ä¸ªï¼šbaseline, cot, optimalï¼‰
        prompt_count=3
    fi
    
    # æ ¹æ®æ¨¡å‹å’Œrateæ¨¡å¼å†³å®šå¹¶å‘æ•°
    local max_workers=10
    local qps=20
    local adaptive_flag="--adaptive"
    
    if [[ "$RATE_MODE" == "custom" ]]; then
        # ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°
        max_workers=$CUSTOM_WORKERS
        qps=$CUSTOM_QPS
        adaptive_flag="--no-adaptive --qps $qps"
        echo -e "${CYAN}  ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°: workers=${max_workers}, QPS=${qps}${NC}"
    elif [[ "$RATE_MODE" == "fixed" ]]; then
        # ä½¿ç”¨å›ºå®šé€Ÿç‡ - ä¿å®ˆå‚æ•°ï¼Œç¨³å®šè¿è¡Œ
        adaptive_flag="--no-adaptive"
        if [ "$MODEL_TYPE" = "closed_source" ]; then
            # é—­æºæ¨¡å‹å›ºå®šé€Ÿç‡ï¼ˆä¿å®ˆå‚æ•°ï¼‰
            case $model in
                "gpt-4o-mini"|"gpt-5-mini"|"grok-3-mini")
                    # Azureé—­æºæ¨¡å‹ï¼šæ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œæ¯ä¸ªpromptä½¿ç”¨100 workers
                    if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                        max_workers=$((100 * prompt_count))  # æ¯ä¸ªprompt 100 workers
                        echo -e "${GREEN}  Azureé—­æºAPIå›ºå®šé€Ÿç‡(${prompt_count}ä¸ªpromptå¹¶å‘): workers=${max_workers}, QPS=400${NC}"
                    else
                        max_workers=100  # å•prompt 100å¹¶å‘
                        echo -e "${GREEN}  Azureé—­æºAPIå›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=400${NC}"
                    fi
                    qps=400  # é«˜QPSæ— é™åˆ¶
                    ;;
                "claude_sonnet4"|"o3-0416-global"|"gemini-2.5-flash-06-17"|"kimi-k2")
                    # IdealLabé—­æºæ¨¡å‹ï¼šæœ‰é€Ÿç‡é™åˆ¶ï¼Œæœ€å¤š5 workers
                    if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                        max_workers=$((5 * prompt_count))  # æ¯ä¸ªprompt 5 workers
                        echo -e "${YELLOW}  IdealLabé—­æºAPIå›ºå®šé€Ÿç‡(${prompt_count}ä¸ªpromptå¹¶å‘): workers=${max_workers}, QPS=10${NC}"
                    else
                        max_workers=5  # å•prompt 5å¹¶å‘
                        echo -e "${YELLOW}  IdealLabé—­æºAPIå›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=10${NC}"
                    fi
                    qps=10  # ä¿å®ˆQPS
                    ;;
                *)
                    max_workers=5  # å›ºå®šæ¨¡å¼ï¼šä¿å®ˆ5å¹¶å‘
                    qps=10  # å›ºå®šæ¨¡å¼ï¼šä¿å®ˆQPS
                    echo -e "${CYAN}  é»˜è®¤å›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=${qps}${NC}"
                    ;;
            esac
        else
            # å¼€æºæ¨¡å‹å›ºå®šé€Ÿç‡ï¼ˆä¿å®ˆå‚æ•°ï¼‰
            if [[ "$model" == *"qwen"* ]]; then
                max_workers=5  # å›ºå®šæ¨¡å¼ï¼šQwenä¿å®ˆ5å¹¶å‘
                qps=10  # å›ºå®šæ¨¡å¼ï¼šä¿å®ˆQPS
                echo -e "${YELLOW}  IdealLabå¼€æºAPIå›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=${qps}${NC}"
            elif [[ "$model" == *"DeepSeek"* ]] || [[ "$model" == *"Llama-3.3"* ]]; then
                # Azureå¼€æºæ¨¡å‹ï¼šå›ºå®šæ¨¡å¼ä½¿ç”¨ä¿å®ˆå‚æ•°
                if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                    max_workers=$((50 * prompt_count))  # å›ºå®šæ¨¡å¼ï¼šæ¯ä¸ªprompt 50 workersï¼ˆä¿å®ˆï¼‰
                    echo -e "${GREEN}  Azureå¼€æºAPIå›ºå®šé€Ÿç‡(${prompt_count}ä¸ªpromptå¹¶å‘): workers=${max_workers}, QPS=100${NC}"
                else
                    max_workers=50  # å›ºå®šæ¨¡å¼ï¼š50å¹¶å‘ï¼ˆä¿å®ˆï¼‰
                    echo -e "${GREEN}  Azureå¼€æºAPIå›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=100${NC}"
                fi
                qps=100  # å›ºå®šæ¨¡å¼è®¾ç½®åˆç†çš„QPSé™åˆ¶
            else
                max_workers=10  # å›ºå®šæ¨¡å¼ï¼šé»˜è®¤10å¹¶å‘
                qps=15  # å›ºå®šæ¨¡å¼ï¼šé»˜è®¤15 QPS
                echo -e "${CYAN}  é»˜è®¤å›ºå®šé€Ÿç‡: workers=${max_workers}, QPS=${qps}${NC}"
            fi
        fi
        adaptive_flag="--no-adaptive --qps $qps"
    else
        # Adaptiveæ¨¡å¼ - æ¿€è¿›å‚æ•°ï¼ŒåŠ¨æ€è°ƒæ•´
        if [ "$MODEL_TYPE" = "closed_source" ]; then
            # é—­æºæ¨¡å‹è‡ªé€‚åº”ï¼ˆæ¿€è¿›å‚æ•°ï¼‰
            case $model in
                "gpt-4o-mini"|"gpt-5-mini"|"grok-3-mini")
                    # Azureé—­æºæ¨¡å‹ï¼šæ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œæ¯ä¸ªpromptä½¿ç”¨100 workers
                    if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                        max_workers=$((100 * prompt_count))  # æ¯ä¸ªprompt 100 workers
                        echo -e "${GREEN}  Azureé—­æºAPIè‡ªé€‚åº”æ¨¡å¼(${prompt_count}ä¸ªpromptå¹¶å‘)ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                    else
                        max_workers=100  # å•prompt 100å¹¶å‘
                        echo -e "${GREEN}  Azureé—­æºAPIè‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                    fi
                    ;;
                "claude_sonnet4"|"o3-0416-global"|"gemini-2.5-flash-06-17"|"kimi-k2")
                    # IdealLabé—­æºæ¨¡å‹ï¼šæœ‰é€Ÿç‡é™åˆ¶ï¼Œæœ€å¤š5 workers
                    if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                        max_workers=$((5 * prompt_count))  # æ¯ä¸ªprompt 5 workers
                        echo -e "${YELLOW}  IdealLabé—­æºAPIè‡ªé€‚åº”æ¨¡å¼(${prompt_count}ä¸ªpromptå¹¶å‘)ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                    else
                        max_workers=5  # å•prompt 5å¹¶å‘
                        echo -e "${YELLOW}  IdealLabé—­æºAPIè‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                    fi
                    ;;
                *)
                    max_workers=20  # è‡ªé€‚åº”ï¼šé»˜è®¤20å¹¶å‘
                    echo -e "${CYAN}  é—­æºæ¨¡å‹é»˜è®¤è‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                    ;;
            esac
        else
            # å¼€æºæ¨¡å‹è‡ªé€‚åº”ï¼ˆæ¿€è¿›å‚æ•°ï¼‰
            if [[ "$model" == *"qwen"* ]]; then
                max_workers=10  # è‡ªé€‚åº”ï¼šQwenå°è¯•10å¹¶å‘ï¼ˆ3ä¸ªAPI keysè½®è¯¢ï¼‰
                echo -e "${YELLOW}  IdealLabå¼€æºAPIè‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
            elif [[ "$model" == *"DeepSeek"* ]] || [[ "$model" == *"Llama-3.3"* ]]; then
                # Azureå¼€æºæ¨¡å‹ï¼šè‡ªé€‚åº”æ¨¡å¼ä½¿ç”¨æ¿€è¿›å‚æ•°
                if [ $prompt_count -gt 1 ] && [ -n "$use_prompt_parallel" ]; then
                    max_workers=$((100 * prompt_count))  # è‡ªé€‚åº”ï¼šæ¯ä¸ªprompt 100 workers
                    echo -e "${GREEN}  Azureå¼€æºAPIè‡ªé€‚åº”æ¨¡å¼(${prompt_count}ä¸ªpromptå¹¶å‘)ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                else
                    max_workers=100  # è‡ªé€‚åº”ï¼š100é«˜å¹¶å‘
                    echo -e "${GREEN}  Azureå¼€æºAPIè‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
                fi
            else
                max_workers=40  # è‡ªé€‚åº”ï¼šé»˜è®¤40å¹¶å‘
                echo -e "${CYAN}  é»˜è®¤è‡ªé€‚åº”æ¨¡å¼ï¼Œåˆå§‹: workers=${max_workers} (åŠ¨æ€è°ƒæ•´)${NC}"
            fi
        fi
    fi
    
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨è¶…é«˜å¹¶è¡Œæ¨¡å¼
    local use_ultra_parallel=false
    if [[ "$ULTRA_PARALLEL_MODE" == "true" ]]; then
        # å¼€æºæ¨¡å‹ä½¿ç”¨å¤šå®ä¾‹/å¤šKeyå¹¶è¡Œ
        if [[ "$model" == *"DeepSeek"* ]] || [[ "$model" == *"Llama-3.3"* ]]; then
            use_ultra_parallel=true
            echo -e "${GREEN}  ğŸ”¥ å¯ç”¨è¶…é«˜å¹¶è¡Œæ¨¡å¼ (å¤šAzureå®ä¾‹å¹¶è¡Œ, é€Ÿç‡æ¨¡å¼: $RATE_MODE)${NC}"
        elif [[ "$model" == *"qwen"* ]]; then
            use_ultra_parallel=true
            echo -e "${GREEN}  ğŸ”¥ å¯ç”¨è¶…é«˜å¹¶è¡Œæ¨¡å¼ (3ä¸ªAPI Keyå¹¶è¡Œ, é€Ÿç‡æ¨¡å¼: $RATE_MODE)${NC}"
        # é—­æºæ¨¡å‹ä¹Ÿä½¿ç”¨ultra_parallel_runnerï¼Œä½†é‡‡ç”¨å•åˆ†ç‰‡é«˜å¹¶å‘ç­–ç•¥
        elif [[ "$model" == "gpt-4o-mini" ]] || [[ "$model" == "gpt-5-mini" ]] || 
             [[ "$model" == "o3-0416-global" ]] || [[ "$model" == "gemini-2.5-flash-06-17" ]] || 
             [[ "$model" == "kimi-k2" ]] || [[ "$model" == "claude_sonnet4" ]]; then
            use_ultra_parallel=true
            echo -e "${CYAN}  âš¡ é—­æºæ¨¡å‹ä½¿ç”¨ç»Ÿä¸€è¶…é«˜å¹¶è¡Œæ¨¡å¼ (å•åˆ†ç‰‡é«˜å¹¶å‘ç­–ç•¥, é€Ÿç‡æ¨¡å¼: $RATE_MODE)${NC}"
        else
            # å…¶ä»–æ¨¡å‹ä½¿ç”¨æ ‡å‡†æ¨¡å¼
            echo -e "${YELLOW}  ğŸ”§ ä½¿ç”¨æ ‡å‡†æ‰¹æµ‹è¯•æ¨¡å¼ (é€Ÿç‡æ¨¡å¼: $RATE_MODE)${NC}"
        fi
    fi
    
    # æ·»åŠ ç»“æœæ–‡ä»¶åç¼€ï¼ˆç”¨äºé—­æºæ¨¡å‹ç‹¬ç«‹ä¿å­˜ï¼‰
    local result_suffix_param=""
    if [ -n "$RESULT_SUFFIX" ]; then
        result_suffix_param="--result-suffix $RESULT_SUFFIX"
    fi
    
    if [ "$use_ultra_parallel" = true ]; then
        # ä½¿ç”¨è¶…é«˜å¹¶è¡Œæ‰§è¡Œå™¨ï¼Œä¼ é€’rate_modeå‚æ•°
        # ç¡®ä¿ç¯å¢ƒå˜é‡ä¼ é€’
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        cmd="python ultra_parallel_runner.py \
            --model $model \
            --prompt-types $prompt_types \
            --difficulty $difficulty \
            --task-types $actual_task_types \
            --num-instances $actual_instances \
            --rate-mode $RATE_MODE \
            --silent \
            $result_suffix_param"
    else
        # ä½¿ç”¨æ ‡å‡†æ™ºèƒ½æ‰¹æµ‹è¯•è¿è¡Œå™¨
        # ç¡®ä¿ç¯å¢ƒå˜é‡ä¼ é€’
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        cmd="python3 smart_batch_runner.py \
            --model $model \
            --prompt-types $prompt_types \
            --difficulty $difficulty \
            --task-types $actual_task_types \
            --num-instances $actual_instances \
            --max-workers $max_workers \
            $adaptive_flag \
            $use_prompt_parallel \
            --batch-commit \
            --checkpoint-interval 20 \
            --ai-classification \
            --silent \
            $result_suffix_param"
    fi
    
    # æ·»åŠ é¢å¤–å‚æ•°ï¼ˆå¦‚å·¥å…·æˆåŠŸç‡ï¼‰
    if [ -n "$extra_args" ]; then
        cmd="$cmd $extra_args"
    fi
    
    echo -e "${CYAN}  æ‰§è¡Œå‘½ä»¤: $cmd${NC}"
    
    # æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¯•
    if [ "$AUTO_RETRY_ENABLED" = "true" ] || [ "$WITH_MAINTENANCE" = "true" ]; then
        echo -e "${GREEN}ğŸ”§ ä½¿ç”¨è‡ªåŠ¨é‡è¯•æ¨¡å¼${NC}"
        if execute_test_with_auto_retry "$cmd" "$description" "$model" "$test_id" 2; then
            exit_code=0
        else
            exit_code=1
        fi
    else
        # ç›´æ¥æ‰§è¡Œå‘½ä»¤
        # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨evalæ‰§è¡Œæ—¶ç”Ÿæ•ˆ
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        export MODEL_TYPE="${MODEL_TYPE}"
        export NUM_INSTANCES="${NUM_INSTANCES}"
        export RATE_MODE="${RATE_MODE}"        eval "$cmd"
        exit_code=$?
    fi  # ç»“æŸè‡ªåŠ¨é‡è¯•æ¨¡å¼æ£€æŸ¥
    
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}âœ“ $model - $description æµ‹è¯•å®Œæˆ${NC}"
        mark_config_completed "$test_id"
        
        # å¦‚æœå¯ç”¨ç»´æŠ¤ï¼Œè®°å½•æˆåŠŸ
        if [ "$WITH_MAINTENANCE" = "true" ] && command -v record_test_success >/dev/null 2>&1; then
            record_test_success "$model" "$test_id" "false"
        fi
        return 0
    else
        echo -e "${RED}âœ— $model - $description æµ‹è¯•å¤±è´¥${NC}"
        
        # å¦‚æœå¯ç”¨ç»´æŠ¤ï¼Œæä¾›é‡è¯•å»ºè®®
        if [ "$WITH_MAINTENANCE" = "true" ]; then
            echo -e "${YELLOW}ğŸ”§ å¤±è´¥è®°å½•å·²ä¿å­˜ï¼Œå¯ä½¿ç”¨è‡ªåŠ¨ç»´æŠ¤åŠŸèƒ½${NC}"
            echo -e "${CYAN}æç¤ºï¼šè¿è¡Œ 'bash $0 --auto-maintain' æˆ–ä½¿ç”¨èœå•é€‰æ‹©ç»´æŠ¤åŠŸèƒ½${NC}"
        else
            echo -e "${YELLOW}æç¤ºï¼šå·²è®°å½•å¤±è´¥ä¿¡æ¯${NC}"
        fi
        return 1
    fi
}

# ============================================
# ä¸»ç¨‹åºå¼€å§‹
# ============================================

# åˆå§‹åŒ–
init_progress
load_progress

# æ˜¾ç¤ºè¿è¡Œæ¨¡å¼
echo ""
echo -e "${CYAN}========================================${NC}"
if [ "$TEST_MODE" = "debug" ]; then
    echo -e "${CYAN}ğŸ” è¿è¡Œæ¨¡å¼: è°ƒè¯•æ¨¡å¼${NC}"
    echo -e "${CYAN}   - æ¯ä¸ªæ¨¡å‹æµ‹è¯•åä¼šæš‚åœ${NC}"
    echo -e "${CYAN}   - æ¯ä¸ªé˜¶æ®µå®Œæˆåéœ€è¦ç¡®è®¤${NC}"
elif [ "$TEST_MODE" = "full_auto" ]; then
    echo -e "${CYAN}ğŸš€ è¿è¡Œæ¨¡å¼: å…¨è‡ªåŠ¨æ¨¡å¼${NC}"
    echo -e "${CYAN}   - è¿ç»­è¿è¡Œæ‰€æœ‰11,400ä¸ªæµ‹è¯•${NC}"
    echo -e "${CYAN}   - ä¸ä¼šåœ¨é˜¶æ®µé—´æš‚åœ${NC}"
    echo -e "${RED}   âš ï¸  è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ—¶é—´å’Œèµ„æº${NC}"
else
    echo -e "${CYAN}âš¡ è¿è¡Œæ¨¡å¼: è‡ªåŠ¨æ¨¡å¼${NC}"
    echo -e "${CYAN}   - é˜¶æ®µå†…è¿ç»­è¿è¡Œ${NC}"
    echo -e "${CYAN}   - é˜¶æ®µé—´éœ€è¦ç¡®è®¤${NC}"
fi
echo -e "${CYAN}========================================${NC}"

# æ˜¾ç¤ºå¹¶å‘ç­–ç•¥
echo ""
echo -e "${CYAN}========================================${NC}"
if [ "$ULTRA_PARALLEL_MODE" = true ]; then
    echo -e "${CYAN}ğŸ”¥ å¹¶å‘ç­–ç•¥: è¶…é«˜å¹¶è¡Œæ¨¡å¼ (Ultra Parallel)${NC}"
    if [ "$RATE_MODE" = "adaptive" ]; then
        echo -e "${CYAN}   - é€Ÿç‡æ¨¡å¼: è‡ªé€‚åº” (Adaptive)${NC}"
        echo -e "${CYAN}   - æ¯ä¸ªåˆ†ç‰‡åŠ¨æ€è°ƒæ•´workers${NC}"
    else
        echo -e "${CYAN}   - é€Ÿç‡æ¨¡å¼: å›ºå®šé€Ÿç‡ (Fixed)${NC}"
        echo -e "${CYAN}   - æ¯ä¸ªåˆ†ç‰‡ä½¿ç”¨é¢„è®¾workers${NC}"
    fi
    echo -e "${CYAN}   - å¤šå®ä¾‹/å¤šKeyå¹¶è¡Œæ‰§è¡Œ${NC}"
    echo -e "${CYAN}   - ç†è®ºåŠ é€Ÿ3-6å€${NC}"
elif [ "$RATE_MODE" = "adaptive" ]; then
    echo -e "${CYAN}ğŸ¯ å¹¶å‘ç­–ç•¥: è‡ªé€‚åº”æ¨¡å¼ (Adaptive)${NC}"
    echo -e "${CYAN}   - æ ¹æ®APIå“åº”åŠ¨æ€è°ƒæ•´${NC}"
    echo -e "${CYAN}   - é‡åˆ°é™æµä¼šè‡ªåŠ¨é™é€Ÿ${NC}"
    echo -e "${CYAN}   - æˆåŠŸè¿è¡Œåé€æ­¥æé€Ÿ${NC}"
elif [ "$RATE_MODE" = "fixed" ]; then
    echo -e "${CYAN}ğŸ”§ å¹¶å‘ç­–ç•¥: å›ºå®šé€Ÿç‡æ¨¡å¼ (Fixed)${NC}"
    echo -e "${CYAN}   - Azure API: 80å¹¶å‘, 150 QPS${NC}"
    echo -e "${CYAN}   - IdealLab API: 3å¹¶å‘, 5 QPS${NC}"
    echo -e "${CYAN}   - å…¶ä»–API: 20å¹¶å‘, 30 QPS${NC}"
else
    echo -e "${CYAN}âš™ï¸  å¹¶å‘ç­–ç•¥: è‡ªå®šä¹‰${NC}"
    echo -e "${CYAN}   - å¹¶å‘æ•°: ${CUSTOM_WORKERS}${NC}"
    echo -e "${CYAN}   - QPS: ${CUSTOM_QPS}${NC}"
fi
echo -e "${CYAN}========================================${NC}"

# æ˜¾ç¤ºæ¢å¤ä¿¡æ¯
if [ "$STEP" -gt 1 ] || [ "$MODEL_INDEX" -gt 0 ]; then
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}æ£€æµ‹åˆ°ä¹‹å‰çš„è¿›åº¦ï¼š${NC}"
    echo "  å½“å‰æ­¥éª¤: 5.$STEP"
    echo "  æ¨¡å‹ç´¢å¼•: $MODEL_INDEX"
    
    if [ -n "$SUBSTEP" ]; then
        echo "  å­æ­¥éª¤: $SUBSTEP"
    fi
    
    # æ˜¾ç¤ºå·²å®Œæˆçš„é…ç½®æ•°
    completed_count=$(wc -l < "$COMPLETED_FILE" 2>/dev/null || echo 0)
    echo "  å·²å®Œæˆé…ç½®: $completed_count"
    
    echo -e "${BLUE}========================================${NC}"
    confirm_continue "ä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­..."
fi

# ============================================
# 5.1 ç¬¬ä¸€æ­¥ï¼šåŸºå‡†æµ‹è¯•
# ============================================
if [ "$STEP" -eq 1 ]; then
    echo ""
    echo "================================================"
    echo "5.1 ç¬¬ä¸€æ­¥ï¼šåŸºå‡†æµ‹è¯•"
    echo "================================================"
    echo "æµ‹è¯•é…ç½®ï¼š"
    echo "- Promptç±»å‹: optimal"
    echo "- éš¾åº¦: easy"
    echo "- ä»»åŠ¡ç±»å‹: å…¨éƒ¨5ç§"
    echo "- æ¯ç§ä»»åŠ¡ç±»å‹: 20ä¸ªå®ä¾‹"
    echo "- æ¨¡å‹æ•°é‡: 8ä¸ªå¼€æºæ¨¡å‹"
    echo "------------------------------------------------"
    
    if [ "$MODEL_INDEX" -eq 0 ]; then
        confirm_continue "å³å°†å¼€å§‹åŸºå‡†æµ‹è¯•ï¼ˆ8ä¸ªæ¨¡å‹Ã—100ä¸ªæµ‹è¯•ï¼‰..."
        
        echo -e "${CYAN}  ğŸš€ å¯åŠ¨æ‰€æœ‰æ¨¡å‹å¹¶å‘åŸºå‡†æµ‹è¯•...${NC}"
        echo -e "${YELLOW}    - æ€»è®¡8ä¸ªæ¨¡å‹åŒæ—¶è¿è¡Œ${NC}"
        echo -e "${YELLOW}    - Azureæ¨¡å‹ï¼šä½¿ç”¨å¤šå®ä¾‹å¹¶è¡Œ${NC}"
        echo -e "${YELLOW}    - IdealLabæ¨¡å‹ï¼šä½¿ç”¨ä¸åŒAPI keys${NC}"
        # å¯åŠ¨æ‰€æœ‰æ¨¡å‹çš„å¹¶è¡Œæµ‹è¯•ï¼ˆç®€å•å»¶è¿Ÿé¿å…å†²çªï¼‰
        pids=()
        for i in "${!CURRENT_MODELS[@]}"; do
            model="${CURRENT_MODELS[$i]}"
            
            echo -e "${CYAN}    ğŸ“‹ å¯åŠ¨ $model åŸºå‡†æµ‹è¯•...${NC}"
            
            # é”™å¼€å¯åŠ¨ï¼Œé¿å…åŒæ—¶å¤§é‡å¯åŠ¨é€ æˆç³»ç»Ÿè¿‡è½½
            if [ $i -gt 0 ]; then
                if [ "$MODEL_TYPE" = "closed_source" ]; then
                    # é—­æºæ¨¡å‹ï¼šè¾ƒçŸ­çš„å»¶è¿Ÿï¼ˆAPIå“åº”æ›´å¿«ï¼‰
                    echo -e "${YELLOW}      â±ï¸  å»¶è¿Ÿ60ç§’ç­‰å¾…å‰ä¸€ä¸ªå®ä¾‹å¯åŠ¨...${NC}"
                    sleep 60
                else
                    # å¼€æºæ¨¡å‹ï¼šåŸæœ‰çš„é•¿å»¶è¿Ÿï¼ˆworkflowç”Ÿæˆéœ€è¦æ›´å¤šæ—¶é—´ï¼‰
                    echo -e "${YELLOW}      â±ï¸  å»¶è¿Ÿ180ç§’ç­‰å¾…å‰ä¸€ä¸ªå®ä¾‹å®Œå…¨ç”Ÿæˆworkflow...${NC}"
                    sleep 180
                fi
            fi
            
            # åå°è¿è¡Œæ¯ä¸ªæ¨¡å‹æµ‹è¯•
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                echo -e "${GREEN}      âœ“ $model å¼€å§‹åŸºå‡†æµ‹è¯•${NC}"
                run_smart_test "$model" "optimal" "easy" "all" "$NUM_INSTANCES" "åŸºå‡†æµ‹è¯•(optimal+easy)" ""
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}      âœ“ $model åŸºå‡†æµ‹è¯•å®Œæˆ${NC}"
                else
                    echo -e "${RED}      âœ— $model åŸºå‡†æµ‹è¯•å¤±è´¥${NC}"
                    exit 1
                fi
            ) &
            pids+=($!)
            
            echo -e "${CYAN}      ğŸš€ $model å·²å¯åŠ¨ (PID: $!)${NC}"
        done
        
        # ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆ
        echo -e "${CYAN}  ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®ŒæˆåŸºå‡†æµ‹è¯•...${NC}"
        failed=0
        for pid in "${pids[@]}"; do
            wait $pid
            if [ $? -ne 0 ]; then
                failed=1
            fi
        done
        
        if [ $failed -eq 1 ]; then
            echo -e "${RED}âœ— åŸºå‡†æµ‹è¯•å¤±è´¥${NC}"
            exit 1
        fi
        
        # æ›´æ–°è¿›åº¦åˆ°ä¸‹ä¸€æ­¥
        update_progress 2 0 ""
        
    else
        # å¦‚æœæœ‰ä¸­æ–­ï¼Œé€ä¸ªæµ‹è¯•å‰©ä½™çš„æ¨¡å‹
        for i in "${!CURRENT_MODELS[@]}"; do
            if [ $i -ge $MODEL_INDEX ]; then
                model="${CURRENT_MODELS[$i]}"
                update_progress 1 $i ""
                
                show_progress_stats "5.1" $i ${#CURRENT_MODELS[@]}
                run_smart_test "$model" "optimal" "easy" "all" "$NUM_INSTANCES" "åŸºå‡†æµ‹è¯•(optimal+easy)" ""
                
                if [ $? -ne 0 ]; then
                    exit 1
                fi
                
                # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
                next_idx=$((i + 1))
                if [ $next_idx -lt ${#CURRENT_MODELS[@]} ]; then
                    update_progress 1 $next_idx ""
                fi
                
                # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
                debug_pause_after_model "$model" "5.1 åŸºå‡†æµ‹è¯•"
            fi
        done
    fi
    
    echo -e "${GREEN}âœ… 5.1 åŸºå‡†æµ‹è¯•å®Œæˆï¼${NC}"
    update_progress 2 0 ""
    confirm_continue "åŸºå‡†æµ‹è¯•å·²å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œ5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•..."
fi

# ============================================
# 5.2 ç¬¬äºŒæ­¥ï¼šQwenç³»åˆ—è§„æ¨¡æ•ˆåº”æµ‹è¯•
# ============================================
if [ "$STEP" -eq 2 ]; then
    if [ "$MODEL_TYPE" = "closed_source" ]; then
        echo ""
        echo "================================================"
        echo "5.2 ç¬¬äºŒæ­¥ï¼šQwenç³»åˆ—è§„æ¨¡æ•ˆåº”æµ‹è¯•ï¼ˆè·³è¿‡ï¼‰"
        echo "================================================"
        echo -e "${YELLOW}âš ï¸  Qwenç³»åˆ—è§„æ¨¡æ•ˆåº”æµ‹è¯•ä¸é€‚ç”¨äºé—­æºæ¨¡å‹${NC}"
        echo -e "${CYAN}è·³è¿‡5.2é˜¶æ®µï¼Œç›´æ¥è¿›å…¥5.3ç¼ºé™·å·¥ä½œæµæµ‹è¯•...${NC}"
        echo ""
        update_progress 3 0 ""
        confirm_continue "è·³è¿‡5.2é˜¶æ®µï¼Œå‡†å¤‡è¿›è¡Œ5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯•..."
    else
        echo ""
        echo "================================================"
        echo "5.2 ç¬¬äºŒæ­¥ï¼šQwenç³»åˆ—è§„æ¨¡æ•ˆåº”æµ‹è¯•"
        echo "================================================"
        echo "æµ‹è¯•é…ç½®ï¼š"
        echo "- Promptç±»å‹: optimal"
        echo "- éš¾åº¦: very_easy å’Œ mediumï¼ˆåˆ†åˆ«æµ‹è¯•ï¼‰"
        echo "- ä»»åŠ¡ç±»å‹: å…¨éƒ¨5ç§"
        echo "- æ¯ç§ä»»åŠ¡ç±»å‹: 20ä¸ªå®ä¾‹"
        echo "- æ¨¡å‹æ•°é‡: 5ä¸ªQwenè§„æ¨¡"
        echo "------------------------------------------------"
    
    if [ "$MODEL_INDEX" -eq 0 ] && [ -z "$SUBSTEP" ]; then
        confirm_continue "å³å°†å¼€å§‹Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•ï¼ˆ5ä¸ªæ¨¡å‹Ã—2ä¸ªéš¾åº¦Ã—100ä¸ªæµ‹è¯•ï¼‰..."
        
        echo -e "${CYAN}  ğŸš€ å¯åŠ¨æ‰€æœ‰Qwenæ¨¡å‹å¹¶å‘è§„æ¨¡æ•ˆåº”æµ‹è¯•...${NC}"
        echo -e "${YELLOW}    - æ€»è®¡5ä¸ªæ¨¡å‹ Ã— 2ä¸ªéš¾åº¦åŒæ—¶è¿è¡Œ${NC}"
        echo -e "${YELLOW}    - IdealLab APIï¼šä½¿ç”¨3ä¸ªä¸åŒAPI keysåˆ†ç»„å¹¶è¡Œ${NC}"
        echo -e "${YELLOW}    - API Key 1: qwen2.5-3b, qwen2.5-14b${NC}"
        echo -e "${YELLOW}    - API Key 2: qwen2.5-7b, qwen2.5-32b${NC}"
        echo -e "${YELLOW}    - API Key 3: qwen2.5-72b${NC}"
        
        # å¯åŠ¨æ‰€æœ‰æµ‹è¯•çš„å¹¶è¡Œè¿è¡Œ
        pids=()
        
        # æµ‹è¯•very_easyéš¾åº¦
        echo -e "${YELLOW}  â–¶ å¯åŠ¨ very_easy éš¾åº¦æµ‹è¯•...${NC}"
        for i in "${!QWEN_FULL_SERIES[@]}"; do
            model="${QWEN_FULL_SERIES[$i]}"
            echo -e "${CYAN}    å¯åŠ¨ $model (very_easy)...${NC}"
            
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                run_smart_test "$model" "optimal" "very_easy" "all" "$NUM_INSTANCES" "Qwenè§„æ¨¡æ•ˆåº”(very_easy)" ""
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}    âœ“ $model (very_easy) å®Œæˆ${NC}"
                else
                    echo -e "${RED}    âœ— $model (very_easy) å¤±è´¥${NC}"
                    exit 1
                fi
            ) &
            pids+=($!)
            
            # æ ¹æ®æ¨¡å‹åˆ†ç»„å»¶è¿Ÿï¼Œé¿å…åŒä¸€API keyå†²çª
            # 3bå’Œ14bç”¨key1, 7bå’Œ32bç”¨key2, 72bç”¨key3
            if [ $i -eq 0 ] || [ $i -eq 2 ]; then
                sleep 3  # ç¬¬1ç»„å’Œç¬¬3ç»„æ¨¡å‹å»¶è¿Ÿ
            elif [ $i -eq 1 ] || [ $i -eq 3 ]; then
                sleep 1  # ç¬¬2ç»„æ¨¡å‹å°å»¶è¿Ÿ
            fi
        done
        
        # æµ‹è¯•mediuméš¾åº¦
        echo -e "${YELLOW}  â–¶ å¯åŠ¨ medium éš¾åº¦æµ‹è¯•...${NC}"
        for i in "${!QWEN_FULL_SERIES[@]}"; do
            model="${QWEN_FULL_SERIES[$i]}"
            echo -e "${CYAN}    å¯åŠ¨ $model (medium)...${NC}"
            
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                run_smart_test "$model" "optimal" "medium" "all" "$NUM_INSTANCES" "Qwenè§„æ¨¡æ•ˆåº”(medium)" ""
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}    âœ“ $model (medium) å®Œæˆ${NC}"
                else
                    echo -e "${RED}    âœ— $model (medium) å¤±è´¥${NC}"
                    exit 1
                fi
            ) &
            pids+=($!)
            
            # å»¶è¿Ÿç­–ç•¥åŒä¸Š
            if [ $i -eq 0 ] || [ $i -eq 2 ]; then
                sleep 3
            elif [ $i -eq 1 ] || [ $i -eq 3 ]; then
                sleep 1
            fi
        done
        
        # ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ
        echo -e "${CYAN}  ç­‰å¾…æ‰€æœ‰Qwenè§„æ¨¡æµ‹è¯•å®Œæˆï¼ˆå…±10ä¸ªä»»åŠ¡ï¼‰...${NC}"
        failed=0
        for pid in "${pids[@]}"; do
            wait $pid
            if [ $? -ne 0 ]; then
                failed=1
            fi
        done
        
        if [ $failed -eq 1 ]; then
            echo -e "${RED}âœ— Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•å¤±è´¥${NC}"
            exit 1
        fi
        
        # æ›´æ–°è¿›åº¦
        update_progress 3 0 ""
        
    else
        # å¦‚æœæœ‰ä¸­æ–­ï¼ŒæŒ‰åŸé€»è¾‘é€ä¸ªæµ‹è¯•
        # æµ‹è¯•very_easyéš¾åº¦
        if [ -z "$SUBSTEP" ] || [ "$SUBSTEP" == "very_easy" ]; then
            echo -e "${YELLOW}â–¶ æµ‹è¯• very_easy éš¾åº¦...${NC}"
            for i in "${!QWEN_FULL_SERIES[@]}"; do
                if [ "$SUBSTEP" == "very_easy" ] && [ $i -lt $MODEL_INDEX ]; then
                    continue
                fi
                model="${QWEN_FULL_SERIES[$i]}"
                update_progress 2 $i "very_easy"
                
                show_progress_stats "5.2-very_easy" $i 5
                run_smart_test "$model" "optimal" "very_easy" "all" "$NUM_INSTANCES" "Qwenè§„æ¨¡æ•ˆåº”(very_easy)" ""
                
                if [ $? -ne 0 ]; then
                    exit 1
                fi
                
                # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
                next_idx=$((i + 1))
                if [ $next_idx -lt ${#QWEN_FULL_SERIES[@]} ]; then
                    update_progress 2 $next_idx "very_easy"
                fi
                
                # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
                debug_pause_after_model "$model" "5.2 Qwenè§„æ¨¡æ•ˆåº”(very_easy)"
            done
            SUBSTEP="medium"
            MODEL_INDEX=0
            update_progress 2 0 "medium"
        fi
        
        # æµ‹è¯•mediuméš¾åº¦
        if [ "$SUBSTEP" == "medium" ]; then
            echo -e "${YELLOW}â–¶ æµ‹è¯• medium éš¾åº¦...${NC}"
            for i in "${!QWEN_FULL_SERIES[@]}"; do
                if [ $i -ge $MODEL_INDEX ]; then
                    model="${QWEN_FULL_SERIES[$i]}"
                    update_progress 2 $i "medium"
                    
                    show_progress_stats "5.2-medium" $i 5
                    run_smart_test "$model" "optimal" "medium" "all" "$NUM_INSTANCES" "Qwenè§„æ¨¡æ•ˆåº”(medium)" ""
                    
                    if [ $? -ne 0 ]; then
                        exit 1
                    fi
                    
                    # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
                    next_idx=$((i + 1))
                    if [ $next_idx -lt ${#QWEN_FULL_SERIES[@]} ]; then
                        update_progress 2 $next_idx "medium"
                    fi
                    
                    # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
                    debug_pause_after_model "$model" "5.2 Qwenè§„æ¨¡æ•ˆåº”(medium)"
                fi
            done
        fi
    fi
    
    echo -e "${GREEN}âœ… 5.2 Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•å®Œæˆï¼${NC}"
    update_progress 3 0 ""
    confirm_continue "Qwenè§„æ¨¡æ•ˆåº”æµ‹è¯•å·²å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œ5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯•..."
    fi
fi

# ============================================
# 5.3 ç¬¬ä¸‰æ­¥ï¼šç¼ºé™·å·¥ä½œæµé€‚åº”æ€§æµ‹è¯•
# ============================================
if [ "$STEP" -eq 3 ]; then
    echo ""
    echo "================================================"
    echo "5.3 ç¬¬ä¸‰æ­¥ï¼šç¼ºé™·å·¥ä½œæµé€‚åº”æ€§æµ‹è¯•"
    echo "================================================"
    echo "æµ‹è¯•é…ç½®ï¼š"
    echo "- Promptç±»å‹: 7ç§ç¼ºé™·ç±»å‹"
    echo "- éš¾åº¦: easy"
    echo "- ä»»åŠ¡ç±»å‹: å…¨éƒ¨5ç§"
    echo "- æ¯ç§ä»»åŠ¡ç±»å‹: 20ä¸ªå®ä¾‹"
    echo "- æ¨¡å‹æ•°é‡: 8ä¸ªå¼€æºæ¨¡å‹"
    echo "------------------------------------------------"
    
    if [ "$MODEL_INDEX" -eq 0 ] && [ -z "$SUBSTEP" ]; then
        confirm_continue "å³å°†å¼€å§‹ç¼ºé™·å·¥ä½œæµæµ‹è¯•ï¼ˆ7ç§ç¼ºé™·Ã—8ä¸ªæ¨¡å‹Ã—100ä¸ªæµ‹è¯•ï¼‰..."
        
        echo -e "${CYAN}  ğŸš€ å¯åŠ¨æ‰€æœ‰æ¨¡å‹å¹¶å‘ç¼ºé™·æµ‹è¯•...${NC}"
        echo -e "${YELLOW}    - æ€»è®¡8ä¸ªæ¨¡å‹åŒæ—¶è¿è¡Œ${NC}"
        echo -e "${YELLOW}    - Azureæ¨¡å‹ï¼šä½¿ç”¨å¤šå®ä¾‹å¹¶è¡Œ${NC}"
        echo -e "${YELLOW}    - IdealLabæ¨¡å‹ï¼šä½¿ç”¨ä¸åŒAPI keys${NC}"
        # å¯åŠ¨æ‰€æœ‰æ¨¡å‹çš„å¹¶è¡Œæµ‹è¯•ï¼ˆç®€å•å»¶è¿Ÿé¿å…å†²çªï¼‰
        pids=()
        for i in "${!CURRENT_MODELS[@]}"; do
            model="${CURRENT_MODELS[$i]}"
            
            echo -e "${CYAN}    ğŸ“‹ å¯åŠ¨ $model ç¼ºé™·æµ‹è¯•...${NC}"
            
            # é”™å¼€å¯åŠ¨ï¼Œé¿å…åŒæ—¶å¤§é‡å¯åŠ¨é€ æˆç³»ç»Ÿè¿‡è½½
            if [ $i -gt 0 ]; then
                if [ "$MODEL_TYPE" = "closed_source" ]; then
                    # é—­æºæ¨¡å‹ï¼šè¾ƒçŸ­çš„å»¶è¿Ÿï¼ˆAPIå“åº”æ›´å¿«ï¼‰
                    echo -e "${YELLOW}      â±ï¸  å»¶è¿Ÿ60ç§’ç­‰å¾…å‰ä¸€ä¸ªå®ä¾‹å¯åŠ¨...${NC}"
                    sleep 60
                else
                    # å¼€æºæ¨¡å‹ï¼šåŸæœ‰çš„é•¿å»¶è¿Ÿï¼ˆworkflowç”Ÿæˆéœ€è¦æ›´å¤šæ—¶é—´ï¼‰
                    echo -e "${YELLOW}      â±ï¸  å»¶è¿Ÿ180ç§’ç­‰å¾…å‰ä¸€ä¸ªå®ä¾‹å®Œå…¨ç”Ÿæˆworkflow...${NC}"
                    sleep 180
                fi
            fi
            
            # åå°è¿è¡Œæ¯ä¸ªæ¨¡å‹çš„æ‰€æœ‰ç¼ºé™·æµ‹è¯•
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                echo -e "${GREEN}      âœ“ $model å¼€å§‹ç¼ºé™·å·¥ä½œæµæµ‹è¯•${NC}"
                
                # å¯¹äºå¹¶å‘æ¨¡å¼ï¼Œç›´æ¥è¿è¡Œæ‰€æœ‰7ç§ç¼ºé™·ç±»å‹ï¼ˆåˆ†3ç»„ï¼‰
                # ç»„1ï¼šåºåˆ—å’Œç»“æ„é—®é¢˜ (3ä¸ª)
                run_smart_test "$model" "flawed_sequence_disorder,flawed_tool_misuse,flawed_parameter_error" \
                    "easy" "all" "$NUM_INSTANCES" "$model-ç¼ºé™·å·¥ä½œæµ(ç»“æ„ç¼ºé™·ç»„)" ""
                if [ $? -ne 0 ]; then
                    echo -e "${RED}      âœ— $model ç»“æ„ç¼ºé™·ç»„æµ‹è¯•å¤±è´¥${NC}"
                    exit 1
                fi
                
                # ç»„2ï¼šæ“ä½œç¼ºé™· (2ä¸ª)
                run_smart_test "$model" "flawed_missing_step,flawed_redundant_operations" \
                    "easy" "all" "$NUM_INSTANCES" "$model-ç¼ºé™·å·¥ä½œæµ(æ“ä½œç¼ºé™·ç»„)" ""
                if [ $? -ne 0 ]; then
                    echo -e "${RED}      âœ— $model æ“ä½œç¼ºé™·ç»„æµ‹è¯•å¤±è´¥${NC}"
                    exit 1
                fi
                
                # ç»„3ï¼šé€»è¾‘ç¼ºé™· (2ä¸ª)
                run_smart_test "$model" "flawed_logical_inconsistency,flawed_semantic_drift" \
                    "easy" "all" "$NUM_INSTANCES" "$model-ç¼ºé™·å·¥ä½œæµ(é€»è¾‘ç¼ºé™·ç»„)" ""
                if [ $? -ne 0 ]; then
                    echo -e "${RED}      âœ— $model é€»è¾‘ç¼ºé™·ç»„æµ‹è¯•å¤±è´¥${NC}"
                    exit 1
                fi
                
                echo -e "${GREEN}      âœ“ $model ç¼ºé™·å·¥ä½œæµæµ‹è¯•å®Œæˆ${NC}"
            ) &
            pids+=($!)
            
            echo -e "${CYAN}      ğŸš€ $model å·²å¯åŠ¨ (PID: $!)${NC}"
        done
        
        # ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆ
        echo -e "${CYAN}  ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆç¼ºé™·å·¥ä½œæµæµ‹è¯•...${NC}"
        failed=0
        for pid in "${pids[@]}"; do
            wait $pid
            if [ $? -ne 0 ]; then
                failed=1
            fi
        done
        
        if [ $failed -eq 1 ]; then
            echo -e "${RED}âœ— ç¼ºé™·å·¥ä½œæµæµ‹è¯•å¤±è´¥${NC}"
            exit 1
        fi
        
        # æ›´æ–°è¿›åº¦åˆ°ä¸‹ä¸€æ­¥
        update_progress 4 0 ""
        
    else
        # å¦‚æœæœ‰ä¸­æ–­ï¼ŒæŒ‰åŸé€»è¾‘é€ä¸ªæµ‹è¯•
        for i in "${!CURRENT_MODELS[@]}"; do
            if [ $i -ge $MODEL_INDEX ]; then
                model="${CURRENT_MODELS[$i]}"
                echo ""
                echo -e "${YELLOW}â–¶ æµ‹è¯•æ¨¡å‹: $model${NC}"
                
                # ç¡®å®šä»å“ªä¸ªç¼ºé™·ç±»å‹å¼€å§‹
                start_flaw=0
                if [ $i -eq $MODEL_INDEX ] && [ -n "$SUBSTEP" ]; then
                    for j in "${!FLAW_TYPES[@]}"; do
                        if [ "${FLAW_TYPES[$j]}" == "$SUBSTEP" ]; then
                            start_flaw=$j
                            break
                        fi
                    done
                fi
                
                # ä¼˜åŒ–ï¼šå¯ä»¥åˆ†ç»„å¹¶è¡Œæµ‹è¯•å¤šä¸ªflaw types
                if [ $start_flaw -eq 0 ]; then
                    # å¦‚æœæ‰€æœ‰flawéƒ½æœªæµ‹è¯•ï¼Œå¯ä»¥åˆ†ç»„å¹¶è¡Œè¿è¡Œ
                    echo -e "${CYAN}  ğŸ“¦ åˆ†ç»„å¹¶è¡Œæµ‹è¯•ç¼ºé™·ç±»å‹${NC}"
                    
                    # åˆ†æˆ3ç»„ï¼šç»“æ„ç¼ºé™·ã€æ“ä½œç¼ºé™·ã€é€»è¾‘ç¼ºé™·
                    # ç»„1ï¼šåºåˆ—å’Œç»“æ„é—®é¢˜ (0-2)
                    echo -e "${CYAN}    ç»„1: ç»“æ„ç¼ºé™·ï¼ˆsequence_disorder, tool_misuse, parameter_errorï¼‰${NC}"
                    total_flaws=$((i * 7 + 1))
                    show_progress_stats "5.3" $total_flaws $((${#CURRENT_MODELS[@]} * 7))
                    run_smart_test "$model" "flawed_sequence_disorder,flawed_tool_misuse,flawed_parameter_error" \
                        "easy" "all" "$NUM_INSTANCES" "ç¼ºé™·å·¥ä½œæµ(ç»“æ„ç¼ºé™·ç»„)" ""
                    if [ $? -ne 0 ]; then exit 1; fi
                    update_progress 3 $i "flawed_parameter_error"
                    
                    # ç»„2ï¼šæ“ä½œç¼ºé™· (3-4)
                    echo -e "${CYAN}    ç»„2: æ“ä½œç¼ºé™·ï¼ˆmissing_step, redundant_operationsï¼‰${NC}"
                    total_flaws=$((i * 7 + 4))
                    show_progress_stats "5.3" $total_flaws $((${#CURRENT_MODELS[@]} * 7))
                    run_smart_test "$model" "flawed_missing_step,flawed_redundant_operations" \
                        "easy" "all" "$NUM_INSTANCES" "ç¼ºé™·å·¥ä½œæµ(æ“ä½œç¼ºé™·ç»„)" ""
                    if [ $? -ne 0 ]; then exit 1; fi
                    update_progress 3 $i "flawed_redundant_operations"
                    
                    # ç»„3ï¼šé€»è¾‘ç¼ºé™· (5-6)
                    echo -e "${CYAN}    ç»„3: é€»è¾‘ç¼ºé™·ï¼ˆlogical_inconsistency, semantic_driftï¼‰${NC}"
                    total_flaws=$((i * 7 + 7))
                    show_progress_stats "5.3" $total_flaws $((${#CURRENT_MODELS[@]} * 7))
                    run_smart_test "$model" "flawed_logical_inconsistency,flawed_semantic_drift" \
                        "easy" "all" "$NUM_INSTANCES" "ç¼ºé™·å·¥ä½œæµ(é€»è¾‘ç¼ºé™·ç»„)" ""
                    if [ $? -ne 0 ]; then exit 1; fi
                    update_progress 3 $i "flawed_semantic_drift"
                    
                else
                    # å¦‚æœæœ‰ä¸­æ–­ï¼Œé€ä¸ªæµ‹è¯•å‰©ä½™çš„flaw
                    for j in "${!FLAW_TYPES[@]}"; do
                        if [ $j -ge $start_flaw ]; then
                            flaw="${FLAW_TYPES[$j]}"
                            update_progress 3 $i "$flaw"
                            
                            total_flaws=$((i * 7 + j + 1))
                            show_progress_stats "5.3" $total_flaws $((${#CURRENT_MODELS[@]} * 7))  # æ¨¡å‹æ•°Ã—7ç¼ºé™·
                            run_smart_test "$model" "$flaw" "easy" "all" "$NUM_INSTANCES" "ç¼ºé™·å·¥ä½œæµ($flaw)" ""
                            
                            if [ $? -ne 0 ]; then
                                exit 1
                            fi
                        fi
                    done
                fi
                start_flaw=0
                
                # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
                next_idx=$((i + 1))
                if [ $next_idx -lt ${#CURRENT_MODELS[@]} ]; then
                    update_progress 3 $next_idx ""
                fi
                
                # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
                debug_pause_after_model "$model" "5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯•"
            fi
        done
    fi
    
    echo -e "${GREEN}âœ… 5.3 ç¼ºé™·å·¥ä½œæµæµ‹è¯•å®Œæˆï¼${NC}"
    update_progress 4 0 ""
    confirm_continue "ç¼ºé™·å·¥ä½œæµæµ‹è¯•å·²å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œ5.4 å·¥å…·å¯é æ€§æµ‹è¯•..."
fi

# ============================================
# 5.4 ç¬¬å››æ­¥ï¼šå·¥å…·å¯é æ€§æ•æ„Ÿæ€§æµ‹è¯•
# ============================================
if [ "$STEP" -eq 4 ]; then
    echo ""
    echo "================================================"
    echo "5.4 ç¬¬å››æ­¥ï¼šå·¥å…·å¯é æ€§æ•æ„Ÿæ€§æµ‹è¯•"
    echo "================================================"
    echo "æµ‹è¯•é…ç½®ï¼š"
    echo "- Promptç±»å‹: optimal"
    echo "- éš¾åº¦: easy"
    echo "- å·¥å…·æˆåŠŸç‡: 90%, 70%, 60%ï¼ˆ80%ä½¿ç”¨5.1çš„ç»“æœï¼‰"
    echo "- ä»»åŠ¡ç±»å‹: å…¨éƒ¨5ç§"
    echo "- æ¯ç§ä»»åŠ¡ç±»å‹: 20ä¸ªå®ä¾‹"
    echo "- æ¨¡å‹æ•°é‡: 8ä¸ªå¼€æºæ¨¡å‹"
    echo "------------------------------------------------"
    
    if [ "$MODEL_INDEX" -eq 0 ] && [ -z "$SUBSTEP" ]; then
        confirm_continue "å³å°†å¼€å§‹å·¥å…·å¯é æ€§æµ‹è¯•ï¼ˆ3ä¸ªæˆåŠŸç‡Ã—8ä¸ªæ¨¡å‹Ã—100ä¸ªæµ‹è¯•ï¼‰..."
        
        echo -e "${CYAN}  ğŸš€ å¯åŠ¨æ‰€æœ‰æ¨¡å‹å¹¶å‘å·¥å…·å¯é æ€§æµ‹è¯•...${NC}"
        echo -e "${YELLOW}    - æ€»è®¡8ä¸ªæ¨¡å‹ Ã— 3ä¸ªæˆåŠŸç‡åŒæ—¶è¿è¡Œ${NC}"
        echo -e "${YELLOW}    - Azureæ¨¡å‹ï¼šä½¿ç”¨å¤šå®ä¾‹å¹¶è¡Œ${NC}"
        echo -e "${YELLOW}    - IdealLabæ¨¡å‹ï¼šä½¿ç”¨ä¸åŒAPI keys${NC}"
        
        # å¯åŠ¨æ‰€æœ‰æ¨¡å‹çš„å¹¶å‘æµ‹è¯•
        pids=()
        for i in "${!CURRENT_MODELS[@]}"; do
            model="${CURRENT_MODELS[$i]}"
            echo -e "${CYAN}    å¯åŠ¨ $model å·¥å…·å¯é æ€§æµ‹è¯•...${NC}"
            
            # åå°è¿è¡Œæ¯ä¸ªæ¨¡å‹çš„å·¥å…·å¯é æ€§æµ‹è¯•
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                echo -e "${GREEN}      âœ“ $model å¼€å§‹å·¥å…·å¯é æ€§æµ‹è¯•${NC}"
                
                # æµ‹è¯•ä¸åŒå·¥å…·æˆåŠŸç‡
                for rel in "${TOOL_RELIABILITIES[@]}"; do
                    run_smart_test "$model" "optimal" "easy" "all" "$NUM_INSTANCES" "$model-å·¥å…·å¯é æ€§(${rel})" "--tool-success-rate $rel"
                    if [ $? -ne 0 ]; then
                        echo -e "${RED}      âœ— $model å·¥å…·æˆåŠŸç‡${rel}æµ‹è¯•å¤±è´¥${NC}"
                        exit 1
                    fi
                done
                
                echo -e "${GREEN}      âœ“ $model å·¥å…·å¯é æ€§æµ‹è¯•å®Œæˆ${NC}"
            ) &
            pids+=($!)
            
            # é”™å¼€å¯åŠ¨å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å¯åŠ¨é€ æˆç³»ç»Ÿè¿‡è½½
            if [ "$MODEL_TYPE" = "closed_source" ]; then
                # é—­æºæ¨¡å‹ï¼šæ ¹æ®APIæä¾›å•†åˆ†ç»„å»¶è¿Ÿ
                case $model in
                    "gpt-4o-mini"|"gpt-5-mini"|"grok-3-mini")
                        sleep 1  # Azureæ¨¡å‹ç»„ï¼šçŸ­å»¶è¿Ÿ
                        ;;
                    "claude_sonnet4"|"o3-0416-global"|"gemini-2.5-flash-06-17")
                        sleep 3  # IdealLabé—­æºæ¨¡å‹ç»„ï¼šé•¿å»¶è¿Ÿï¼ˆAPIé™åˆ¶æ›´ä¸¥ï¼‰
                        ;;
                esac
            else
                # å¼€æºæ¨¡å‹ï¼šåŸæœ‰é€»è¾‘
                if [[ "$model" == *"qwen"* ]]; then
                    sleep 2
                fi
            fi
        done
        
        # ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆ
        echo -e "${CYAN}  ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆå·¥å…·å¯é æ€§æµ‹è¯•...${NC}"
        failed=0
        for pid in "${pids[@]}"; do
            wait $pid
            if [ $? -ne 0 ]; then
                failed=1
            fi
        done
        
        if [ $failed -eq 1 ]; then
            echo -e "${RED}âœ— å·¥å…·å¯é æ€§æµ‹è¯•å¤±è´¥${NC}"
            exit 1
        fi
        
        # æ›´æ–°è¿›åº¦åˆ°ä¸‹ä¸€æ­¥
        update_progress 5 0 ""
        
    else
        # å¦‚æœæœ‰ä¸­æ–­ï¼ŒæŒ‰åŸé€»è¾‘é€ä¸ªæµ‹è¯•
        for i in "${!CURRENT_MODELS[@]}"; do
            if [ $i -ge $MODEL_INDEX ]; then
                model="${CURRENT_MODELS[$i]}"
                echo ""
                echo -e "${YELLOW}â–¶ æµ‹è¯•æ¨¡å‹: $model${NC}"
            
            # ç¡®å®šä»å“ªä¸ªå¯é æ€§å¼€å§‹
            start_rel=0
            if [ $i -eq $MODEL_INDEX ] && [ -n "$SUBSTEP" ]; then
                for j in "${!TOOL_RELIABILITIES[@]}"; do
                    if [ "${TOOL_RELIABILITIES[$j]}" == "$SUBSTEP" ]; then
                        start_rel=$j
                        break
                    fi
                done
            fi
            
            # ä¼˜åŒ–ï¼šå¯ä»¥å¹¶è¡Œæµ‹è¯•3ä¸ªå·¥å…·æˆåŠŸç‡
            if [ $start_rel -eq 0 ]; then
                # å¦‚æœæ‰€æœ‰æˆåŠŸç‡éƒ½æœªæµ‹è¯•ï¼Œå¯ä»¥å¹¶è¡Œè¿è¡Œ
                echo -e "${CYAN}  ğŸ“¦ å¹¶è¡Œæµ‹è¯•3ä¸ªå·¥å…·æˆåŠŸç‡ï¼ˆ0.9, 0.7, 0.6ï¼‰${NC}"
                
                # æ„å»ºå·¥å…·æˆåŠŸç‡å‚æ•°åˆ—è¡¨
                tool_rates=""
                for rel in "${TOOL_RELIABILITIES[@]}"; do
                    if [ -n "$tool_rates" ]; then
                        tool_rates="${tool_rates},${rel}"
                    else
                        tool_rates="${rel}"
                    fi
                done
                
                total_rels=$((i * 3 + 3))
                show_progress_stats "5.4" $total_rels $((${#CURRENT_MODELS[@]} * 3))
                
                # ä½¿ç”¨ç‰¹æ®Šçš„æ‰¹é‡å·¥å…·æˆåŠŸç‡æµ‹è¯•
                echo -e "${CYAN}    å¹¶è¡Œæµ‹è¯•å·¥å…·æˆåŠŸç‡: $tool_rates${NC}"
                
                # åˆ†åˆ«è¿è¡Œ3ä¸ªæˆåŠŸç‡æµ‹è¯•ï¼ˆç”±äºtool-success-rateå‚æ•°çš„ç‰¹æ®Šæ€§ï¼Œéœ€è¦åˆ†å¼€è¿è¡Œä½†å¯ä»¥åå°å¹¶è¡Œï¼‰
                pids=()
                for rel in "${TOOL_RELIABILITIES[@]}"; do
                    echo -e "${YELLOW}    å¯åŠ¨å·¥å…·æˆåŠŸç‡ $rel æµ‹è¯•...${NC}"
                    # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­ç”Ÿæ•ˆ
        export STORAGE_FORMAT="${STORAGE_FORMAT}"
        python3 smart_batch_runner.py \
                        --model "$model" \
                        --prompt-types optimal \
                        --difficulty easy \
                        --task-types all \
                        --num-instances $NUM_INSTANCES \
                        --tool-success-rate "$rel" \
                        --max-workers 10 \
                        --adaptive \
                        --batch-commit \
                        --checkpoint-interval 20 \
                        --ai-classification &
                    pids+=($!)
                done
                
                # ç­‰å¾…æ‰€æœ‰å¹¶è¡Œä»»åŠ¡å®Œæˆ
                echo -e "${CYAN}    ç­‰å¾…3ä¸ªå¹¶è¡Œä»»åŠ¡å®Œæˆ...${NC}"
                for pid in "${pids[@]}"; do
                    wait $pid
                    if [ $? -ne 0 ]; then
                        echo -e "${RED}âœ— å·¥å…·æˆåŠŸç‡æµ‹è¯•å¤±è´¥${NC}"
                        exit 1
                    fi
                done
                
                echo -e "${GREEN}    âœ“ 3ä¸ªå·¥å…·æˆåŠŸç‡æµ‹è¯•å…¨éƒ¨å®Œæˆ${NC}"
                update_progress 4 $i "0.6"
                
            else
                # å¦‚æœæœ‰ä¸­æ–­ï¼Œé€ä¸ªæµ‹è¯•å‰©ä½™çš„æˆåŠŸç‡
                for j in "${!TOOL_RELIABILITIES[@]}"; do
                    if [ $j -ge $start_rel ]; then
                        reliability="${TOOL_RELIABILITIES[$j]}"
                        update_progress 4 $i "$reliability"
                        
                        total_rels=$((i * 3 + j + 1))
                        show_progress_stats "5.4" $total_rels $((${#CURRENT_MODELS[@]} * 3))  # æ¨¡å‹æ•°Ã—3æˆåŠŸç‡
                        
                        # ä¸ºå·¥å…·å¯é æ€§æµ‹è¯•æ·»åŠ ç‰¹æ®Šçš„test_id
                        test_id="${model}_optimal_easy_tool${reliability}"
                        
                        if is_config_completed "$test_id"; then
                            echo -e "${BLUE}âŠ™ $model (å·¥å…·æˆåŠŸç‡=$reliability) å·²å®Œæˆï¼Œè·³è¿‡${NC}"
                            continue
                        fi
                        
                        echo -e "${CYAN}  å·¥å…·æˆåŠŸç‡: ${reliability}${NC}"
                        run_smart_test "$model" "optimal" "easy" "all" "$NUM_INSTANCES" \
                            "å·¥å…·å¯é æ€§(${reliability})" "--tool-success-rate $reliability"
                        
                        if [ $? -eq 0 ]; then
                            mark_config_completed "$test_id"
                        else
                            exit 1
                        fi
                    fi
                done
            fi
            start_rel=0
            
            # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
            next_idx=$((i + 1))
            if [ $next_idx -lt ${#CURRENT_MODELS[@]} ]; then
                update_progress 4 $next_idx ""
            fi
            
                # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
                debug_pause_after_model "$model" "5.4 å·¥å…·å¯é æ€§æµ‹è¯•"
            fi
        done
    fi
    
    echo -e "${GREEN}âœ… 5.4 å·¥å…·å¯é æ€§æµ‹è¯•å®Œæˆï¼${NC}"
    update_progress 5 0 ""
    confirm_continue "å·¥å…·å¯é æ€§æµ‹è¯•å·²å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œ5.5 æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•..."
fi

# ============================================
# 5.5 ç¬¬äº”æ­¥ï¼šæç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•
# ============================================
if [ "$STEP" -eq 5 ]; then
    echo ""
    echo "================================================"
    echo "5.5 ç¬¬äº”æ­¥ï¼šæç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•"
    echo "================================================"
    echo "æµ‹è¯•é…ç½®ï¼š"
    echo "- Promptç±»å‹: baseline, cotï¼ˆoptimalä½¿ç”¨5.1çš„ç»“æœï¼‰"
    echo "- éš¾åº¦: easy"
    echo "- ä»»åŠ¡ç±»å‹: å…¨éƒ¨5ç§"
    echo "- æ¯ç§ä»»åŠ¡ç±»å‹: 20ä¸ªå®ä¾‹"
    echo "- æ¨¡å‹æ•°é‡: 8ä¸ªå¼€æºæ¨¡å‹"
    echo "------------------------------------------------"
    
    if [ "$MODEL_INDEX" -eq 0 ] && [ -z "$SUBSTEP" ]; then
        confirm_continue "å³å°†å¼€å§‹æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•ï¼ˆ2ç§æç¤ºÃ—8ä¸ªæ¨¡å‹Ã—100ä¸ªæµ‹è¯•ï¼‰..."
        
        echo -e "${CYAN}  ğŸš€ å¯åŠ¨æ‰€æœ‰æ¨¡å‹å¹¶å‘æç¤ºæ•æ„Ÿæ€§æµ‹è¯•...${NC}"
        echo -e "${YELLOW}    - æ€»è®¡8ä¸ªæ¨¡å‹ Ã— 2ç§æç¤ºç±»å‹åŒæ—¶è¿è¡Œ${NC}"
        echo -e "${YELLOW}    - Azureæ¨¡å‹ï¼šä½¿ç”¨å¤šå®ä¾‹å¹¶è¡Œ${NC}"
        echo -e "${YELLOW}    - IdealLabæ¨¡å‹ï¼šä½¿ç”¨ä¸åŒAPI keys${NC}"
        
        # å¯åŠ¨æ‰€æœ‰æ¨¡å‹çš„å¹¶å‘æµ‹è¯•
        pids=()
        for i in "${!CURRENT_MODELS[@]}"; do
            model="${CURRENT_MODELS[$i]}"
            echo -e "${CYAN}    å¯åŠ¨ $model æç¤ºæ•æ„Ÿæ€§æµ‹è¯•...${NC}"
            
            # åå°è¿è¡Œæ¯ä¸ªæ¨¡å‹çš„æç¤ºæ•æ„Ÿæ€§æµ‹è¯•
            (
                # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨å­è¿›ç¨‹ä¸­å¯ç”¨
                export STORAGE_FORMAT="${STORAGE_FORMAT}"
                export MODEL_TYPE="${MODEL_TYPE}"
                export NUM_INSTANCES="${NUM_INSTANCES}"
                export RATE_MODE="${RATE_MODE}"
                
                echo -e "${GREEN}      âœ“ $model å¼€å§‹æç¤ºæ•æ„Ÿæ€§æµ‹è¯•${NC}"
                
                # æµ‹è¯•baselineå’Œcotä¸¤ç§æç¤ºç±»å‹
                run_smart_test "$model" "baseline,cot" "easy" "all" "$NUM_INSTANCES" "$model-æç¤ºæ•æ„Ÿæ€§(baseline+cot)" ""
                if [ $? -ne 0 ]; then
                    echo -e "${RED}      âœ— $model æç¤ºæ•æ„Ÿæ€§æµ‹è¯•å¤±è´¥${NC}"
                    exit 1
                fi
                
                echo -e "${GREEN}      âœ“ $model æç¤ºæ•æ„Ÿæ€§æµ‹è¯•å®Œæˆ${NC}"
            ) &
            pids+=($!)
            
            # é”™å¼€å¯åŠ¨å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å¯åŠ¨é€ æˆç³»ç»Ÿè¿‡è½½
            if [ "$MODEL_TYPE" = "closed_source" ]; then
                # é—­æºæ¨¡å‹ï¼šæ ¹æ®APIæä¾›å•†åˆ†ç»„å»¶è¿Ÿ
                case $model in
                    "gpt-4o-mini"|"gpt-5-mini"|"grok-3-mini")
                        sleep 1  # Azureæ¨¡å‹ç»„ï¼šçŸ­å»¶è¿Ÿ
                        ;;
                    "claude_sonnet4"|"o3-0416-global"|"gemini-2.5-flash-06-17")
                        sleep 3  # IdealLabé—­æºæ¨¡å‹ç»„ï¼šé•¿å»¶è¿Ÿï¼ˆAPIé™åˆ¶æ›´ä¸¥ï¼‰
                        ;;
                esac
            else
                # å¼€æºæ¨¡å‹ï¼šåŸæœ‰é€»è¾‘
                if [[ "$model" == *"qwen"* ]]; then
                    sleep 2
                fi
            fi
        done
        
        # ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆ
        echo -e "${CYAN}  ç­‰å¾…æ‰€æœ‰æ¨¡å‹å®Œæˆæç¤ºæ•æ„Ÿæ€§æµ‹è¯•...${NC}"
        failed=0
        for pid in "${pids[@]}"; do
            wait $pid
            if [ $? -ne 0 ]; then
                failed=1
            fi
        done
        
        if [ $failed -eq 1 ]; then
            echo -e "${RED}âœ— æç¤ºæ•æ„Ÿæ€§æµ‹è¯•å¤±è´¥${NC}"
            exit 1
        fi
        
        # æ›´æ–°è¿›åº¦åˆ°ä¸‹ä¸€æ­¥
        update_progress 6 0 ""
        
    else
        # å¦‚æœæœ‰ä¸­æ–­ï¼ŒæŒ‰åŸé€»è¾‘é€ä¸ªæµ‹è¯•
        for i in "${!CURRENT_MODELS[@]}"; do
            if [ $i -ge $MODEL_INDEX ]; then
                model="${CURRENT_MODELS[$i]}"
                echo ""
                echo -e "${YELLOW}â–¶ æµ‹è¯•æ¨¡å‹: $model${NC}"
            
            # ç¡®å®šä»å“ªä¸ªæç¤ºç±»å‹å¼€å§‹
            start_prompt=0
            if [ $i -eq $MODEL_INDEX ] && [ -n "$SUBSTEP" ]; then
                for j in "${!PROMPT_TYPES[@]}"; do
                    if [ "${PROMPT_TYPES[$j]}" == "$SUBSTEP" ]; then
                        start_prompt=$j
                        break
                    fi
                done
            fi
            
            # ä¼˜åŒ–ï¼šå¯ä»¥åŒæ—¶æµ‹è¯•ä¸¤ä¸ªprompt types
            if [ $start_prompt -eq 0 ]; then
                # å¦‚æœä¸¤ä¸ªpromptéƒ½æœªæµ‹è¯•ï¼Œå¯ä»¥å¹¶è¡Œè¿è¡Œ
                echo -e "${CYAN}  ğŸ“¦ å¹¶è¡Œæµ‹è¯•baselineå’Œcot${NC}"
                total_prompts=$((i * 2 + 1))
                show_progress_stats "5.5" $total_prompts $((${#CURRENT_MODELS[@]} * 2))  # æ¨¡å‹æ•°Ã—2æç¤º
                
                # ä½¿ç”¨é€—å·åˆ†éš”çš„promptåˆ—è¡¨æ¥å¹¶è¡Œæµ‹è¯•
                run_smart_test "$model" "baseline,cot" "easy" "all" "$NUM_INSTANCES" "æç¤ºç±»å‹(baseline+cotå¹¶è¡Œ)" ""
                
                if [ $? -ne 0 ]; then
                    exit 1
                fi
                
                # æ›´æ–°è¿›åº¦ï¼Œæ ‡è®°ä¸¤ä¸ªpromptéƒ½å®Œæˆ
                update_progress 5 $i "cot"
            else
                # å¦‚æœæœ‰ä¸­æ–­ï¼Œé€ä¸ªæµ‹è¯•å‰©ä½™çš„prompt
                for j in "${!PROMPT_TYPES[@]}"; do
                    if [ $j -ge $start_prompt ]; then
                        prompt="${PROMPT_TYPES[$j]}"
                        update_progress 5 $i "$prompt"
                        
                        total_prompts=$((i * 2 + j + 1))
                        show_progress_stats "5.5" $total_prompts $((${#CURRENT_MODELS[@]} * 2))  # æ¨¡å‹æ•°Ã—2æç¤º
                        run_smart_test "$model" "$prompt" "easy" "all" "$NUM_INSTANCES" "æç¤ºç±»å‹($prompt)" ""
                        
                        if [ $? -ne 0 ]; then
                            exit 1
                        fi
                    fi
                done
            fi
            start_prompt=0
            
            # æ¨¡å‹å®Œæˆåï¼Œæ›´æ–°åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ç´¢å¼•
            next_idx=$((i + 1))
            if [ $next_idx -lt ${#CURRENT_MODELS[@]} ]; then
                update_progress 5 $next_idx ""
            fi
            
            # è°ƒè¯•æ¨¡å¼ä¸‹åœ¨æ¯ä¸ªæ¨¡å‹åæš‚åœ
            debug_pause_after_model "$model" "5.5 æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•"
            fi
        done
    fi
    
    echo -e "${GREEN}âœ… 5.5 æç¤ºç±»å‹æ•æ„Ÿæ€§æµ‹è¯•å®Œæˆï¼${NC}"
    update_progress 6 0 ""
fi

# ============================================
# æµ‹è¯•å®Œæˆæ€»ç»“
# ============================================
echo ""
echo "=========================================="
echo -e "${GREEN}ğŸ‰ æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼${NC}"
echo "=========================================="
echo ""
echo "ğŸ“Š æµ‹è¯•æ€»ç»“ï¼š"
echo "-------------------------------------------"
echo "  5.1 åŸºå‡†æµ‹è¯•:      8ä¸ªæ¨¡å‹ Ã— 100ä¸ªæµ‹è¯• = 800ä¸ªæµ‹è¯•"
echo "  5.2 Qwenè§„æ¨¡æ•ˆåº”:  5ä¸ªæ¨¡å‹ Ã— 2ä¸ªéš¾åº¦ Ã— 100ä¸ªæµ‹è¯• = 1,000ä¸ªæµ‹è¯•"
echo "  5.3 ç¼ºé™·å·¥ä½œæµ:    8ä¸ªæ¨¡å‹ Ã— 7ç§ç¼ºé™· Ã— 100ä¸ªæµ‹è¯• = 5,600ä¸ªæµ‹è¯•"
echo "  5.4 å·¥å…·å¯é æ€§:    8ä¸ªæ¨¡å‹ Ã— 3ä¸ªæˆåŠŸç‡ Ã— 100ä¸ªæµ‹è¯• = 2,400ä¸ªæµ‹è¯•"
echo "  5.5 æç¤ºç±»å‹:      8ä¸ªæ¨¡å‹ Ã— 2ç§æç¤º Ã— 100ä¸ªæµ‹è¯• = 1,600ä¸ªæµ‹è¯•"
echo "-------------------------------------------"
echo "  æ€»è®¡: 11,400ä¸ªæµ‹è¯•"
echo ""

# æ¢å¤è¢«å¿½ç•¥çš„è¿›åº¦æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
if [ -f "${PROGRESS_FILE}.ignored" ]; then
    echo -e "${CYAN}æ¢å¤è¢«å¿½ç•¥çš„è¿›åº¦æ–‡ä»¶...${NC}"
    mv "${PROGRESS_FILE}.ignored" "$PROGRESS_FILE"
    if [ -f "${COMPLETED_FILE}.ignored" ]; then
        mv "${COMPLETED_FILE}.ignored" "$COMPLETED_FILE"
    fi
    echo -e "${GREEN}âœ“ è¿›åº¦æ–‡ä»¶å·²æ¢å¤${NC}"
fi

# æ¸…ç†è¿›åº¦æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰- ä»…åœ¨äº¤äº’æ¨¡å¼ä¸‹è¯¢é—®
if [ "$SKIP_MENU" = false ]; then
    echo -e "${YELLOW}æ˜¯å¦æ¸…ç†è¿›åº¦æ–‡ä»¶ï¼Ÿ(y/n)${NC}"
    read -r cleanup
    if [ "$cleanup" == "y" ] || [ "$cleanup" == "Y" ]; then
        echo "æ¸…ç†è¿›åº¦æ–‡ä»¶..."
        rm -f "$PROGRESS_FILE"
        rm -f "$COMPLETED_FILE"
        echo -e "${GREEN}âœ“ è¿›åº¦æ–‡ä»¶å·²æ¸…ç†${NC}"
    else
        echo "ä¿ç•™è¿›åº¦æ–‡ä»¶ï¼ˆå¯ç”¨äºæŸ¥çœ‹æµ‹è¯•å†å²ï¼‰"
    fi
elif [ "$INCREMENTAL_MODE" = true ]; then
    echo -e "${CYAN}å¢é‡æµ‹è¯•æ¨¡å¼ï¼šä¿ç•™è¿›åº¦æ–‡ä»¶ä¾›ä¸‹æ¬¡ä½¿ç”¨${NC}"
else
    echo "ä¿ç•™è¿›åº¦æ–‡ä»¶ï¼ˆå¯ç”¨äºæŸ¥çœ‹æµ‹è¯•å†å²ï¼‰"
fi

echo ""
echo "ğŸ“ˆ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
echo "1. æŸ¥çœ‹æµ‹è¯•ç»Ÿè®¡ï¼š"
echo "   python view_test_statistics.py"
echo ""
echo "2. ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼š"
echo "   python generate_report.py --input-dir pilot_bench_cumulative_results"
echo ""
echo "3. æ£€æŸ¥ç‰¹å®šé…ç½®çš„å®Œæˆæƒ…å†µï¼š"
echo "   python check_completed_tests.py <model> <prompt_type> <difficulty>"
echo ""

# ============================================
# è‡ªåŠ¨ç»´æŠ¤æ£€æŸ¥ï¼ˆæµ‹è¯•å®Œæˆåï¼‰
# ============================================

if [ "$WITH_MAINTENANCE" = "true" ] && [ "$MAINTENANCE_LIB_LOADED" = "true" ]; then
    echo -e "${CYAN}ğŸ”§ æ‰§è¡Œæµ‹è¯•å®Œæˆåç»´æŠ¤æ£€æŸ¥...${NC}"
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æµ‹è¯•
    if command -v check_incomplete_tests >/dev/null 2>&1; then
        if check_incomplete_tests ""; then
            echo -e "${YELLOW}âš ï¸  å‘ç°æœªå®Œæˆçš„æµ‹è¯•${NC}"
            echo ""
            echo -e "${YELLOW}æ˜¯å¦ç«‹å³æ‰§è¡Œè‡ªåŠ¨é‡æµ‹ï¼Ÿ (y/n): ${NC}"
            read -r auto_retest_choice
            
            if [ "$auto_retest_choice" = "y" ] || [ "$auto_retest_choice" = "Y" ]; then
                echo -e "${CYAN}ğŸ”„ æ‰§è¡Œè‡ªåŠ¨é‡æµ‹...${NC}"
                if command -v run_incremental_retest >/dev/null 2>&1; then
                    run_incremental_retest "" "0.8" "false"
                else
                    python3 smart_batch_runner.py --incremental-retest --completion-threshold 0.8
                fi
            else
                echo -e "${BLUE}ğŸ’¡ æ‚¨å¯ä»¥ç¨åè¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç»´æŠ¤:${NC}"
                echo "  bash $0 --auto-maintain"
                echo "  æˆ–"
                echo "  python3 smart_batch_runner.py --auto-maintain"
            fi
        else
            echo -e "${GREEN}âœ… æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼Œæ— éœ€é¢å¤–ç»´æŠ¤${NC}"
        fi
    fi
    
    # æ˜¾ç¤ºç»´æŠ¤æ€»ç»“
    echo ""
    echo -e "${CYAN}ğŸ”§ ç»´æŠ¤æ€»ç»“:${NC}"
    if command -v show_progress_summary >/dev/null 2>&1; then
        show_progress_summary
    fi
    
    echo ""
fi

echo -e "${GREEN}æ„Ÿè°¢ä½¿ç”¨PILOT-Benchç³»ç»ŸåŒ–æµ‹è¯•å·¥å…·ï¼${NC}"